@model Schedule
@using PicklePlay.Models

@{
    // --- THIS BLOCK IS REQUIRED ---
    var currentUserId = Context.Session.GetInt32("UserId");
    var p = Model.Participants.FirstOrDefault(p => p.UserId == currentUserId && p.Role == ParticipantRole.Player);
    
    var statusText = "";
    var statusClass = "";

    if (p != null)
    {
        switch (p.Status)
        {
            case ParticipantStatus.Confirmed:
                statusText = "Confirmed";
                statusClass = "status-confirmed";
                break;
            case ParticipantStatus.PendingPayment:
                statusText = "Pending";
                statusClass = "status-pending";
                break;
            case ParticipantStatus.OnHold:
                statusText = "On Hold";
                statusClass = "status-onhold";
                break;
            case ParticipantStatus.Cancelled:
                statusText = "Quit";
                statusClass = "status-cancelled";
                break;
        }
    }
    
    // --- THIS IS THE MISSING LOGIC ---
    var endorsedGameIds = (ViewBag.EndorsedGameIds as List<int>) ?? new List<int>();
    bool hasEndorsed = endorsedGameIds.Contains(Model.ScheduleId);
    // --- END OF MISSING LOGIC ---
    
    var confirmedCount = 0;
    if (Model.Participants != null)
    {
        confirmedCount = Model.Participants.Count(pt => pt.Role == ParticipantRole.Player && pt.Status == ParticipantStatus.Confirmed);
    }
}

<div class="card mb-3 shadow-sm game-card" style="position: relative; overflow: hidden;">
    
    @if (!string.IsNullOrEmpty(statusText))
    {
        <div class="status-badge @statusClass">@statusText</div>
    }

    <div class="card-body d-flex flex-column">
        
        <div style="cursor:pointer;" onclick="location.href='@Url.Action("Details", "Schedule", new { id = Model.ScheduleId })'">
            <h5 class="card-title">@Model.GameName</h5>
            @if(Model.EventTag.HasValue && Model.EventTag != EventTag.None) {
                <span class="badge bg-primary mb-2 align-self-start">@Model.EventTag.ToString()</span>
            }
            <p class="card-text mb-1 small"><i class="bi bi-geo-alt-fill me-1"></i> @Model.Location</p>
            <p class="card-text mb-1 small">
                <i class="bi bi-calendar-event me-1"></i>
                @if (Model.StartTime.HasValue) {
                    if(Model.ScheduleType == ScheduleType.Recurring) {
                         <span>Every @Model.RecurringWeek?.ToString(), @Model.StartTime.Value.ToString("t")</span>
                    } else {
                        <span>@Model.StartTime.Value.ToString("ddd, MMM d, H:mm")</span>
                    }
                }
            </p>
            <p class="card-text small">
                <i class="bi bi-people-fill me-1"></i>
                @if (Model.NumPlayer.HasValue && Model.NumPlayer > 0)
                {
                    <span class="ms-1">@confirmedCount / @Model.NumPlayer</span>
                }
                else
                {
                    <span class="ms-1">@confirmedCount Players</span>
                }
            </p>
        </div>
        
        <div class="mt-auto pt-2">
            @{
                // ⬇️ NEW: Check 48-Hour Window
                bool isWithin48Hours = Model.EndTime.HasValue && DateTime.Now <= Model.EndTime.Value.AddHours(48);
                bool isEndorsementOpen = (Model.EndorsementStatus == EndorsementStatus.PendingEndorsement || 
                                         (Model.Status == ScheduleStatus.Past && Model.EndorsementStatus != EndorsementStatus.Closed));
            }

            @* Show button ONLY if status allows AND it's within 48 hours *@
            @if (isEndorsementOpen && isWithin48Hours)
            {
                <a asp-action="Give" asp-controller="Endorsement" asp-route-id="@Model.ScheduleId" class="btn btn-sm btn-warning w-100 mb-1">
                    <i class="bi bi-award-fill"></i> @(hasEndorsed ? "Give/Edit Endorsements" : "Give Endorsements")
                </a>
            }
            else if (isEndorsementOpen && !isWithin48Hours)
            {
                // Optional: Show a disabled button or message saying "Closed"
                <button class="btn btn-sm btn-secondary w-100 mb-1" disabled>
                    <i class="bi bi-clock-history"></i> Endorsement Closed
                </button>
            }

            @if (hasEndorsed)
            {
                <a asp-action="View" asp-controller="Endorsement" asp-route-id="@Model.ScheduleId" class="btn btn-sm btn-outline-secondary w-100">
                    <i class="bi bi-eye-fill"></i> View Endorsements
                </a>
            }

            @* Show View Details logic remains the same *@
            @if (Model.Status == ScheduleStatus.Active || Model.EndorsementStatus == EndorsementStatus.InProgress || Model.EndorsementStatus == EndorsementStatus.Closed)
            {
                <a asp-controller="Schedule" asp-action="Details" asp-route-id="@Model.ScheduleId" class="btn btn-sm btn-outline-primary w-100">View Details</a>
            }
       
        </div>
    </div>
</div>