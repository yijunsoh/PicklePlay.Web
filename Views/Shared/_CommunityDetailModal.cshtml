@* Reusable Community Detail Modal *@
@{
    var context = (ViewData["ModalContext"] as string ?? "search").ToLowerInvariant();
    var modalId = "communityDetailModal";
}

<div class="modal fade" id="@modalId" tabindex="-1" aria-labelledby="communityDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="communityDetailModalLabel">
                    <i class="fas fa-users me-2"></i>
                    <span id="modalCommunityName">Community Details</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Community Image -->
                    <div class="col-md-4 text-center mb-4">
                        <div id="modalCommunityImage" class="community-icon mx-auto" style="width: 120px; height: 120px;">
                            <i class="fas fa-users" style="font-size: 3rem;"></i>
                        </div>
                    </div>
                    
                    <!-- Community Details -->
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Community Type:</label>
                            <span id="modalCommunityType" class="badge bg-success ms-2"></span>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Description:</label>
                            <p id="modalCommunityDescription" class="text-muted"></p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Location:</label>
                            <p id="modalCommunityLocation" class="text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                <span>Loading...</span>
                            </p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Created By:</label>
                            <p id="modalCommunityCreator" class="text-muted">
                                <i class="fas fa-user me-1"></i>
                                <span>Loading...</span>
                            </p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Created Date:</label>
                            <p id="modalCommunityCreatedDate" class="text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                <span>Loading...</span>
                            </p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Members:</label>
                            <p id="modalCommunityMembers" class="text-muted">
                                <i class="fas fa-users me-1"></i>
                                <span>Loading...</span>
                            </p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Last Activity:</label>
                            <p id="modalCommunityLastActivity" class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                <span>Loading...</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="modalJoinCommunityBtn">
                    <i class="fas fa-plus me-1"></i>
                    <span>Join Community</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Community Modal Manager
    const CommunityModalManager = {
        currentCommunityId: null,
        currentCommunityType: null,
        modal: null,
        
        init() {
            // Initialize Bootstrap modal
            const modalElement = document.getElementById('@modalId');
            this.modal = new bootstrap.Modal(modalElement);
            
            // Handle join community button in modal
            document.getElementById('modalJoinCommunityBtn').addEventListener('click', () => {
                if (this.currentCommunityId) {
                    this.joinCommunityFromModal(this.currentCommunityId, this.currentCommunityType);
                }
            });

            // Clean up when modal is hidden
            modalElement.addEventListener('hidden.bs.modal', () => {
                this.currentCommunityId = null;
                this.currentCommunityType = null;
                this.resetModalContent();
            });
        },
        
        resetModalContent() {
            document.getElementById('modalCommunityName').textContent = 'Community Details';
            document.getElementById('modalCommunityDescription').textContent = 'Loading...';
            document.getElementById('modalCommunityLocation').innerHTML = '<i class="fas fa-map-marker-alt me-1"></i>Loading...';
            document.getElementById('modalCommunityCreator').innerHTML = '<i class="fas fa-user me-1"></i>Loading...';
            document.getElementById('modalCommunityCreatedDate').innerHTML = '<i class="fas fa-calendar me-1"></i>Loading...';
            document.getElementById('modalCommunityMembers').innerHTML = '<i class="fas fa-users me-1"></i>Loading...';
            document.getElementById('modalCommunityLastActivity').innerHTML = '<i class="fas fa-clock me-1"></i>Loading...';
            
            const joinButton = document.getElementById('modalJoinCommunityBtn');
            joinButton.disabled = false;
            joinButton.classList.remove('btn-success', 'btn-warning');
            joinButton.classList.add('btn-primary');
            joinButton.innerHTML = '<i class="fas fa-plus me-1"></i><span>Join Community</span>';
            joinButton.style.display = 'block';
        },
        
        async showCommunityDetails(communityId) {
            try {
                this.currentCommunityId = communityId;
                this.resetModalContent();
                
                // Show modal first
                this.modal.show();
                
                const response = await fetch(`/Search/GetCommunityDetails?communityId=${communityId}`);
                const result = await response.json();
                
                console.log('Community API Response:', result); // Debug log
                
                if (result.success && result.data) {
                    const community = result.data;
                    this.currentCommunityType = community.communityType;
                    this.updateModalContent(community);
                } else {
                    console.error('Error loading community details:', result.message);
                    this.showError('Failed to load community details. Please try again.');
                }
            } catch (error) {
                console.error('Error loading community details:', error);
                this.showError('Failed to load community details. Please try again.');
            }
        },
        
        updateModalContent(community) {
            // Update modal content with community data
            document.getElementById('modalCommunityName').textContent = community.communityName;
            
            // Update community type badge
            const typeBadge = document.getElementById('modalCommunityType');
            typeBadge.textContent = community.communityType;
            typeBadge.className = `badge ${community.communityType === 'Public' ? 'bg-success' : 'bg-warning'} ms-2`;
            
            // Update description
            document.getElementById('modalCommunityDescription').textContent = 
                community.description || 'No description provided.';
            
            // Update location - FIX: Use communityLocation (correct property name)
            const locationText = community.communityLocation || 'Location not specified';
            document.getElementById('modalCommunityLocation').innerHTML = 
                `<i class="fas fa-map-marker-alt me-1"></i>${locationText}`;
            
            // Update creator
            document.getElementById('modalCommunityCreator').innerHTML = 
                `<i class="fas fa-user me-1"></i>${community.creatorName || 'Unknown'}`;
            
            // Update created date
            const createdDate = community.createdDate ? 
                new Date(community.createdDate).toLocaleDateString() : 'Unknown';
            document.getElementById('modalCommunityCreatedDate').innerHTML = 
                `<i class="fas fa-calendar me-1"></i>${createdDate}`;
            
            // Update members
            document.getElementById('modalCommunityMembers').innerHTML = 
                `<i class="fas fa-users me-1"></i>${community.memberCount || 0} members`;
            
            // Update last activity
            const lastActivity = community.lastActivityDate ? 
                new Date(community.lastActivityDate).toLocaleDateString() : 'Recently';
            document.getElementById('modalCommunityLastActivity').innerHTML = 
                `<i class="fas fa-clock me-1"></i>${lastActivity}`;
            
            // Update community image
            const communityImage = document.getElementById('modalCommunityImage');
            if (community.communityPic) {
                communityImage.innerHTML = `<img src="${community.communityPic}" alt="${community.communityName}" 
                    style="width: 100%; height: 100%; border-radius: 16px; object-fit: cover;">`;
            } else {
                communityImage.innerHTML = '<i class="fas fa-users" style="font-size: 3rem;"></i>';
            }
            
            // Update join button
            this.updateJoinButton(community);
        },
        
        updateJoinButton(community) {
            const joinButton = document.getElementById('modalJoinCommunityBtn');
            
            if (community.isMember) {
                joinButton.disabled = true;
                joinButton.innerHTML = '<i class="fas fa-check me-1"></i>Already Joined';
                joinButton.classList.remove('btn-primary');
                joinButton.classList.add('btn-success');
            } else if (community.isPending) {
                joinButton.disabled = true;
                joinButton.innerHTML = '<i class="fas fa-clock me-1"></i>Request Pending';
                joinButton.classList.remove('btn-primary');
                joinButton.classList.add('btn-warning');
            } else {
                joinButton.disabled = false;
                joinButton.classList.remove('btn-success', 'btn-warning');
                joinButton.classList.add('btn-primary');
                joinButton.innerHTML = `<i class="fas fa-plus me-1"></i><span>${community.communityType === 'Private' ? 'Request to Join' : 'Join Community'}</span>`;
            }
        },
        
        showError(message) {
            document.getElementById('modalCommunityName').textContent = 'Error';
            document.getElementById('modalCommunityDescription').textContent = message;
            document.getElementById('modalJoinCommunityBtn').style.display = 'none';
        },
        
        async joinCommunityFromModal(communityId, communityType) {
            const button = document.getElementById('modalJoinCommunityBtn');
            const originalHTML = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
            
            try {
                const token = this.getCsrfToken();
                
                const response = await fetch('/Search/JoinCommunity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: `communityId=${communityId}`
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.requiresApproval) {
                        button.innerHTML = '<i class="fas fa-clock me-1"></i>Request Sent';
                        button.classList.remove('btn-primary');
                        button.classList.add('btn-warning');
                        this.showAlert('success', data.message);
                    } else {
                        button.innerHTML = '<i class="fas fa-check me-1"></i>Joined';
                        button.classList.remove('btn-primary');
                        button.classList.add('btn-success');
                        this.showAlert('success', data.message);
                    }
                    
                    // Update the button in the main list if it exists
                    this.updateListButton(communityId, data.requiresApproval);
                } else {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                    this.showAlert('error', data.message);
                }
            } catch (error) {
                console.error('Error joining community:', error);
                button.innerHTML = originalHTML;
                button.disabled = false;
                this.showAlert('error', 'Error joining community. Please try again.');
            }
        },
        
        updateListButton(communityId, requiresApproval) {
            const listButton = document.querySelector(`.join-community-btn[data-community-id="${communityId}"]`);
            if (listButton) {
                if (requiresApproval) {
                    listButton.innerHTML = '<i class="fas fa-clock me-1"></i>Pending';
                    listButton.classList.remove('btn-custom');
                    listButton.classList.add('btn-warning');
                    listButton.disabled = true;
                } else {
                    listButton.innerHTML = '<i class="fas fa-check me-1"></i>Joined';
                    listButton.classList.remove('btn-custom');
                    listButton.classList.add('btn-success');
                    listButton.disabled = true;
                }
            }
        },
        
        getCsrfToken() {
            const el = document.querySelector('input[name="__RequestVerificationToken"]');
            return el ? el.value : null;
        },
        
        showAlert(type, message) {
            // You can replace this with a better notification system
            alert(type === 'success' ? message : '‚ùå ' + message);
        }
    };

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        CommunityModalManager.init();
    });

    // Global function to open modal
    window.openCommunityDetailModal = function(communityId) {
        CommunityModalManager.showCommunityDetails(communityId);
    };
</script>