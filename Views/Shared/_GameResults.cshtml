@model List<PicklePlay.Models.Schedule>
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    var currentUserId = HttpContextAccessor.HttpContext?.Session.GetInt32("UserId");
}

@if (Model != null && Model.Any())
{
    foreach (var game in Model)
    {
        // Calculate available spots and user participation status
        var confirmedParticipants = game.Participants?.Count(p => p.Status == PicklePlay.Models.ParticipantStatus.Confirmed) ?? 0;
        var availableSpots = (game.NumPlayer ?? 0) - confirmedParticipants;
        var isFull = availableSpots <= 0;
        
        var userParticipation = game.Participants?.FirstOrDefault(p => p.UserId == currentUserId);
        var hasJoined = userParticipation != null && userParticipation.Status == PicklePlay.Models.ParticipantStatus.Confirmed;
        var isPending = userParticipation != null && userParticipation.Status == PicklePlay.Models.ParticipantStatus.OnHold;

        // Check if game is from private community and user is not a member
        var isPrivateCommunityGame = game.Community?.CommunityType == "Private";
        var userIsCommunityMember = game.Community?.Memberships?.Any(m => m.UserId == currentUserId && m.Status == "Active") == true;
        var canViewGame = !isPrivateCommunityGame || (isPrivateCommunityGame && userIsCommunityMember);

        <div class="col-md-6 mb-4">
            <div class="result-card">
                <div class="d-flex align-items-start">
                    <div class="game-icon">
                        <i class="fas fa-table-tennis-paddle-ball"></i>
                    </div>
                    <div class="player-info">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h4>@(game.GameName ?? "Pickleball Game")</h4>
                                <p class="text-muted mb-2">@(game.Description ?? "Join us for a fun game of pickleball!")</p>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold @(game.FeeAmount > 0 ? "text-warning" : "text-success") mb-2">
                                    @if (game.FeeType == PicklePlay.Models.FeeType.Free || game.FeeType == PicklePlay.Models.FeeType.None)
                                    {
                                        <text>FREE</text>
                                    }
                                    else
                                    {
                                        <text>RM@(game.FeeAmount?.ToString("0.00"))</text>
                                    }
                                </div>
                                <small class="text-muted">@game.StartTime?.ToString("MMM dd, yyyy")</small>
                            </div>
                        </div>
                        <div class="d-flex flex-wrap mb-3">
                            <span class="stats-badge">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                @(game.Location ?? "Court location")
                            </span>
                            <span class="stats-badge @(isFull ? "bg-danger" : "bg-success")">
                                <i class="fas fa-users me-1"></i>
                                @confirmedParticipants/@(game.NumPlayer ?? 0) spots
                            </span>
                            <span class="stats-badge">
                                <i class="fas fa-clock me-1"></i>
                                @game.StartTime?.ToString("h:mm tt")
                            </span>
                            @if (game.Community != null)
                            {
                                <span class="stats-badge @(game.Community.CommunityType == "Private" ? "bg-warning" : "bg-info")">
                                    <i class="fas fa-users me-1"></i>
                                    @game.Community.CommunityName
                                </span>
                            }
                        </div>
                        <div class="action-buttons">
                            <a href="/Schedule/Details/@game.ScheduleId" class="btn btn-custom">
                                <i class="fas fa-eye me-1"></i>View Details
                            </a>
                            
                            @if (!canViewGame)
                            {
                                <button class="btn btn-secondary" disabled title="Join the community to access this game">
                                    <i class="fas fa-lock me-1"></i>Private
                                </button>
                            }
                            else if (currentUserId == null)
                            {
                                <a href="/Auth/Login?returnUrl=@Context.Request.Path" class="btn btn-outline-custom">
                                    <i class="fas fa-sign-in-alt me-1"></i>Login to Join
                                </a>
                            }
                            else if (hasJoined)
                            {
                                <button class="btn btn-success" disabled>
                                    <i class="fas fa-check me-1"></i>Joined
                                </button>
                            }
                            else if (isPending)
                            {
                                <button class="btn btn-warning" disabled>
                                    <i class="fas fa-clock me-1"></i>Pending
                                </button>
                            }
                            else if (isFull)
                            {
                                <button class="btn btn-secondary" disabled>
                                    <i class="fas fa-times me-1"></i>Full
                                </button>
                            }
                            else
                            {
                                <a href="/Schedule/Details/@game.ScheduleId" class="btn btn-outline-custom">
                                    <i class="fas fa-user-plus me-1"></i>Join Game
                                </a>
                            }

                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
}
else
{
    <div class="col-12">
        <div class="empty-state">
            <i class="fas fa-table-tennis-paddle-ball text-muted"></i>
            <h4>No games found</h4>
            <p class="text-muted">Try adjusting your search criteria</p>
        </div>
    </div>
}