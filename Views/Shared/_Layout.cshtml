<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - PicklePlay</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom Auth CSS -->
    <link rel="stylesheet" href="~/css/auth.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* Reset body styles to prevent conflicts */
        body {
            margin: 0 !important;
            padding: 0 !important;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Ensure navbar stays at top */
        .navbar-custom {
            background: linear-gradient(135deg, #2E8B57 0%, #1E5B32 100%);
            border: none !important;
            position: sticky !important;
            top: 0 !important;
            z-index: 1000 !important;
            width: 100% !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .navbar-custom .navbar-brand {
            color: white !important;
            font-weight: bold;
            font-size: 1.5rem;
            margin: 0 !important;
        }

        .navbar-custom .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: bold;
            padding: 8px 15px !important;
            transition: all 0.3s;
        }

        .navbar-custom .nav-link:hover {
            color: white !important;
            transform: translateY(-2px);
        }

        .navbar-custom .nav-link.active {
            color: white !important;
            font-weight: bold;
        }

        .navbar-custom .navbar-toggler {
            border-color: white !important;
            margin: 0 !important;
        }

        .navbar-custom .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='white' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e") !important;
        }

        .profile-img-navbar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.7);
            margin: 0 !important;
        }

        /* Ensure navbar items align properly */
        .navbar-collapse {
            flex-grow: 1 !important;
        }

        .navbar-nav {
            align-items: center !important;
        }

        /* Main content area */
        .main-content-wrapper {
            background-color: #E8F5E9;
            flex: 1;
            width: 100%;
        }

        .dropdown-menu-custom {
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .dropdown-item-custom {
            padding: 8px 16px;
            transition: all 0.2s;
        }

        .dropdown-item-custom:hover {
            background-color: #f8f9fa;
        }

        .rank-modal-display {
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 2px solid #dee2e6;
        }

        .rank-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .rank-modal-rating {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .rank-stat-mini {
            padding: 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .rank-stat-mini .fw-bold {
            font-size: 1.1rem;
            color: #667eea;
        }

        .rank-stat-mini .text-muted {
            font-size: 0.75rem;
        }
    </style>

    @await RenderSectionAsync("Styles", required: false)
</head>

<body>
    <!-- Navbar -->
    @if (Context.Session.GetString("UserEmail") != null)
    {
        <nav class="navbar navbar-expand-lg navbar-custom">
            <div class="container">
                <a class="navbar-brand" href="@Url.Action("Index", "Home")">
                    <img src="~/images/logoV3.png" alt="Logo" width="40" height="40"
                        class="d-inline-block align-text-center me-2">
                    PicklePlay
                </a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" href="@Url.Action("Index", "Home")"><i class="fas fa-home me-1"></i>
                                Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="@Url.Action("Community", "Home")"><i class="fas fa-users me-1"></i>
                                Community</a>
                        </li>
                        @* <li class="nav-item">
                            <a class="nav-link" href="@Url.Action("Activity", "Community")"><i class="fas fa-users me-1"></i> Community Profile</a>
                        </li> *@
                        <li class="nav-item">
                            <a class="nav-link" href="@Url.Action("Search", "Search")"><i class="fas fa-search me-1"></i>
                                Search</a>
                        </li>

                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="scheduleDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-calendar-alt me-1"></i> Schedule
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="scheduleDropdown">
                                <li><a class="dropdown-item" href="@Url.Action("GameListing", "Schedule")"><i
                                            class="fas fa-table-tennis-paddle-ball"></i> Game Schedule</a></li>
                                <li><a class="dropdown-item" href="@Url.Action("MyGame", "MyGame")"><i
                                            class="bi bi-person-video"></i> My Games</a></li>

                            </ul>
                        </li>

                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="competitionDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-trophy me-1"></i> Competition
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="competitionDropdown">
                                <li>
                                    <a class="dropdown-item" href="@Url.Action("Listing", "Competition")">
                                        <i class="fas fa-list me-2"></i>Competition Schedule
                                    </a>
                                </li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li>
                                    <a class="dropdown-item" href="@Url.Action("Leaderboard", "Rank")">
                                        <i class="bi bi-trophy-fill me-2"></i>RANK Leaderboard
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="@Url.Action("MatchHistory", "Rank")">
                                        <i class="bi bi-clock-history me-2"></i>My Match History
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="@Url.Action("Index", "AiPartner")">
                                        <i class="fas fa-robot me-2"></i>AI Suggest Partner
                                    </a>
                                </li>
                            </ul>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="@Url.Action("Index", "Communication")"><i
                                    class="bi bi-envelope-fill me-1"></i> Communications</a>
                        </li>
                    </ul>

                    <div class="d-flex align-items-center">
                        <span class="text-white fw-bold me-2">@(Context.Session.GetString("UserName") ?? "User")</span>

                        <!-- Profile Dropdown -->
                        <div class="dropdown">
                            <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle"
                                id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                @{
                                    var profileImagePath = Context.Session.GetString("ProfileImagePath");
                                    var defaultImagePath = "/images/user (1).png";
                                    var userProfileImage = !string.IsNullOrEmpty(profileImagePath) ? profileImagePath :
                                    defaultImagePath;
                                }
                                <img src="@userProfileImage" alt="Profile" class="profile-img-navbar"
                                    onerror="this.src='@defaultImagePath'">
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-custom"
                                aria-labelledby="profileDropdown">
                                <li>
                                    <a class="dropdown-item dropdown-item-custom" href="@Url.Action("EditProfile", "Home")">
                                        <i class="fas fa-user-edit me-2"></i>Profile
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item dropdown-item-custom"
                                        href="@Url.Action("WalletManagement", "Wallet")">
                                        <i class="fas fa-wallet me-2"></i>Wallet
                                    </a>
                                </li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li>
                                    <form asp-controller="Auth" asp-action="Logout" method="post" class="m-0">
                                        @Html.AntiForgeryToken()
                                        <button type="submit"
                                            class="dropdown-item dropdown-item-custom text-danger w-100 text-start">
                                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>

                        <!-- Admin Dropdown - Only show if user is Admin -->
                        @if (Context.Session.GetString("UserRole") == "Admin")
                        {
                            <div class="dropdown ms-2">
                                <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    Admin
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="@Url.Action("AdminDashboard", "Admin")">
                                            <i class="fas fa-tachometer-alt me-2"></i>Back to Admin
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </nav>
    }

    <div class="main-content-wrapper">
        @RenderBody()
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    @* SignalR Client Library *@
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.14/signalr.min.js"></script>

    @await RenderSectionAsync("Scripts", required: false)
    @await Html.PartialAsync("_UserProfilePreviewModal")

    <script>
        // Global function to show user profile preview
        window.showUserProfilePreview = async function (userId) {
            console.log('=== showUserProfilePreview called ===');
            console.log('UserId:', userId);

            const modal = new bootstrap.Modal(document.getElementById('userProfilePreviewModal'));
            const contentDiv = document.getElementById('userPreviewContent');

            // Show loading
            contentDiv.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading user profile...</p>
                </div>
            `;

            modal.show();

            try {
                const url = `/Home/GetUserProfilePreview?userId=${userId}`;
                console.log('Fetching URL:', url);

                const response = await fetch(url);
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Result:', result);

                if (!result.success) {
                    console.error('API returned error:', result.message);
                    contentDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-exclamation-circle"></i>
                            <p>${result.message || 'Failed to load user profile'}</p>
                        </div>
                    `;
                    return;
                }

                const user = result.data;
                console.log('User data:', user);

                // Render profile content
                contentDiv.innerHTML = renderUserProfile(user);
                console.log('Profile rendered successfully');

                loadModalRankData(user.userId);

            } catch (error) {
                console.error('=== Error in showUserProfilePreview ===');
                console.error('Error type:', error.name);
                console.error('Error message:', error.message);
                console.error('Stack trace:', error.stack);

                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-circle"></i>
                        <h5>Oops! Something went wrong</h5>
                        <p class="text-danger">${error.message}</p>
                        <small class="text-muted">Check browser console (F12) for details</small>
                    </div>
                `;
            }
        };

        function renderUserProfile(user) {
            const profileImage = user.profileImagePath || '/images/profile_image.jpg';
            const genderIcon = user.gender === 'male' ? 'mars' : user.gender === 'female' ? 'venus' : 'genderless';

            // Action buttons based on status
            let actionButtons = '';

            if (user.isCurrentUser) {
                actionButtons = `
                    <a href="/Home/EditProfile" class="btn btn-add-friend">
                        <i class="bi bi-pencil me-2"></i>Edit Profile
                    </a>
                `;
            } else {
                if (user.isFriend) {
                    actionButtons += `
                        <button class="btn btn-friend-status" disabled>
                            <i class="bi bi-user-check me-2"></i>Friends
                        </button>
                    `;
                } else if (user.hasPendingFriendRequest) {
                    actionButtons += `
                        <button class="btn btn-friend-status" disabled>
                            <i class="bi bi-clock me-2"></i>Request Pending
                        </button>
                    `;
                } else {
                    actionButtons += `
                        <button class="btn btn-add-friend" onclick="sendFriendRequest(${user.userId})">
                            <i class="bi bi-user-plus me-2"></i>Add Friend
                        </button>
                    `;
                }

                actionButtons += `
                    <button class="btn btn-favorite" onclick="toggleFavorite(${user.userId})" title="Coming Soon">
        <i class="bi bi-star"></i>
    </button>
    <button class="btn btn-report" id="reportReplaceBtn" type="button" title="Report / Nudge"
                           onclick="(function(){const m = new bootstrap.Modal(document.getElementById('aiReportModal'), { backdrop: 'static', keyboard: false }); m.show();})();">
                       <i class="bi bi-flag-fill"></i>
                  </button>
                `;
            }

            return `
                <!-- Header -->
                <div class="user-preview-header text-center">
                    <img src="${profileImage}" alt="${user.fullName}" class="user-preview-avatar">
                    <div class="user-preview-name">${user.fullName}</div>
                    <div class="user-preview-username">@@${user.username}</div>
                    
                    <div class="user-preview-meta justify-content-center">
                        ${user.gender ? `<span><i class="bi bi-gender-${genderIcon}"></i> ${user.gender}</span>` : ''}
                        ${user.age ? `<span><i class="bi bi-calendar"></i> ${user.age} years old</span>` : ''}
                        ${user.location ? `<span><i class="bi bi-geo-alt"></i> ${user.location}</span>` : ''}
                    </div>
                    
                    <div class="user-preview-actions">
                        ${actionButtons}
                    </div>
                </div>

                <!-- ⬇️ NEW: RANK Display -->
        <div class="user-preview-section" id="rankSection-${user.userId}">
            <h6><i class="bi bi-graph-up-arrow me-2 text-primary"></i>RANK Rating</h6>
            <div id="rankLoading-${user.userId}" class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="text-muted ms-2">Loading rating...</span>
            </div>
            <div id="rankData-${user.userId}" style="display: none;"></div>
        </div>
                
                <!-- Stats -->
                <div class="user-preview-section">
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-number">${user.friendCount}</div>
                            <div class="stat-label">Friends</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${user.endorsementCount}</div>
                            <div class="stat-label">Endorsements</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${user.achievementCount}</div>
                            <div class="stat-label">Achievements</div>
                        </div>
                    </div>
                </div>
                
                <!-- Bio -->
                ${user.bio ? `
                    <div class="user-preview-section">
                        <h6><i class="bi bi-quote me-2"></i>About</h6>
                        <p class="text-muted mb-0">${user.bio}</p>
                    </div>
                ` : ''}
                
                <!-- Recent Endorsements -->
                <div class="user-preview-section">
                    <h6><i class="bi bi-hand-thumbs-up me-2"></i>Recent Endorsements</h6>
                    ${user.recentEndorsements.length > 0 ?
                    user.recentEndorsements.map(e => `
                            <div class="endorsement-item">
                                <img src="${e.endorserImage || '/images/profile_image.jpg'}" 
                                     alt="${e.endorserName}" class="endorsement-avatar">
                                <div class="endorsement-content">
                                    <div class="endorsement-name">${e.endorserName}</div>
                                    <div class="endorsement-comment">"${e.comment}"</div>
                                    <div class="endorsement-date">${formatDate(e.createdAt)}</div>
                                </div>
                            </div>
                        `).join('')
                    :
                    '<p class="text-muted text-center">No endorsements yet</p>'
                }
                    ${user.endorsementCount > 3 ? `
                        <div class="text-center mt-2">
                            <a href="/Schedule/SeeEndorsement?userId=${user.userId}" class="btn btn-sm btn-outline-primary">
                                View All ${user.endorsementCount} Endorsements
                            </a>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Recent Achievements -->
                <div class="user-preview-section">
                    <h6><i class="bi bi-trophy me-2"></i>Recent Achievements</h6>
                    ${user.recentAchievements.length > 0 ?
                    user.recentAchievements.map(a => `
                            <div class="achievement-badge-small">
                                <div class="achievement-icon-small">${getAwardIcon(a.awardType)}</div>
                                <div class="achievement-details-small">
                                    <div class="achievement-title-small">
                                        ${a.awardName}
                                        <span class="position-badge-small pos-${a.position}">
                                            ${a.positionName}
                                        </span>
                                    </div>
                                    <div class="achievement-meta-small">
                                        ${a.competitionTitle} • ${formatDate(a.awardedDate)}
                                    </div>
                                </div>
                            </div>
                        `).join('')
                    :
                    '<p class="text-muted text-center">No achievements yet</p>'
                }
                </div>
            `;
        }

        function loadModalRankData(userId) {
            fetch(`/Rank/GetPlayerRank?userId=${userId}`)
                .then(response => response.json())
                .then(data => {
                    const loadingDiv = document.getElementById(`rankLoading-${userId}`);
                    const dataDiv = document.getElementById(`rankData-${userId}`);

                    if (loadingDiv) loadingDiv.style.display = 'none';
                    if (!dataDiv) return;

                    if (data.success) {
                        const rank = data.rank;
                        dataDiv.style.display = 'block';

                        // Get status color
                        let statusColor = 'secondary';
                        if (rank.status === 'Reliable') statusColor = 'success';
                        else if (rank.status === 'Provisional') statusColor = 'warning';

                        // Get reliability color
                        let reliabilityColor = 'danger';
                        if (rank.reliabilityScore >= 80) reliabilityColor = 'success';
                        else if (rank.reliabilityScore >= 60) reliabilityColor = 'info';
                        else if (rank.reliabilityScore >= 40) reliabilityColor = 'warning';

                        dataDiv.innerHTML = `
                    <div class="rank-modal-display">
                        <div class="rank-modal-header">
                            <div class="rank-modal-rating">
                                ${rank.rating}
                            </div>
                            <span class="badge bg-${statusColor}">${rank.status}</span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">Reliability</small>
                                <small class="fw-bold">${rank.reliabilityScore.toFixed(0)}%</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-${reliabilityColor}" 
                                     style="width: ${rank.reliabilityScore}%;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-2 text-center small">
                            <div class="col-4">
                                <div class="rank-stat-mini">
                                    <div class="fw-bold">${rank.totalMatches}</div>
                                    <div class="text-muted">Matches</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="rank-stat-mini">
                                    <div class="fw-bold">${rank.winRate.toFixed(1)}%</div>
                                    <div class="text-muted">Win Rate</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="rank-stat-mini">
                                    <div class="fw-bold">${rank.uniquePartners + rank.uniqueOpponents}</div>
                                    <div class="text-muted">Network</div>
                                </div>
                            </div>
                        </div>
                        
                        ${rank.totalMatches > 0 ? `
                            <div class="text-center mt-2">
                                <a href="/Rank/MatchHistory?userId=${userId}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-clock-history me-1"></i>View Match History
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
                    } else {
                        dataDiv.innerHTML = '<p class="text-muted text-center mb-0">No rating data available</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading rank:', error);
                    const loadingDiv = document.getElementById(`rankLoading-${userId}`);
                    const dataDiv = document.getElementById(`rankData-${userId}`);
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    if (dataDiv) {
                        dataDiv.style.display = 'block';
                        dataDiv.innerHTML = '<p class="text-danger text-center mb-0 small">Failed to load rating</p>';
                    }
                });
        }

        function getAwardIcon(type) {
            const icons = {
                0: '🏆', // Trophy
                1: '🥇', // Medal
                2: '🎀', // Ribbon
                3: '👑', // Crown
                4: '⭐', // Star
                5: '👕', // Shirt
                6: '👟', // Shoe
                7: '🎫'  // Ticket
            };
            return icons[type] || '🏆';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
            return `${Math.floor(diffDays / 365)} years ago`;
        }

        // Placeholder functions for future features
        async function sendFriendRequest(userId) {
            try {
                const response = await fetch('/Friendship/SendFriendRequest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userId)
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    // Reload the modal to show updated status
                    showUserProfilePreview(userId);
                } else {
                    alert(result.message || 'Failed to send friend request');
                }
            } catch (error) {
                console.error('Error sending friend request:', error);
                alert('An error occurred while sending the friend request');
            }
        }

        function openChat(userId) {
            console.log('🟢 openChat called with userId:', userId);
            console.log('🟢 Current location:', window.location.href);

            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('userProfilePreviewModal'));
            if (modal) {
                modal.hide();
            }

            // IMPORTANT: Use window.location.href, NOT window.location.replace()
            const newUrl = `/Friendship/Communication?tab=friends&chatWith=${userId}`;
            console.log('🟢 Navigating to:', newUrl);

            window.location.href = newUrl;
        }

        console.log('✓ User Profile Preview Modal loaded globally');
    </script>
</body>

</html>