@model IEnumerable<PicklePlay.Models.Schedule>
@using PicklePlay.Models
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Game Schedule";
    var today = DateTime.Today;
    var currentUserId = HttpContextAccessor.HttpContext?.Session.GetInt32("UserId");

    // Helper function to make date headers user-friendly
    string GetFriendlyDateString(DateTime date)
    {
        if (date == today) return "Today";
        if (date == today.AddDays(1)) return "Tomorrow";
        return date.ToString("dd/MM/yyyy (dddd)");
    }

    // Get status text and CSS class
    (string, string) GetStatusInfo(ScheduleParticipant? p, bool isFull)
    {
        if (p != null)
        {
            return p.Status switch
            {
                ParticipantStatus.Confirmed => ("Confirmed", "status-confirmed"),
                ParticipantStatus.PendingPayment => ("Pending", "status-pending"),
                ParticipantStatus.OnHold => ("On Hold", "status-onhold"),
                ParticipantStatus.Cancelled => ("Quit", "status-cancelled"),
                _ => ("", "")
            };
        }
        
        // If user not joined, check if full
        if (isFull)
        {
            return ("FULL", "status-full");
        }

        return ("", "");
    }

    // ⬇️ UPDATED QUERY: Filter by OneOff, Future, Public Game & Public Community
    // (Assuming Model passed from controller already has .Include(s => s.Community))


    var groupedByDay = Model
        .OrderBy(s => s.StartTime)
        .GroupBy(g => g.StartTime!.Value.Date)
        .OrderBy(g => g.Key);
}

<style>
    .game-card {
        position: relative;
        overflow: hidden;
        border-left: 4px solid transparent; /* Prep for hover effect */
        transition: all 0.2s ease;
    }
    .game-card:hover {
        background-color: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-left-color: #2E8B57; /* Green accent on hover */
    }
    
    /* === STATUS BADGE STYLES === */
    .status-badge {
        position: absolute;
        top: 0;
        right: 0;
        font-size: 0.75rem;
        font-weight: bold;
        padding: 0.3em 0.8em;
        border-bottom-left-radius: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-confirmed { background-color: #d1e7dd; color: #0f5132; }
    .status-pending { background-color: #cff4fc; color: #055160; }
    .status-onhold { background-color: #fff3cd; color: #664d03; }
    .status-cancelled { background-color: #f8d7da; color: #842029; }
    .status-full { background-color: #6c757d; color: #fff; } /* Gray for Full */

    /* Community Badge */
    .community-tag {
        font-size: 0.75rem;
        color: #6c757d;
        display: flex;
        align-items: center;
        margin-bottom: 4px;
    }
    .community-icon-small {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        object-fit: cover;
        margin-right: 6px;
        background-color: #e9ecef; /* Placeholder color */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
    }
</style>

<div class="container mt-4 page-wrapper">
    <h2 class="mb-4"><i class="bi bi-calendar3-event me-2"></i>Public Games</h2>

    @if (!groupedByDay.Any())
    {
        <div class="text-center py-5 text-muted">
            <i class="bi bi-calendar-x fs-1"></i>
            <p class="mt-2">No upcoming public games found.</p>
        </div>
    }

    @foreach (var dayGroup in groupedByDay)
    {
        <h5 class="mt-4 mb-3 text-primary border-bottom pb-2">
            <i class="bi bi-calendar-date me-2"></i>@GetFriendlyDateString(dayGroup.Key)
        </h5>

        var groupedByTime = dayGroup.GroupBy(g => g.StartTime!.Value.TimeOfDay).OrderBy(tg => tg.Key);

        @foreach (var timeGroup in groupedByTime)
        {
            <div class="mb-2 text-muted small fw-bold">
                <i class="bi bi-clock me-1"></i>@timeGroup.First().StartTime!.Value.ToString("hh:mm tt")
            </div>

            <div class="row g-3">
                @foreach (var game in timeGroup)
                {
                    // --- Calculate Counts (Include Reserved Slots) ---
                    var confirmedPlayers = game.Participants!.Where(p => p.Role == ParticipantRole.Player && p.Status == ParticipantStatus.Confirmed).ToList();
                    int totalConfirmedCount = confirmedPlayers.Sum(p => 1 + p.ReservedSlots); // 1 (Self) + Reserved
                    int maxPlayers = game.NumPlayer ?? 0;
                    bool isFull = maxPlayers > 0 && totalConfirmedCount >= maxPlayers;

                    // --- Find user's status ---
                    var userParticipation = currentUserId.HasValue ? 
                        game.Participants?.FirstOrDefault(p => p.UserId == currentUserId.Value && p.Role == ParticipantRole.Player) : 
                        null;
                    
                    var (statusText, statusClass) = GetStatusInfo(userParticipation, isFull);
                    
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 shadow-sm game-card"
                             onclick="location.href='@Url.Action("Details", "Schedule", new { id = game.ScheduleId })'"
                             style="cursor:pointer;">
                            
                            @if (!string.IsNullOrEmpty(statusText))
                            {
                                <div class="status-badge @statusClass">@statusText</div>
                            }
                            
                            <div class="card-body">
                                @if (game.Community != null)
                                {
                                    <div class="community-tag">
                                        @if(!string.IsNullOrEmpty(game.Community.CommunityPic))
                                        {
                                            // Assuming Icon is a FontAwesome class like "fa-users"
                                            <div class="community-icon-small text-white bg-secondary">
                                                <i class="fas fa-@game.Community.CommunityPic"></i>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="community-icon-small text-white bg-secondary">
                                                <i class="fas fa-users"></i>
                                            </div>
                                        }
                                        <span>@game.Community.CommunityName</span>
                                    </div>
                                }

                                <h5 class="card-title mb-2 text-truncate" title="@game.GameName">@game.GameName</h5>
                                
                                <div class="text-muted small mb-2">
                                    <i class="bi bi-geo-alt-fill me-1 text-danger"></i>@game.Location
                                </div>

                                <div class="d-flex justify-content-between align-items-end mt-3">
                                    <div>
                                        @if(game.EventTag.HasValue && game.EventTag != EventTag.None)
                                        {
                                            <span class="badge bg-light text-primary border border-primary">
                                                @game.EventTag.ToString()
                                            </span>
                                        }
                                        @if(game.FeeType == FeeType.Free || game.FeeType == FeeType.None)
                                        {
                                            <span class="badge bg-success ms-1">Free</span>
                                        }
                                    </div>

                                    <div class="text-end">
                                        @if (maxPlayers > 0)
                                        {
                                            <span class="fw-bold @(isFull ? "text-danger" : "text-success")">
                                                <i class="bi bi-person-fill"></i> @totalConfirmedCount / @maxPlayers
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="fw-bold text-success">
                                                <i class="bi bi-person-fill"></i> @totalConfirmedCount
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="mb-4"></div> }
    }
</div>