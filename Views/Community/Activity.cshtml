@model IEnumerable<Schedule>
@using PicklePlay.Models
@using System.Globalization

@* --- UPDATED Helper Record (Simpler) --- *@
@functions {
    public record CalendarEvent(
    int ScheduleId,
    string GameName,
    DateTime StartTime,
    ScheduleType ScheduleType, // Only used to differentiate Game vs Comp
    ScheduleStatus? Status) // Only used for Comp coloring
    {
        // --- UPDATED CSS Logic (Simpler) ---
        public string CssClass
        {
            get
            {
                if (ScheduleType == ScheduleType.Competition)
                {
                    // If PendingSetup, use orange. Otherwise, use yellow.
                    return (Status == ScheduleStatus.PendingSetup) ? "cal-event-pending" : "cal-event-comp";
                }

                // All other types (OneOff, Recurring instances) are just "Games"
                return "cal-event-game"; // Green
            }
        }
    }
}

@{
    ViewData["Title"] = "Community Hub";

    // Get current community info
    var currentCommunity = ViewData["CurrentCommunity"] as Community;
    var currentCommunityId = ViewData["CurrentCommunityId"] as int?;

    var today = DateTime.Today;
    var yearVal = Context.Request.Query["year"];
    var monthVal = Context.Request.Query["month"];

    string yearStr = yearVal.ToString(); // Explicitly convert to string
    string monthStr = monthVal.ToString(); // Explicitly convert to string

    // --- 1. Date setup for Monthly Calendar ---
    int year = string.IsNullOrEmpty(yearStr) ? DateTime.Now.Year : int.Parse(yearStr);
    int month = string.IsNullOrEmpty(monthStr) ? DateTime.Now.Month : int.Parse(monthStr);
    var displayDate = new DateTime(year, month, 1);
    var nextMonthDate = displayDate.AddMonths(1);
    var prevMonthDate = displayDate.AddMonths(-1);
    var displayYear = displayDate.Year;
    var displayMonth = displayDate.Month;
    var daysInMonth = DateTime.DaysInMonth(displayYear, displayMonth);
    var firstDayOfMonth = new DateTime(displayYear, displayMonth, 1);

    // --- 2. Prepare Event Data for Calendar (SIMPLIFIED LOGIC) ---
    // We NO LONGER read the Recurring "templates". We only read the
    // actual game instances (ScheduleType.OneOff) and competitions.

    var eventsByDay = new Dictionary<int, List<CalendarEvent>>();
    void AddEvent(int day, CalendarEvent calEvent)
    {
        if (!eventsByDay.ContainsKey(day))
        {
            eventsByDay[day] = new List<CalendarEvent>();
        }
        if (!eventsByDay[day].Any(e => e.ScheduleId == calEvent.ScheduleId))
        {
            eventsByDay[day].Add(calEvent);
        }
    }

    // Process ALL displayable schedules (OneOff instances and Competitions)
    foreach (var schedule in Model.Where(s => s.ScheduleType != ScheduleType.Recurring && s.StartTime.HasValue))
    {
        // Check if it's in the displayed month
        if (schedule.StartTime!.Value.Year == displayYear && schedule.StartTime.Value.Month == displayMonth)
        {
            if (schedule.ScheduleType == ScheduleType.OneOff)
            {
                AddEvent(schedule.StartTime.Value.Day, new CalendarEvent(
                schedule.ScheduleId, schedule.GameName!, schedule.StartTime.Value,
                schedule.ScheduleType.Value, schedule.Status));
            }
            else if (schedule.ScheduleType == ScheduleType.Competition)
            {
                // For multi-day comps, add all days
                var startDate = schedule.StartTime.Value;
                var endDate = schedule.EndTime ?? startDate;
                for (var date = startDate.Date; date <= endDate.Date; date = date.AddDays(1))
                {
                    if (date.Year == displayYear && date.Month == displayMonth)
                    {
                        AddEvent(date.Day, new CalendarEvent(
                        schedule.ScheduleId, schedule.GameName!, schedule.StartTime.Value,
                        schedule.ScheduleType.Value, schedule.Status));
                    }
                }
            }
        }
    }


    // --- 3. Lists for Active/Past Tabs (CORRECTED LOGIC) ---

    // Get ONLY the game instances (ScheduleType.OneOff).
    // This correctly excludes the parent "Recurring" templates.
    var allGames = Model.Where(s => s.ScheduleType == ScheduleType.OneOff);

    // Active games are OneOff instances in the future (or today).
    var activeGames = allGames.Where(g => g.StartTime.HasValue && g.StartTime.Value >= today)
    .OrderBy(g => g.StartTime);

    // Past games are OneOff instances in the past.
    var pastGames = allGames.Where(g => g.StartTime.HasValue && g.StartTime.Value < today)
    .OrderByDescending(g => g.StartTime);

    // Competition lists (Unchanged)
    var allCompetitions = Model.Where(s => s.ScheduleType == ScheduleType.Competition);
    var activeCompetitions = allCompetitions.Where(c => (c.Status == ScheduleStatus.Active ||
    c.Status == ScheduleStatus.PendingSetup) &&
    c.EndTime.HasValue && c.EndTime.Value.Date >= today)
    .OrderBy(c => c.StartTime);
    var pastCompetitions = allCompetitions.Where(c => c.Status == ScheduleStatus.Past ||
    (c.EndTime.HasValue && c.EndTime.Value.Date < today))
    .OrderByDescending(c => c.StartTime);

    // --- 4. Friendly Date Helper ---
    string GetFriendlyDateString(DateTime date)
    {
        if (date == today) return "Today";
        if (date == today.AddDays(1)) return "Tomorrow";
        return date.ToString("dddd, dd MMM yyyy");
    }

    // --- NEW: Get community member count ---
    int memberCount = ViewData["MemberCount"] as int? ?? 0;
    var announcements = ViewData["Announcements"] as List<CommunityAnnouncement> ?? new List<CommunityAnnouncement>();
    var communityMembers = ViewData["CommunityMembers"] as List<CommunityMember> ?? new List<CommunityMember>();

    
}
@* --- UPDATED COMMUNITY HEADER (Exact same as Admin Dashboard) --- *@
@if (currentCommunity != null)
{
    <div class="page-header-activity mb-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="fw-bold"><i class="fas fa-users me-2"></i>@currentCommunity.CommunityName</h1>
                    <p class="lead mb-0">
                        Community Hub | Location: @currentCommunity.CommunityLocation
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="@Url.Action("Community", "Home")" class="btn btn-light btn-sm">
                        <i class="fas fa-arrow-left me-2"></i>Back to Communities
                    </a>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="container-fluid">
        <div class="alert alert-warning mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="alert-heading mb-1">All Communities</h4>
                    <p class="mb-0">Showing games from all communities. Select a community to filter games.</p>
                </div>
                <a href="@Url.Action("Community", "Home")" class="btn btn-sm btn-primary">
                    Choose Community
                </a>
            </div>
        </div>
    </div>
}


<div class="container-fluid">


    <div class="row">
        @* --- UPDATED Left Column: Community Profile Preview --- *@
        <div class="col-lg-3 d-none d-lg-block">
            <div class="card sidebar-card" style="position: sticky; top: 80px;">
                <div class="card-body">
                    @if (currentCommunity != null)
                    {
                        @* Community Profile Preview *@
                        <div class="community-profile">
                            @if (!string.IsNullOrEmpty(currentCommunity.CommunityPic))
                            {
                                <img src="@currentCommunity.CommunityPic" alt="@currentCommunity.CommunityName"
                                    class="community-avatar">
                            }
                            else
                            {
                                <div class="community-avatar-placeholder">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            }
                            <h5 class="community-name">@currentCommunity.CommunityName</h5>
                            <p class="community-location">
                                <i class="fas fa-map-marker-alt me-1"></i>@currentCommunity.CommunityLocation
                            </p>
                            <div class="community-stats">
                                <div class="stat-item">
                                    <div class="stat-value">@memberCount</div>
                                    <div class="stat-label">Total Members</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">@activeGames.Count()</div>
                                    <div class="stat-label">Active Games</div>
                                </div>
                            </div>
                        </div>

                        <p class="community-description">@currentCommunity.Description</p>

                        @* Creation Buttons Moved Below Profile *@
                        <div class="create-event-section">
                            <h6 class="create-event-title">Create Event</h6>
                            <a asp-action="CreateOneOff" asp-controller="Community"
                                class="btn btn-green mb-2 w-100">
                                <i class="fas fa-plus-circle me-1"></i>One-Off Game
                            </a>
                            <a asp-action="CreateRecurring" asp-controller="Community"
                                class="btn btn-green mb-2 w-100">
                                <i class="fas fa-redo me-1"></i>Recurring Game
                            </a>
                            <a asp-action="CreateCompetition" asp-controller="Community"
                                class="btn btn-green w-100">
                                <i class="fas fa-trophy me-1"></i>Competition
                            </a>
                        </div>
                    }
                    else
                    {
                        <h5 class="card-title">Community Info</h5>
                        <p class="card-text">Select a community to see games and create events.</p>
                        <a href="@Url.Action("Community", "Home")" class="btn btn-green w-100">
                            Choose Community
                        </a>
                    }
                </div>
            </div>
        </div>

        @* --- Center Content Column --- *@
        <div class="col-lg-6 col-md-8">

            @* --- MAIN TABS (Activity, Chat, Members) --- *@
            <ul class="nav nav-tabs mb-3" id="communityMainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="activity-tab" data-bs-toggle="tab"
                        data-bs-target="#activity-tab-pane" type="button" role="tab" aria-controls="activity-tab-pane"
                        aria-selected="true">Activity</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link disabled" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat-tab-pane"
                        type="button" role="tab" aria-controls="chat-tab-pane" aria-selected="false">Chat</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="members-tab" data-bs-toggle="tab" data-bs-target="#members-tab-pane"
                        type="button" role="tab" aria-controls="members-tab-pane" aria-selected="false">Members</button>
                </li>
            </ul>

            <div class="tab-content" id="communityMainTabsContent">

                @* --- ACTIVITY TAB PANE --- *@
                <div class="tab-pane fade show active" id="activity-tab-pane" role="tabpanel"
                    aria-labelledby="activity-tab" tabindex="0">

                    @* --- Activity Sub-Tabs --- *@
                    <ul class="nav nav-pills nav-fill mb-3" id="activitySubTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="regular-schedule-tab" data-bs-toggle="tab"
                                data-bs-target="#regular-schedule-pane" type="button" role="tab"
                                aria-controls="regular-schedule-pane" aria-selected="true">Schedule Calendar</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="games-tab" data-bs-toggle="tab" data-bs-target="#games-pane"
                                type="button" role="tab" aria-controls="games-pane" aria-selected="false">Games</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="competitions-tab" data-bs-toggle="tab"
                                data-bs-target="#competitions-pane" type="button" role="tab"
                                aria-controls="competitions-pane" aria-selected="false">Competitions</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="activitySubTabsContent">

                        @* --- PANE 1: Regular Schedule (Calendar) --- *@
                        <div class="tab-pane fade show active" id="regular-schedule-pane" role="tabpanel"
                            aria-labelledby="regular-schedule-tab" tabindex="0">

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="mb-0">@displayDate.ToString("MMMM yyyy")</h4>
                                <div>
                                    <a asp-action="Activity" asp-controller="Community"
                                        asp-route-communityId="@currentCommunityId" asp-route-year="@prevMonthDate.Year"
                                        asp-route-month="@prevMonthDate.Month"
                                        class="btn btn-sm btn-outline-secondary">&lt;</a>

                                    <a asp-action="Activity" asp-controller="Community"
                                        asp-route-communityId="@currentCommunityId" asp-route-year="@nextMonthDate.Year"
                                        asp-route-month="@nextMonthDate.Month"
                                        class="btn btn-sm btn-outline-secondary">&gt;</a>
                                </div>
                            </div>

                            @* --- UPDATED LEGEND --- *@
                            <div class="d-flex justify-content-start align-items-center mb-2 small">
                                <span class="me-2"><span class="cal-legend cal-event-game"></span> Game</span>
                                <span class="me-2"><span class="cal-legend cal-event-comp"></span> Competition</span>
                                <span class="me-2"><span class="cal-legend cal-event-pending"></span> Pending
                                    Setup</span>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-bordered calendar-table" style="table-layout: fixed;">
                                    <thead class="table-light">
                                        <tr class="text-center">
                                            <th>Mon</th>
                                            <th>Tue</th>
                                            <th>Wed</th>
                                            <th>Thu</th>
                                            <th>Fri</th>
                                            <th>Sat</th>
                                            <th>Sun</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{
                                            int startOffset = (int)firstDayOfMonth.DayOfWeek;
                                            startOffset = (startOffset == 0) ? 6 : startOffset - 1; // Mon=0..Sun=6
                                            var dayCounter = 1;
                                        }

                                        @for (int w = 0; w < 6; w++) // Max 6 weeks
                                        {
                                            <tr>
                                                @for (int d = 0; d < 7; d++) // 7 days
                                                {
                                                    if (w == 0 && d < startOffset || dayCounter > daysInMonth)
                                                    {
                                                        <td class="calendar-day other-month"></td>
                                                        // Empty
                                                    }
                                                    else
                                                    {
                                                        var day = dayCounter;
                                                        var isToday = (displayYear == today.Year && displayMonth == today.Month &&
                                                        day == today.Day);

                                                        <td class="calendar-day @(isToday ? "today" : "")">
                                                            <strong class="day-number">@day</strong>

                                                            <div class="cal-events-wrapper">
                                                                @if (eventsByDay.TryGetValue(day, out var events))
                                                                {
                                                                    @foreach (var calEvent in events.OrderBy(e => e.StartTime))
                                                                    {
                                                                        @* Link logic: Comps go to CompDetails, others (Games) go to Schedule/Details *@
                                                                        <a asp-controller="@(calEvent.ScheduleType == ScheduleType.Competition ? "Competition" : "Schedule")"
                                                                            asp-action="@(calEvent.ScheduleType == ScheduleType.Competition ? "CompDetails" : "Details")"
                                                                            asp-route-id="@calEvent.ScheduleId"
                                                                            class="cal-event @calEvent.CssClass" title="@calEvent.GameName">
                                                                            @calEvent.StartTime.ToString("hh:mm tt")
                                                                        </a>
                                                                    }
                                                                }
                                                            </div>
                                                        </td>
                                                        dayCounter++;
                                                    }
                                                }
                                            </tr>
                                            if (dayCounter > daysInMonth) { break; }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        @* --- PANE 2: Games (Active/Past) --- *@
                        <div class="tab-pane fade" id="games-pane" role="tabpanel" aria-labelledby="games-tab"
                            tabindex="0">

                            <ul class="nav nav-tabs nav-justified mb-3" id="gamesSubTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="active-games-tab" data-bs-toggle="tab"
                                        data-bs-target="#active-games-pane" type="button" role="tab"
                                        aria-controls="active-games-pane" aria-selected="true">Active</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="past-games-tab" data-bs-toggle="tab"
                                        data-bs-target="#past-games-pane" type="button" role="tab"
                                        aria-controls="past-games-pane" aria-selected="false">Past</button>
                                </li>
                            </ul>

                            <div class="tab-content" id="gamesSubTabsContent">

                                @* --- ACTIVE GAMES (CORRECTED LOGIC) --- *@
                                <div class="tab-pane fade show active" id="active-games-pane" role="tabpanel"
                                    aria-labelledby="active-games-tab" tabindex="0">
                                    @{
                                        var activeGamesByDay = activeGames
                                        .Where(g => g.StartTime.HasValue)
                                        .GroupBy(g => g.StartTime!.Value.Date)
                                        .OrderBy(g => g.Key);
                                    }

                                    @if (!activeGamesByDay.Any())
                                    {
                                        <p class="text-muted col-12">No active games scheduled.</p>
                                    }

                                    @foreach (var dayGroup in activeGamesByDay)
                                    {
                                        <h4 class="mt-5 mb-3" style="border-bottom: 2px solid #eee; padding-bottom: 5px;">
                                            @GetFriendlyDateString(dayGroup.Key)
                                        </h4>
                                        @foreach (var timeGroup in dayGroup.GroupBy(g =>
                                                                            g.StartTime!.Value.TimeOfDay).OrderBy(tg => tg.Key))
                                        {
                                            <h6 class="text-muted mt-3">@timeGroup.First().StartTime!.Value.ToString("hh:mm tt")
                                            </h6>
                                            <div class="row row-cols-1 row-cols-md-2 g-4 mb-3">
                                                @* --- Embedded _GameCard --- *@
                                                @foreach (var game in timeGroup)
                                                {
                                                    <div class="col">
                                                        <div class="card h-100 shadow-sm">
                                                            <div class="card-body d-flex flex-column">
                                                                <h5 class="card-title">@game.GameName</h5>
                                                                @if (game.EventTag.HasValue && game.EventTag != EventTag.None)
                                                                {
                                                                    <span
                                                                        class="badge bg-primary mb-2 align-self-start">@game.EventTag.ToString()</span>
                                                                }
                                                                <p class="card-text mb-1 small"><i
                                                                        class="bi bi-geo-alt-fill me-1"></i> @game.Location</p>
                                                                <p class="card-text mb-1 small">
                                                                    <i class="bi bi-calendar-event me-1"></i>
                                                                    @if (game.StartTime.HasValue)
                                                                    {
                                                                        @* This is a OneOff, so just show the date *@
                                                                        <span>@game.StartTime.Value.ToString("ddd, MMM d, H:mm")</span>
                                                                    }
                                                                </p>
                                                                <p class="card-text small"><i class="bi bi-people-fill me-1"></i>
                                                                    @game.NumPlayer players</p>
                                                                <div class="mt-auto pt-2">
                                                                    <a asp-controller="Schedule" asp-action="Details"
                                                                        asp-route-id="@game.ScheduleId"
                                                                        class="btn btn-sm btn-outline-primary w-100">View
                                                                        Details</a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                @* --- End Embedded _GameCard --- *@
                                            </div>
                                        }
                                    }
                                </div>

                                @* --- PAST GAMES (CORRECTED LOGIC) --- *@
                                <div class="tab-pane fade" id="past-games-pane" role="tabpanel"
                                    aria-labelledby="past-games-tab" tabindex="0">
                                    @{
                                        var pastGamesByDay = pastGames.GroupBy(g => g.StartTime!.Value.Date)
                                        .OrderByDescending(g => g.Key);
                                    }
                                    @if (!pastGamesByDay.Any())
                                    {
                                        <p class="text-muted col-12">No past games found.</p>
                                    }

                                    @foreach (var dayGroup in pastGamesByDay)
                                    {
                                        <h4 class="mt-5 mb-3" style="border-bottom: 2px solid #eee; padding-bottom: 5px;">
                                            @GetFriendlyDateString(dayGroup.Key)
                                        </h4>
                                        @foreach (var timeGroup in dayGroup.GroupBy(g =>
                                                                            g.StartTime!.Value.TimeOfDay).OrderBy(tg => tg.Key))
                                        {
                                            <h6 class="text-muted mt-3">@timeGroup.First().StartTime!.Value.ToString("hh:mm tt")
                                            </h6>
                                            <div class="row row-cols-1 row-cols-md-2 g-4 mb-3" style="opacity: 0.7;">
                                                @* --- Embedded _GameCard --- *@
                                                @foreach (var game in timeGroup)
                                                {
                                                    <div class="col">
                                                        <div class="card h-100 shadow-sm">
                                                            <div class="card-body d-flex flex-column">
                                                                <h5 class="card-title">@game.GameName</h5>
                                                                @if (game.EventTag.HasValue && game.EventTag != EventTag.None)
                                                                {
                                                                    <span
                                                                        class="badge bg-primary mb-2 align-self-start">@game.EventTag.ToString()</span>
                                                                }
                                                                <p class="card-text mb-1 small"><i
                                                                        class="bi bi-geo-alt-fill me-1"></i> @game.Location</p>
                                                                <p class="card-text mb-1 small">
                                                                    <i class="bi bi-calendar-event me-1"></i>
                                                                    @if (game.StartTime.HasValue)
                                                                    {
                                                                        <span>@game.StartTime.Value.ToString("ddd, MMM d, H:mm")</span>
                                                                    }
                                                                </p>
                                                                <p class="card-text small"><i class="bi bi-people-fill me-1"></i>
                                                                    @game.NumPlayer players</p>
                                                                <div class="mt-auto pt-2">
                                                                    <a asp-controller="Schedule" asp-action="Details"
                                                                        asp-route-id="@game.ScheduleId"
                                                                        class="btn btn-sm btn-outline-secondary w-100">View
                                                                        Details</a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                @* --- End Embedded _GameCard --- *@
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>

                        @* --- PANE 3: Competitions (Active/Past) --- *@
                        <div class="tab-pane fade" id="competitions-pane" role="tabpanel"
                            aria-labelledby="competitions-tab" tabindex="0">

                            <ul class="nav nav-tabs nav-justified mb-3" id="competitionsSubTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="active-comps-tab" data-bs-toggle="tab"
                                        data-bs-target="#active-comps-pane" type="button" role="tab"
                                        aria-controls="active-comps-pane" aria-selected="true">Active</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="past-comps-tab" data-bs-toggle="tab"
                                        data-bs-target="#past-comps-pane" type="button" role="tab"
                                        aria-controls="past-comps-pane" aria-selected="false">Past</button>
                                </li>
                            </ul>

                            <div class="tab-content" id="competitionsSubTabsContent">

                                @* --- ACTIVE COMPS (DATE GROUPED) --- *@
                                <div class="tab-pane fade show active" id="active-comps-pane" role="tabpanel"
                                    aria-labelledby="active-comps-tab" tabindex="0">
                                    @{
                                        var activeCompsByDay = activeCompetitions.Where(c => c.StartTime.HasValue)
                                        .GroupBy(c => c.StartTime!.Value.Date)
                                        .OrderBy(c => c.Key);
                                    }
                                    @if (!activeCompsByDay.Any())
                                    {
                                        <p class="text-muted col-12">No active competitions scheduled.</p>
                                    }

                                    @foreach (var dayGroup in activeCompsByDay)
                                    {
                                        <h4 class="mt-5 mb-3" style="border-bottom: 2px solid #eee; padding-bottom: 5px;">
                                            @GetFriendlyDateString(dayGroup.Key)
                                        </h4>
                                        @foreach (var timeGroup in dayGroup.GroupBy(g =>
                                                                            g.StartTime!.Value.TimeOfDay).OrderBy(tg => tg.Key))
                                        {
                                            <h6 class="text-muted mt-3">@timeGroup.First().StartTime!.Value.ToString("hh:mm tt")
                                            </h6>
                                            <div class="row row-cols-1 row-cols-md-2 g-4 mb-3">
                                                @* --- Embedded _CompetitionCard --- *@
                                                @foreach (var comp in timeGroup)
                                                {
                                                    <div class="col">
                                                        <div class="card h-100 shadow-sm">
                                                            <div class="card-body d-flex flex-column">
                                                                <h5 class="card-title">@comp.GameName</h5>
                                                                <p class="card-text mb-1 small"><i
                                                                        class="bi bi-geo-alt-fill me-1"></i> @comp.Location</p>
                                                                <p class="card-text mb-1 small">
                                                                    <i class="bi bi-calendar-event me-1"></i>
                                                                    @if (comp.StartTime.HasValue)
                                                                    {
                                                                        <span>@comp.StartTime.Value.ToString("ddd, MMM d")</span>
                                                                        <small class="text-muted"> (@comp.StartTime.Value.ToString("t")
                                                                            - @comp.EndTime?.ToString("t"))</small>
                                                                    }
                                                                </p>
                                                                <p class="card-text small"><i class="bi bi-trophy-fill me-1"></i>
                                                                    @comp.NumTeam Teams</p>

                                                                @if (comp.Status == ScheduleStatus.PendingSetup)
                                                                {
                                                                    <span class="badge bg-warning text-dark align-self-start mb-2"><i
                                                                            class="bi bi-exclamation-triangle-fill me-1"></i> Pending
                                                                        Match Setup</span>
                                                                    <div
                                                                        class="mt-auto pt-2 d-grid gap-2 d-sm-flex justify-content-sm-between">
                                                                        <a asp-controller="Community" asp-action="SetupMatch"
                                                                            asp-route-id="@comp.ScheduleId"
                                                                            class="btn btn-sm btn-warning mb-1 mb-sm-0">Continue
                                                                            Setup</a>
                                                                        <form asp-controller="Community" asp-action="Publish"
                                                                            asp-route-id="@comp.ScheduleId" method="post"
                                                                            onsubmit="return confirm('Publish this competition? Default format settings will be used and editable after publish')"
                                                                            class="d-inline-block">
                                                                            @Html.AntiForgeryToken()
                                                                            <button type="submit"
                                                                                class="btn btn-sm btn-info w-100">Publish Now</button>
                                                                        </form>
                                                                    </div>
                                                                }
                                                                else
                                                                {
                                                                    <span
                                                                        class="badge bg-success align-self-start mb-2">@comp.Status?.ToString()</span>
                                                                    <div class="mt-auto pt-2">
                                                                        <a asp-controller="Competition" asp-action="CompDetails"
                                                                            asp-route-id="@comp.ScheduleId"
                                                                            class="btn btn-sm btn-outline-primary w-100">View
                                                                            Competition</a>
                                                                    </div>
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                @* --- End Embedded _CompetitionCard --- *@
                                            </div>
                                        }
                                    }
                                </div>

                                @* --- PAST COMPS (DATE GROUPED) --- *@
                                <div class="tab-pane fade" id="past-comps-pane" role="tabpanel"
                                    aria-labelledby="past-comps-tab" tabindex="0">
                                    @{
                                        var pastCompsByDay = pastCompetitions.Where(c => c.StartTime.HasValue)
                                        .GroupBy(c => c.StartTime!.Value.Date)
                                        .OrderByDescending(c => c.Key);
                                    }
                                    @if (!pastCompsByDay.Any())
                                    {
                                        <p class="text-muted col-12">No past competitions found.</p>
                                    }

                                    @foreach (var dayGroup in pastCompsByDay)
                                    {
                                        <h4 class="mt-5 mb-3" style="border-bottom: 2px solid #eee; padding-bottom: 5px;">
                                            @GetFriendlyDateString(dayGroup.Key)
                                        </h4>
                                        @foreach (var timeGroup in dayGroup.GroupBy(g =>
                                                                            g.StartTime!.Value.TimeOfDay).OrderBy(tg => tg.Key))
                                        {
                                            <h6 class="text-muted mt-3">@timeGroup.First().StartTime!.Value.ToString("hh:mm tt")
                                            </h6>
                                            <div class="row row-cols-1 row-cols-md-2 g-4 mb-3" style="opacity: 0.7;">
                                                @* --- Embedded _CompetitionCard --- *@
                                                @foreach (var comp in timeGroup)
                                                {
                                                    <div class="col">
                                                        <div class="card h-100 shadow-sm">
                                                            <div class="card-body d-flex flex-column">
                                                                <h5 class="card-title">@comp.GameName</h5>
                                                                <p class="card-text mb-1 small"><i
                                                                        class="bi bi-geo-alt-fill me-1"></i> @comp.Location</p>
                                                                <p class="card-text mb-1 small">
                                                                    <i class="bi bi-calendar-event me-1"></i>
                                                                    @if (comp.StartTime.HasValue)
                                                                    {
                                                                        <span>@comp.StartTime.Value.ToString("ddd, MMM d")</span>
                                                                        <small class="text-muted"> (@comp.StartTime.Value.ToString("t")
                                                                            - @comp.EndTime?.ToString("t"))</small>
                                                                    }
                                                                </p>
                                                                <p class="card-text small"><i class="bi bi-trophy-fill me-1"></i>
                                                                    @comp.NumTeam Teams</p>

                                                                <span
                                                                    class="badge bg-dark align-self-start mb-2">@comp.Status?.ToString()</span>
                                                                <div class="mt-auto pt-2">
                                                                    <a asp-controller="Competition" asp-action="CompDetails"
                                                                        asp-route-id="@comp.ScheduleId"
                                                                        class="btn btn-sm btn-outline-secondary w-100">View
                                                                        Competition</a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                @* --- End Embedded _CompetitionCard --- *@
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div> @* End Activity Sub-Tabs Content *@
                </div> @* End Activity Tab Pane *@

                @* --- CHAT TAB PANE (Placeholder) --- *@
                <div class="tab-pane fade" id="chat-tab-pane" role="tabpanel" aria-labelledby="chat-tab" tabindex="0">
    <div class="card shadow-sm" style="height: 600px; display: flex; flex-direction: column;">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-chat-dots"></i> Community Chat Room
            </h5>
            <small id="onlineMembersStatus">
                <i class="bi bi-circle-fill text-light"></i> 
                <span id="onlineCount">0</span> members online
            </small>
        </div>
        
        <!-- Chat Messages Area -->
        <div class="card-body overflow-auto" id="chatMessages" style="flex: 1; background-color: #f8f9fa;">
            <div class="text-center py-5 text-muted">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading chat history...</p>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="px-3 py-2" style="display: none; background-color: #f8f9fa; border-top: 1px solid #dee2e6;">
            <small class="text-muted">
                <i class="bi bi-three-dots"></i> Someone is typing...
            </small>
        </div>

        <!-- Chat Input Area -->
        <div class="card-footer bg-white">
            <form id="chatForm" onsubmit="sendCommunityMessage(event); return false;">
                @Html.AntiForgeryToken()
                <div class="input-group">
                    <input type="text" 
                           class="form-control" 
                           id="chatInput" 
                           placeholder="Type your message..." 
                           maxlength="2000"
                           required>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-send-fill"></i> Send
                    </button>
                </div>
                <small class="text-muted">Press Enter to send â€¢ Max 2000 characters</small>
            </form>
        </div>
    </div>
</div>

                @* --- UPDATED MEMBERS TAB PANE (Moved from right column) --- *@
                <div class="tab-pane fade" id="members-tab-pane" role="tabpanel" aria-labelledby="members-tab"
    tabindex="0">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">Community Members</h4>
                <span class="badge bg-success fs-6">@communityMembers.Count members</span>
            </div>

            @if (communityMembers.Any())
            {
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                    @foreach (var member in communityMembers)
                    {
                        <div class="col">
                            <div class="card h-100 shadow-sm member-card">
                                <div class="card-body text-center">
                                    <div class="member-avatar mb-3" 
                                         onclick="showUserProfilePreview(@member.UserId)" 
                                         style="cursor: pointer;"
                                         title="View @member.User?.Username's profile">
                                        @if (!string.IsNullOrEmpty(member.User?.ProfilePicture))
                                        {
                                            <img src="@member.User.ProfilePicture" 
                                                 alt="@member.User.Username"
                                                 class="img-fluid rounded-circle member-profile-pic"
                                                 style="width: 80px; height: 80px; object-fit: cover;">
                                        }
                                        else
                                        {
                                            <div class="bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center member-placeholder"
                                                style="width: 80px; height: 80px;">
                                                <i class="fas fa-user fa-2x"></i>
                                            </div>
                                        }
                                    </div>
                                    <h5 class="card-title mb-1 member-username" 
                                        onclick="showUserProfilePreview(@member.UserId)" 
                                        style="cursor: pointer;"
                                        title="View profile">
                                        @member.User?.Username
                                    </h5>
                                    <p class="card-text">
                                        <span class="badge @(member.CommunityRole == "Admin" ? "bg-warning text-dark" : member.CommunityRole == "Moderator" ? "bg-primary" : "bg-secondary")">
                                            @member.CommunityRole
                                        </span>
                                    </p>
                                    <small class="text-muted">Member since @member.JoinDate.ToString("MMM yyyy")</small>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No members yet</h5>
                    <p class="text-muted">Be the first to join this community!</p>
                </div>
            }
        </div>
    </div>
</div>

            </div> @* End Main Tab Content *@
        </div> @* End Center Column *@

         @* --- UPDATED Right Column (Only Announcements now) --- *@
        <div class="col-lg-3 d-none d-lg-block">
            <div style="position: sticky; top: 80px;">
                @* Announcements Section *@
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-bullhorn me-2"></i>Announcements</span>
                            <span class="badge bg-primary">@announcements.Count</span>
                        </h5>

                        @if (announcements.Any())
                        {
                            <div class="announcements-list" style="max-height: 500px; overflow-y: auto;">
                                @foreach (var announcement in announcements.OrderByDescending(a => a.PostDate).Take(8))
                                {
                                    <div class="announcement-item border-start border-primary ps-3 mb-3">
                                        <h6 class="mb-1">@announcement.Title</h6>
                                        <p class="small text-muted mb-1">@announcement.Content</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">@announcement.Poster?.Username</small>
                                            <small class="text-muted">@announcement.PostDate.ToString("MMM dd")</small>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-bullhorn fa-2x mb-2"></i>
                                <p class="small mb-0">No announcements yet</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

    </div> @* End Row *@
</div> @* End Container *@

@* --- UPDATED CSS Styles for Calendar and New Components --- *@
<style>
    .page-header-activity {
        background: linear-gradient(135deg, #2E8B57 0%, #1E5B32 100%);
        color: white;
        padding: 25px 0;
        border-radius: 0 0 20px 20px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    /* --- UPDATED LEFT SIDEBAR STYLING --- */
    .sidebar-card {
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-radius: 12px;
        overflow: hidden;
    }

    .sidebar-card .card-body {
        padding: 1.5rem;
    }

    .community-profile {
        text-align: center;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #e9ecef;
        margin-bottom: 1.5rem;
    }

    .community-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 1rem;
        border: 3px solid #2E8B57;
    }

    .community-avatar-placeholder {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2E8B57 0%, #1E5B32 100%);
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        border: 3px solid #2E8B57;
    }

    .community-name {
        font-weight: 700;
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
        color: #2c3e50;
    }

    .community-location {
        color: #6c757d;
        font-size: 0.875rem;
        margin-bottom: 1rem;
    }

    .community-stats {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-bottom: 1rem;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-weight: 700;
        font-size: 1.25rem;
        color: #2E8B57;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .community-description {
        color: #6c757d;
        font-size: 0.875rem;
        line-height: 1.5;
        margin-bottom: 1.5rem;
    }

    .create-event-section {
        border-top: 1px solid #e9ecef;
        padding-top: 1.5rem;
    }

    .create-event-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 0.75rem;
    }

    /* --- UPDATED BUTTON STYLING (GREEN) --- */
    .btn-green {
        background-color: #2E8B57;
        border-color: #2E8B57;
        color: white;
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
    }

    .btn-green:hover {
        background-color: #1E5B32;
        border-color: #1E5B32;
        color: white;
    }

    .announcement-item {
        border-left: 3px solid #2E8B57;
        padding-left: 12px;
        margin-bottom: 15px;
    }

    .announcement-item h6 {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .members-list .badge {
        font-size: 0.7rem;
        padding: 0.25em 0.4em;
    }

    .calendar-table {
        border: 1px solid #dee2e6;
    }

    .calendar-day {
        height: 120px;
        vertical-align: top;
        padding: 4px;
        position: relative;
        background-color: #fff;
    }

    .calendar-day.other-month {
        background-color: #f8f9fa;
    }

    .calendar-day.today {
        border: 2px solid #0d6efd;
    }

    .day-number {
        font-weight: bold;
        font-size: 0.9rem;
        color: #6c757d;
    }

    .today .day-number {
        color: #0d6efd;
    }

    .cal-events-wrapper {
        max-height: 90px;
        overflow-y: auto;
        margin-top: 4px;
    }

    .cal-event {
        display: block;
        padding: 2px 5px;
        margin-bottom: 3px;
        border-radius: 4px;
        color: #333;
        text-decoration: none;
        font-size: 0.75rem;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        border: 1px solid transparent;
    }

    .cal-event:hover {
        opacity: 0.8;
    }

    /* --- NEW: Green: All Games (OneOff & Recurring Instances) --- */
    .cal-event-game {
        background-color: #d1e7dd;
        border-color: #a3cfbb;
        color: #0a3622;
    }

    /* Yellow: Competition (Active) */
    .cal-event-comp {
        background-color: #fff3cd;
        border-color: #ffe69c;
        color: #664d03;
    }

    /* Strong Orange: Competition (Pending) */
    .cal-event-pending {
        background-color: #fd7e14;
        border-color: #e85d04;
        color: #ffffff;
    }

    /* Legend CSS */
    .cal-legend {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 3px;
        margin-right: 4px;
        vertical-align: middle;
    }

    /* Member card styling */
    .member-avatar {
        transition: transform 0.2s ease-in-out;
    }

    .member-avatar:hover {
        transform: scale(1.05);
    }

    /* Tab Styling */
    .nav-tabs .nav-link.active {
        color: #2E8B57;
        font-weight: 600;
        border-bottom: 2px solid #2E8B57;
    }

    .nav-pills .nav-link.active {
        background-color: #2E8B57;
        color: white;
    }

    /* Card Styling */
    .card {
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-radius: 12px;
        overflow: hidden;
    }

    .card-title {
        color: #2c3e50;
        font-weight: 600;
    }

    /* Calendar Styling */
    .calendar-table {
        border-radius: 12px;
        overflow: hidden;
    }

    .calendar-day {
        transition: background-color 0.2s ease;
    }

    .calendar-day:hover {
        background-color: #f8f9fa;
    }

    /* Announcements Styling */
    .announcements-list {
        scrollbar-width: thin;
        scrollbar-color: #2E8B57 #f1f1f1;
    }

    .announcements-list::-webkit-scrollbar {
        width: 6px;
    }

    .announcements-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .announcements-list::-webkit-scrollbar-thumb {
        background: #2E8B57;
        border-radius: 10px;
    }

    .announcements-list::-webkit-scrollbar-thumb:hover {
        background: #1E5B32;
    }

    /* Members Styling */
 .member-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.member-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15) !important;
}

.member-avatar {
    transition: transform 0.3s ease;
}

.member-avatar:hover {
    transform: scale(1.1);
}

.member-profile-pic {
    border: 3px solid #2E8B57;
    transition: border-color 0.3s ease, transform 0.3s ease;
}

.member-profile-pic:hover {
    border-color: #1E5B32;
    transform: scale(1.05);
}

.member-placeholder {
    transition: all 0.3s ease;
}

.member-placeholder:hover {
    background: linear-gradient(135deg, #2E8B57 0%, #1E5B32 100%);
    transform: scale(1.05);
}

.member-username {
    transition: color 0.2s ease;
}

.member-username:hover {
    color: #2E8B57;
}
/* Chat Component Styling */
    .chat-message {
    margin-bottom: 15px;
    display: flex;
    align-items: flex-start;
}

.chat-message.own-message {
    flex-direction: row-reverse;
}

.chat-message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 10px;
    flex-shrink: 0;
    border: 2px solid #dee2e6;
}

/* â¬‡ï¸ ADD THIS: Hover effect for avatar */
.chat-message-avatar:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    border-color: #2E8B57;
}

.chat-message-sender {
    font-weight: 600;
    font-size: 14px;
    color: #2E8B57;
    cursor: pointer; /* â¬…ï¸ ADD THIS */
    transition: color 0.2s ease; /* â¬…ï¸ ADD THIS */
}

/* â¬‡ï¸ ADD THIS: Hover effect for sender name */
.chat-message-sender:hover {
    color: #1E5B32;
    text-decoration: underline;
}

.chat-message-content {
    max-width: 70%;
}

.chat-message-header {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    gap: 8px;
}



.chat-message-role {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 12px;
    background-color: #6c757d;
    color: #fff;
}

.chat-message-role.admin {
    background-color: #dc3545;
    color: #fff;
}

.chat-message-role.moderator {
    background-color: #0d6efd;
    color: #fff;
}

.chat-message-time {
    font-size: 11px;
    color: #6c757d;
}

.chat-message-bubble {
    padding: 10px 15px;
    border-radius: 18px;
    background-color: #e9ecef;
    word-wrap: break-word;
    position: relative;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.chat-message.own-message .chat-message-bubble {
    background-color: #2E8B57;
    color: white;
}

.chat-message.own-message .chat-message-header {
    flex-direction: row-reverse;
}

.chat-message.own-message .chat-message-sender {
    color: #2E8B57;
}

.chat-message-delete {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 14px;
    font-weight: bold;
    display: none;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all 0.2s ease;
    z-index: 10;
}

.chat-message:hover .chat-message-delete {
    display: flex;
    align-items: center;
    justify-content: center;
}

.chat-message-delete:hover {
    background: #bb2d3b;
    transform: scale(1.15);
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
}

.chat-message-delete:active {
    transform: scale(0.95);
}

.system-message {
    text-align: center;
    color: #6c757d;
    font-size: 12px;
    margin: 10px 0;
    font-style: italic;
}

#chatMessages {
    scroll-behavior: smooth;
}

#chatMessages::-webkit-scrollbar {
    width: 8px;
}

#chatMessages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

#chatMessages::-webkit-scrollbar-thumb {
    background: #2E8B57;
    border-radius: 10px;
}

#chatMessages::-webkit-scrollbar-thumb:hover {
    background: #1E5B32;
}

.chat-input-form {
    width: 100%;
}

#chatInput {
    border: 2px solid #dee2e6;
    transition: border-color 0.2s ease;
}

#chatInput:focus {
    border-color: #2E8B57;
    box-shadow: 0 0 0 0.2rem rgba(46, 139, 87, 0.25);
}

/* Enable Chat Tab */
#chat-tab.disabled {
    pointer-events: auto !important;
    opacity: 1 !important;
}

</style>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.14/signalr.min.js"></script>
      <script>  
      (function() {
    'use strict';
    
    console.log('ðŸ”µ Community Activity Page Loaded');

    // Get community ID from ViewBag
    const communityId = @(currentCommunityId ?? 0);
    const currentUserId = @(Context.Session.GetInt32("UserId") ?? 0);
    const userRole = '@ViewBag.UserRole';
    
    // Chat state variables
    let communityChatConnection = null;
    let isConnected = false;
    let isChatInitialized = false;
    let hasLoadedHistory = false;

    // ==================== SIGNALR INITIALIZATION ====================
    async function initializeCommunityChatHub() {
        if (communityChatConnection && communityChatConnection.state === signalR.HubConnectionState.Connected) {
            console.log('âœ“ Community Chat already connected');
            return;
        }

        if (communityChatConnection && communityChatConnection.state === signalR.HubConnectionState.Connecting) {
            console.log('â³ Community Chat connection in progress...');
            return;
        }

        try {
            communityChatConnection = new signalR.HubConnectionBuilder()
                .withUrl("/communityChatHub")
                .withAutomaticReconnect()
                .build();

            // Handle incoming messages
            communityChatConnection.on("ReceiveCommunityMessage", (data) => {
                console.log("Community message received:", data);
                appendChatMessage(data);
                
                // Show notification badge if chat tab is not active
                const chatTab = document.getElementById('chat-tab');
                if (chatTab && !chatTab.classList.contains('active')) {
                    showChatNotification();
                }
            });

            // Handle user joined
            communityChatConnection.on("UserJoinedChat", (data) => {
                console.log("User joined chat:", data);
                appendSystemMessage(`${data.username} joined the chat`);
                updateOnlineCount();
            });

            // Handle user left
            communityChatConnection.on("UserLeftChat", (data) => {
                console.log("User left chat:", data);
                updateOnlineCount();
            });

            // Handle join confirmation
            communityChatConnection.on("JoinedCommunityChat", (data) => {
                console.log("Successfully joined community chat:", data);
                isConnected = true;
            });

            // Handle online members count
            communityChatConnection.on("OnlineMembersCount", (data) => {
                console.log("Online members count:", data);
                updateOnlineCountDisplay(data.count);
            });

            // Handle errors
            communityChatConnection.on("Error", (message) => {
                console.error("SignalR Error:", message);
                alert(message);
            });

            await communityChatConnection.start();
            console.log("âœ“ Community Chat SignalR Connected");

        } catch (error) {
            console.error("Community Chat SignalR Connection Error:", error);
        }
    }

    // ==================== CHAT ROOM FUNCTIONS ====================
    async function joinCommunityChatRoom() {
        if (!communityChatConnection || communityChatConnection.state !== signalR.HubConnectionState.Connected) {
            console.log('SignalR not connected, initializing...');
            await initializeCommunityChatHub();
        }

        try {
            await communityChatConnection.invoke("JoinCommunityChat", communityId);
            console.log(`Joined community chat room: ${communityId}`);
            
            // Get online members count
            await communityChatConnection.invoke("GetOnlineMembers", communityId);
        } catch (error) {
            console.error("Error joining community chat:", error);
        }
    }

    async function leaveCommunityChatRoom() {
        if (!communityChatConnection || communityChatConnection.state !== signalR.HubConnectionState.Connected) {
            return;
        }

        try {
            await communityChatConnection.invoke("LeaveCommunityChat", communityId);
            console.log(`Left community chat room: ${communityId}`);
        } catch (error) {
            console.error("Error leaving community chat:", error);
        }
    }

    // Load chat history
    async function loadChatHistory() {
        if (hasLoadedHistory) {
            console.log('Chat history already loaded');
            return;
        }

        try {
            const response = await fetch(`/Communities/GetCommunityChatHistory?communityId=${communityId}&skip=0&take=50`);
            const result = await response.json();

            if (result.success) {
                const messagesContainer = document.getElementById('chatMessages');
                if (!messagesContainer) return;
                
                messagesContainer.innerHTML = '';

                if (result.data.messages.length === 0) {
                    messagesContainer.innerHTML = `
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-chat-dots fs-1"></i>
                            <p class="mt-2">No messages yet. Start the conversation!</p>
                        </div>
                    `;
                } else {
                    result.data.messages.forEach(msg => {
                        appendChatMessage(msg, false);
                    });
                    
                    // Scroll to bottom
                    scrollToBottom();
                }

                hasLoadedHistory = true;
            } else {
                console.error('Error loading chat history:', result.message);
            }
        } catch (error) {
            console.error('Error loading chat history:', error);
            const messagesContainer = document.getElementById('chatMessages');
            if (messagesContainer) {
                messagesContainer.innerHTML = `
                    <div class="text-center py-5 text-danger">
                        <i class="bi bi-exclamation-circle fs-1"></i>
                        <p class="mt-2">Failed to load chat history. Please refresh the page.</p>
                    </div>
                `;
            }
        }
    }

    // Send message
    window.sendCommunityMessage = async function(event) {
        event.preventDefault();
        event.stopPropagation();

        const input = document.getElementById('chatInput');
        if (!input) return;

        const message = input.value.trim();

        if (!message) return;

        if (!communityChatConnection || communityChatConnection.state !== signalR.HubConnectionState.Connected) {
            alert('Not connected to chat. Please refresh the page.');
            return;
        }

        try {
            await communityChatConnection.invoke("SendCommunityMessage", communityId, message);
            input.value = '';
        } catch (error) {
            console.error("Error sending message:", error);
            alert("Failed to send message. Please try again.");
        }

        return false;
    };

    // Append chat message to UI
 function appendChatMessage(data, shouldScroll = true) {
    const messagesContainer = document.getElementById('chatMessages');
    if (!messagesContainer) return;

    const placeholder = messagesContainer.querySelector('.text-center.py-5');
    if (placeholder) {
        placeholder.remove();
    }

    const isMine = data.senderId === currentUserId;
    
    const roleBadge = data.isAdmin 
        ? '<span class="chat-message-role admin">ADMIN</span>' 
        : data.isModerator 
            ? '<span class="chat-message-role moderator">MOD</span>' 
            : '';

    const canDelete = isMine || userRole === 'Admin' || userRole === 'Moderator';
    const deleteButton = canDelete
        ? `<button class="chat-message-delete" onclick="deleteCommunityMessage(${data.messageId})" title="Delete message">Ã—</button>`
        : '';

    const messageTime = new Date(data.sentAt).toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });

    const messageHtml = `
        <div class="chat-message ${isMine ? 'own-message' : ''}" data-message-id="${data.messageId}">
            <img src="${data.senderProfilePicture || '/images/profile_image.jpg'}" 
                 class="chat-message-avatar" 
                 alt="${data.senderName}"
                 onclick="showUserProfilePreview(${data.senderId})"
                 style="cursor: pointer;"
                 title="View ${data.senderName}'s profile"
                 onerror="this.src='/images/profile_image.jpg'">
            <div class="chat-message-content">
                <div class="chat-message-header">
                    <span class="chat-message-sender" 
                          onclick="showUserProfilePreview(${data.senderId})" 
                          style="cursor: pointer;"
                          title="View profile">
                        ${escapeHtml(data.senderName)}
                    </span>
                    ${roleBadge}
                    <span class="chat-message-time">${messageTime}</span>
                </div>
                <div class="chat-message-bubble">
                    ${escapeHtml(data.content)}
                    ${deleteButton}
                </div>
            </div>
        </div>
    `;

    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);

    if (shouldScroll) {
        scrollToBottom();
    }
}

    // Append system message
    function appendSystemMessage(message) {
        const messagesContainer = document.getElementById('chatMessages');
        if (!messagesContainer) return;

        const systemMessageHtml = `
            <div class="system-message">
                <i class="bi bi-info-circle"></i> ${escapeHtml(message)}
            </div>
        `;

        messagesContainer.insertAdjacentHTML('beforeend', systemMessageHtml);
        scrollToBottom();
    }

    // Delete message
    window.deleteCommunityMessage = async function(messageId) {
        if (!confirm('Are you sure you want to delete this message?')) return;

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            
            const response = await fetch('/Communities/DeleteCommunityMessage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    messageId: messageId,
                    communityId: communityId,
                    __RequestVerificationToken: token
                })
            });

            const result = await response.json();

            if (result.success) {
                // Remove message from UI with animation
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    messageElement.style.opacity = '0';
                    messageElement.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        messageElement.remove();
                        
                        // â¬‡ï¸ NEW: Show system message if admin/mod deleted someone else's message
                        if (userRole === 'Admin' || userRole === 'Moderator') {
                            appendSystemMessage('A message was deleted by a moderator');
                        }
                    }, 300);
                }
            } else {
                alert(result.message || 'Failed to delete message');
            }
        } catch (error) {
            console.error('Error deleting message:', error);
            alert('An error occurred while deleting the message');
        }
    };

    // Update online count
    async function updateOnlineCount() {
        if (communityChatConnection && communityChatConnection.state === signalR.HubConnectionState.Connected) {
            try {
                await communityChatConnection.invoke("GetOnlineMembers", communityId);
            } catch (error) {
                console.error('Error getting online count:', error);
            }
        }
    }

    // Update online count display
    function updateOnlineCountDisplay(count) {
        const onlineCountEl = document.getElementById('onlineCount');
        if (onlineCountEl) {
            onlineCountEl.textContent = count;
        }
    }

    // Show chat notification
    function showChatNotification() {
        const chatTab = document.getElementById('chat-tab');
        if (chatTab && !chatTab.textContent.includes('ðŸ”´')) {
            chatTab.innerHTML = chatTab.innerHTML + ' <span class="badge bg-danger">New</span>';
        }
    }

    // Clear chat notifications
    function clearChatNotifications() {
        const chatTab = document.getElementById('chat-tab');
        if (chatTab) {
            const badge = chatTab.querySelector('.badge');
            if (badge) {
                badge.remove();
            }
        }
    }

    // Scroll to bottom
    function scrollToBottom() {
        const messagesContainer = document.getElementById('chatMessages');
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }

    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==================== EVENT LISTENERS ====================

    // Handle chat tab shown
    const chatTabButton = document.getElementById('chat-tab');
    if (chatTabButton) {
        // Enable the chat tab (remove disabled class)
        chatTabButton.classList.remove('disabled');
        
        chatTabButton.addEventListener('shown.bs.tab', async function() {
            if (!isChatInitialized && communityId > 0) {
                console.log('ðŸš€ Initializing community chat...');
                
                await initializeCommunityChatHub();
                await loadChatHistory();
                await joinCommunityChatRoom();
                
                isChatInitialized = true;
            }
            
            clearChatNotifications();
            scrollToBottom();
        });
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        if (isConnected) {
            leaveCommunityChatRoom();
        }
    });

    // Tab activation from URL hash (existing code)
    document.addEventListener('DOMContentLoaded', function () {
        var hash = window.location.hash;
        if (hash) {
            // Try to activate main tabs
            var triggerEl = document.querySelector('#communityMainTabs button[data-bs-target="' + hash + '"]');
            if (triggerEl) {
                var tab = new bootstrap.Tab(triggerEl);
                tab.show();
            }

            // Try to activate activity sub-tabs
            var subTriggerEl = document.querySelector('#activitySubTabs button[data-bs-target="' + hash + '"]');
            if (subTriggerEl) {
                var subTab = new bootstrap.Tab(subTriggerEl);
                subTab.show();

                // Also ensure the parent 'Activity' tab is active
                var parentTabTrigger = document.querySelector('#activity-tab');
                if (parentTabTrigger) {
                    var parentTab = new bootstrap.Tab(parentTabTrigger);
                    parentTab.show();
                }
            }
        }
    });

    console.log('âœ“ Community Activity module loaded');
})();
      // Optional: Activate tab from URL hash if needed
        document.addEventListener('DOMContentLoaded', function () {
            var hash = window.location.hash;
            if (hash) {
                // Try to activate main tabs
                var triggerEl = document.querySelector('#communityMainTabs button[data-bs-target="' + hash + '"]');
                if (triggerEl) {
                    var tab = new bootstrap.Tab(triggerEl);
                    tab.show();
                }

                // Try to activate activity sub-tabs
                var subTriggerEl = document.querySelector('#activitySubTabs button[data-bs-target="' + hash + '"]');
                if (subTriggerEl) {
                    var subTab = new bootstrap.Tab(subTriggerEl);
                    subTab.show();

                    // Also ensure the parent 'Activity' tab is active
                    var parentTabTrigger = document.querySelector('#activity-tab');
                    if (parentTabTrigger) {
                        var parentTab = new bootstrap.Tab(parentTabTrigger);
                        parentTab.show();
                    }
                }
            }
        });
    </script>
}