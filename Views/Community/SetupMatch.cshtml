@model CompetitionSetupViewModel
@using PicklePlay.Models
@{
    ViewData["Title"] = "Setup Competition Matches";
}

<section class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 mb-0">Setup â€” @Model.GameName</h2>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="@Url.Action("Activity", "Community")">Cancel</a>
        </div>
    </div>

    <form id="setupForm" asp-action="SetupMatch" asp-route-id="@Model.ScheduleId" method="post" novalidate>
        @Html.AntiForgeryToken()
        <!-- ensure ScheduleId is posted within the form to avoid route/model mismatch -->
        <input asp-for="ScheduleId" type="hidden" value="@(Model?.ScheduleId ?? 0)" />

        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card mb-3 shadow-sm rounded-3">
                    <div class="card-body">
                        <h5 class="mb-3">Competition format</h5>



                        <div class="row g-3">
                            <label asp-for="Format" class="form-label">Format</label>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-primary format-btn active"
                                    data-val="@((int)CompetitionFormat.PoolPlay)">
                                    <i class="bi bi-grid-1x2-fill"></i> Pool play
                                </button>
                                <button type="button" class="btn btn-outline-primary format-btn"
                                    data-val="@((int)CompetitionFormat.Elimination)">
                                    <i class="bi bi-diagram-2-fill"></i> Single Elimination
                                </button>
                                <button type="button" class="btn btn-outline-primary format-btn"
                                    data-val="@((int)CompetitionFormat.RoundRobin)">
                                    <i class="bi bi-arrow-repeat"></i> Round robin
                                </button>
                            </div>
                            <input type="hidden" asp-for="Format" id="FormatHidden" />
                        </div>


                        <div id="poolOptionsCard" class="mt-2" style="display:block;">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label asp-for="NumPool" class="form-label">Pools</label>
                                    <input asp-for="NumPool" type="number" class="form-control" min="1" />
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="WinnersPerPool" class="form-label">Winners per pool</label>
                                    <input asp-for="WinnersPerPool" type="number" class="form-control" min="1" />
                                </div>
                            </div>

                            <div class="mt-3" id="standingBox">
                                <label asp-for="StandingCalculation" class="form-label">Standing method</label>
                                <select asp-for="StandingCalculation" id="standingCalculationSelect" class="form-select"
                                    asp-items="Html.GetEnumSelectList<StandingCalculation>()"></select>
                            </div>

                            <div class="mt-3">
                                <label asp-for="MatchRule" class="form-label">Match rules</label>
                                <textarea asp-for="MatchRule" class="form-control" rows="3"
                                    placeholder="eg: games to 11, win by 2"></textarea>
                            </div>
                        </div>

                        <div id="eliminationCard" class="mt-3" style="display:none;">
                            <h6>Elimination settings</h6>
                            <div class="form-check mb-2">
                                <input asp-for="ThirdPlaceMatch" class="form-check-input" type="checkbox" />
                                <label asp-for="ThirdPlaceMatch" class="form-check-label">
                                    Include 3rd-place match
                                </label>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Match rules</label>
                                <textarea name="ElimMatchRule" class="form-control match-rule-elim" rows="2"
                                    placeholder="e.g. best of 3"></textarea>
                            </div>
                        </div>

                        <div id="roundRobinCard" class="mt-3" style="display:none;">
                            <h6>Round robin options</h6>
                            <div class="form-check mb-2">
                                <input asp-for="DoubleRR" class="form-check-input" type="checkbox" />
                                <label asp-for="DoubleRR" class="form-check-label">Double round-robin</label>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Match rules</label>
                                <textarea name="RRMatchRule" class="form-control match-rule-rr" rows="2"
                                    placeholder="e.g. single match each"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="col-lg-5">
                <div class="sticky-top" style="top:88px;">

                    <div id="pointSystemContainer" class="card mb-3 shadow-sm rounded-3" style="display:none;">
                        <div class="card-header bg-light">
                            <h6 class="mb-0 small fw-bold">Point System Settings</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label small">Win</label>
                                    <input asp-for="StandardWin" class="form-control form-control-sm" type="number" />
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">Loss</label>
                                    <input asp-for="StandardLoss" class="form-control form-control-sm" type="number" />
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">TB Win</label>
                                    <input asp-for="TieBreakWin" class="form-control form-control-sm" type="number" />
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">TB Loss</label>
                                    <input asp-for="TieBreakLoss" class="form-control form-control-sm" type="number" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label small">Draw</label>
                                    <input asp-for="Draw" class="form-control form-control-sm" type="number" />
                                </div>
                            </div>
                            <div class="mt-2 text-muted small">
                                <i class="bi bi-info-circle"></i> Applies when "Win/Loss Points" standing is selected.
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3 shadow-sm rounded-3">
                        <div class="card-body">
                            <h6 class="mb-2">Summary</h6>
                            <dl class="row mb-2">                                
                                <dt class="col-6">Format</dt>
                                <dd id="summaryFormat" class="col-6 text-end"></dd>

                                <div id="summaryPoolGroup">
                                    <div class="row">
                                        <dt class="col-6">Pools</dt>
                                        <dd id="summaryNumPool" class="col-6 text-end">@Model!.NumPool</dd>
                                    </div>
                                    <div class="row">
                                        <dt class="col-6">Winners / pool</dt>
                                        <dd id="summaryWinnersPerPool" class="col-6 text-end">@Model.WinnersPerPool</dd>
                                    </div>
                                </div>

                                <div id="summaryElimGroup" style="display:none;">
                                    <div class="row">
                                        <dt class="col-6">3rd place match</dt>
                                        <dd id="summaryThirdPlace" class="col-6 text-end">No</dd>
                                    </div>
                                </div>

                                <div id="summaryRRGroup" style="display:none;">
                                    <div class="row">
                                        <dt class="col-6">Double RR</dt>
                                        <dd id="summaryDoubleRR" class="col-6 text-end">No</dd>
                                    </div>
                                </div>
                            </dl>

                            <div class="d-grid mt-2">
                                <button type="submit" class="btn btn-success">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</section>

@section Styles {
    <style>
        .form-label.required::after {
            content: " *";
            color: #dc3545;
            margin-left: 2px;
        }

        .format-btn.active {
            background: linear-gradient(90deg, #0d6efd, #0dcaf0);
            color: #fff;
            box-shadow: 0 8px 28px rgba(13, 110, 253, 0.15);
            border: 0;
        }

        .sticky-top {
            position: sticky;
            /* Standard sticky top offset handled inline, but ensures z-index if needed */
            z-index: 1000;
        }
    </style>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            // --- 1. Definitions ---
            const FORMAT_LABELS = { "0": "Pool Play", "1": "Single Elimination", "2": "Round Robin" };
            // Enum values from C# (rendered as integers)
            const ENUM_POOL = '@((int)CompetitionFormat.PoolPlay)';
            const ENUM_ELIM = '@((int)CompetitionFormat.Elimination)';
            const ENUM_RR = '@((int)CompetitionFormat.RoundRobin)';
            const ENUM_STANDING_PTS = '@((int)StandingCalculation.WinLossPoints)';

            // Inputs (Left Side) - asp-for generates IDs matching the property name
            const inputs = {
                format: document.getElementById('FormatHidden'),                
                numPool: document.getElementById('NumPool'),
                winners: document.getElementById('WinnersPerPool'),
                thirdPlace: document.getElementById('ThirdPlaceMatch'),
                doubleRR: document.getElementById('DoubleRR'),
                standing: document.getElementById('standingCalculationSelect')
            };

            // Layout Containers (Left Side)
            const containers = {
                pool: document.getElementById('poolOptionsCard'),
                elim: document.getElementById('eliminationCard'),
                rr: document.getElementById('roundRobinCard'),
                pointsLeft: document.getElementById('pointsCardInline') // Kept if you still have the inline one
            };

            // Summary Elements (Right Side)
            const summary = {
                format: document.getElementById('summaryFormat'),
                numPool: document.getElementById('summaryNumPool'),
                winners: document.getElementById('summaryWinnersPerPool'),
                thirdPlace: document.getElementById('summaryThirdPlace'),
                doubleRR: document.getElementById('summaryDoubleRR'),
                // Group containers to hide/show rows in summary
                poolGroup: document.getElementById('summaryPoolGroup'),
                elimGroup: document.getElementById('summaryElimGroup'),
                rrGroup: document.getElementById('summaryRRGroup'),
                // Point system card
                pointsCard: document.getElementById('pointSystemContainer')
            };

            // --- 2. Logic ---

            function updateUI() {
                const currentFormat = inputs.format.value;

                // A. Update Left Side Visibility
                containers.pool.style.display = (currentFormat === ENUM_POOL) ? 'block' : 'none';
                containers.elim.style.display = (currentFormat === ENUM_ELIM) ? 'block' : 'none';
                containers.rr.style.display = (currentFormat === ENUM_RR) ? 'block' : 'none';

                // B. Update Summary Text
                summary.format.textContent = FORMAT_LABELS[currentFormat] || 'Unknown';
                summary.numPool.textContent = inputs.numPool.value || '-';
                summary.winners.textContent = inputs.winners.value || '-';
                summary.thirdPlace.textContent = inputs.thirdPlace.checked ? 'Yes' : 'No';
                summary.doubleRR.textContent = inputs.doubleRR.checked ? 'Yes' : 'No';

                // C. Update Summary Rows Visibility
                summary.poolGroup.style.display = (currentFormat === ENUM_POOL) ? 'block' : 'none';
                summary.elimGroup.style.display = (currentFormat === ENUM_ELIM) ? 'block' : 'none';
                summary.rrGroup.style.display = (currentFormat === ENUM_RR) ? 'block' : 'none';

                // D. Update Point System Visibility
                // Only show point system when:
                //  - current format is Pool Play, AND
                //  - standing select exists AND is visible, AND
                //  - standing value is WinLossPoints
                const isPoolPlay = String(currentFormat) === String(ENUM_POOL);
                let standingVisible = false;
                let standingValue = null;
                if (inputs.standing) {
                    const el = inputs.standing;
                    standingVisible = window.getComputedStyle(el).display !== 'none';
                    standingValue = parseInt(el.value, 10);
                }

                const isWinLossPoints = isPoolPlay && standingVisible && (standingValue === parseInt(ENUM_STANDING_PTS, 10));

                if (summary.pointsCard) summary.pointsCard.style.display = isWinLossPoints ? 'block' : 'none';
                if (containers.pointsLeft) containers.pointsLeft.style.display = isWinLossPoints ? 'block' : 'none';
            }

            // --- 3. Event Listeners ---

            // Format Buttons (Click)
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update Active State
                    document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Set Hidden Value
                    inputs.format.value = btn.dataset.val;

                    // Trigger Update
                    updateUI();
                });
            });

            // Input Fields (Input & Change)
            // We listen to 'input' (typing) and 'change' (checkbox/select commits)
            const allInputs = [inputs.numPool, inputs.winners, inputs.thirdPlace, inputs.doubleRR, inputs.standing];
            allInputs.forEach(el => {
                if (el) {
                    el.addEventListener('input', updateUI);
                    el.addEventListener('change', updateUI);
                }
            });

            // --- 4. Initialization ---
// Find the button that is set as 'active' in the HTML
const activeBtn = document.querySelector('.format-btn.active');

if (activeBtn) {
    // Initialize the hidden input's value to match the active button
    inputs.format.value = activeBtn.dataset.val;
}

// Now call updateUI() to synchronize all elements based on this initial value
updateUI();
        })();
    </script>
}