@* File: Views/Community/CommunityAdminDashboard.cshtml *@
@model PicklePlay.ViewModels.CommunityAdminDashboardViewModel
@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Styles copied for consistency --- */
        :root {
            --primary: #2E8B57;
            --primary-light: #4CAF78;
            --secondary: #FF6B35;
            --accent: #1E5B32;
            --dark: #2D3748;
            --gradient: linear-gradient(135deg, #2E8B57 0%, #1E5B32 100%);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        body {
            background: linear-gradient(135deg, #f0f9f4 0%, #e3f2e9 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        /* --- END Styles copied for consistency --- */

        /* --- DASHBOARD SPECIFIC STYLES --- */
        /* Reduced Header Height & Style like TopUp.cshtml header */
        .page-header-admin {
            background: var(--primary);
            color: white;
            padding: 25px 0;
            border-radius: 0 0 20px 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .main-content-admin {
            margin-top: 0;
        }

        .section-card {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(46, 139, 87, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .section-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .section-card h4 {
            color: var(--primary);
            font-weight: 700;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        /* Statistics Boxes */
        .stat-box {
            background: var(--gradient);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
        }

        .stat-box h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-box p {
            margin: 0;
            opacity: 0.9;
        }

        .role-admin {
            color: var(--primary);
            font-weight: bold;
        }

        .role-member {
            color: #3B82F6;
        }

        .status-active {
            color: #10B981;
        }

        .status-inactive {
            color: #FF6B35;
        }

        .btn-action-group {
            display: flex;
            gap: 5px;
        }

        /* Announcement Items */
        .announcement-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }

        .announcement-item h5 {
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .announcement-item p {
            color: #6B7280;
            margin-bottom: 5px;
        }

        .announcement-item small {
            color: #9CA3AF;
        }

        /* Blocked Users */
        .blocked-user-item {
            background: #FEE2E2;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #EF4444;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6B7280;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #D1D5DB;
        }

        /* Loading States */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--primary);
        }

        /* Image Preview Styles */
        .image-preview-container {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .image-preview-container:hover {
            border-color: var(--primary);
            background: #e9f5ee;
        }

        .image-preview-container.has-image {
            border-style: solid;
            border-color: var(--primary);
        }

        .upload-placeholder {
            color: #6c757d;
            text-align: center;
            padding: 2rem;
        }

        .upload-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        /* File input styling */
        .form-control[type="file"] {
            padding: 0.5rem;
        }

        .form-control[type="file"]::file-selector-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            margin-right: 1rem;
            transition: background-color 0.3s ease;
        }

        .form-control[type="file"]::file-selector-button:hover {
            background: var(--primary-light);
        }
    </style>
}

@* === PAGE HEADER (REDUCED HEIGHT) === *@
<div class="page-header-admin">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="fw-bold"><i class="fas fa-users-cog me-2"></i>@Model.CommunityName</h1>
                <p class="lead mb-0">
                    Admin Dashboard | Type: @Model.CommunityType | Your Role: **@Model.CurrentUserRole**
                </p>
            </div>
            <div class="col-md-4 text-end">
                <a href="@Url.Action("Community", "Home")" class="btn btn-light btn-sm">
                    <i class="fas fa-arrow-left me-2"></i>Back to Communities
                </a>
            </div>
        </div>
    </div>
</div>

@* === MAIN CONTENT === *@
<div class="container main-content-admin">
    <div class="row">

        @* === LEFT COLUMN: Stats, Settings, Announcements (4/12) === *@
        <div class="col-lg-4">

            @* === Community Statistics === *@
            <div class="section-card">
                <h4><i class="fas fa-chart-line me-2"></i>Statistics</h4>
                <div class="stat-box">
                    <h3>@Model.Members.Count</h3>
                    <p>Total Members</p>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);">
                    <h3>@Model.Members.Count(m => m.Role == "Admin")</h3>
                    <p>Admins</p>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);">
                    <h3>@Model.AnnouncementCount</h3>
                    <p>Announcements</p>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);">
                    <h3>@Model.BlockedUserCount</h3>
                    <p>Blocked Users</p>
                </div>
            </div>

            @* === Community Settings === *@
            <div class="section-card">
                <h4><i class="fas fa-cog me-2"></i>Community Settings</h4>

                @* Profile Image Section *@
                <div class="mb-4">
                    <label class="form-label fw-bold">Community Profile Picture</label>
                    <div class="d-flex align-items-start gap-3">
                        @* Current Image Preview *@
                        <div class="text-center">
                            <div id="currentImagePreview" class="border rounded p-2 mb-2"
                                style="width: 120px; height: 120px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                @if (!string.IsNullOrEmpty(Model.CommunityPic))
                                {
                                    <img id="profileImagePreview" src="@Model.CommunityPic" alt="Community Profile"
                                        class="img-fluid rounded"
                                        style="max-width: 100%; max-height: 100%; object-fit: cover;">
                                }
                                else
                                {
                                    <div class="text-muted">
                                        <i class="fas fa-users fa-2x"></i>
                                        <div class="small mt-1">No Image</div>
                                    </div>
                                }
                            </div>
                            <small class="text-muted">Current Image</small>
                        </div>

                        @* Upload Controls *@
                        <div class="flex-grow-1">
                            <form id="profileImageForm" enctype="multipart/form-data">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="CommunityId" value="@Model.CommunityId" />
                                <input type="hidden" name="CurrentImageUrl" value="@Model.CommunityPic" />

                                <div class="mb-3">
                                    <input type="file" id="profileImageInput" name="ProfileImage" class="form-control"
                                        accept=".jpg,.jpeg,.png,.gif,.bmp">
                                    <div class="form-text">Select JPG, PNG, GIF or BMP (Max 5MB)</div>
                                </div>

                                @* New Image Preview *@
                                <div id="newImagePreview" class="border rounded p-2 mb-2 text-center"
                                    style="width: 120px; height: 120px; background: #f8f9fa; display: none;">
                                    <img id="newImagePreviewImg" src="" alt="New Image Preview"
                                        class="img-fluid rounded"
                                        style="max-width: 100%; max-height: 100%; object-fit: cover;">
                                </div>

                                <div class="btn-group w-100">
                                    <button type="submit" class="btn btn-success btn-sm" id="saveImageBtn">
                                        <i class="fas fa-save me-1"></i>Save Image
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm" id="removeImageBtn"
                                        @(string.IsNullOrEmpty(Model.CommunityPic) ? "disabled" : "")>
                                        <i class="fas fa-trash me-1"></i>Remove
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <hr>

                @* Privacy Settings Section *@
                <div class="mb-3">
                    <label class="form-label fw-bold">Privacy Settings</label>
                    <form id="privacySettingsForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="CommunityId" value="@Model.CommunityId" />

                        <div class="mb-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="CommunityType" id="publicCommunity"
                                    value="Public" @(Model.CommunityType == "Public" ? "checked" : "")>
                                <label class="form-check-label" for="publicCommunity">
                                    <i class="fas fa-globe me-1"></i>Public
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="CommunityType" id="privateCommunity"
                                    value="Private" @(Model.CommunityType == "Private" ? "checked" : "")>
                                <label class="form-check-label" for="privateCommunity">
                                    <i class="fas fa-lock me-1"></i>Private
                                </label>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>@(Model.CommunityType == "Public" ? "Public" : "Private") Community:</strong>
                            @if (Model.CommunityType == "Public")
                            {
                                <span>Anyone can view and join this community.</span>
                            }
                            else
                            {
                                <span>Users must request to join and be approved by admins.</span>
                            }
                        </div>

                        <button type="submit" class="btn btn-success w-100" id="savePrivacyBtn">
                            <i class="fas fa-save me-2"></i>Update Privacy Settings
                        </button>
                    </form>
                </div>

                <hr>

                @* Invite Members & Delete Community Section *@
                <div class="d-grid mb-3">
                    <button class="btn btn-outline-success" onclick="openInviteModal(@Model.CommunityId)">
                        <i class="fas fa-user-plus me-2"></i>Invite Members
                    </button>

                    @* Delete Community Button - No need for role check since only admins can access this page *@
                    <button class="btn btn-danger mt-2" id="deleteCommunityBtn" data-bs-toggle="modal"
                        data-bs-target="#deleteCommunityModal">
                        <i class="fas fa-trash-alt me-2"></i>Delete Community
                    </button>
                </div>



                @* === Announcement Dashboard === *@
                <div class="section-card">
                    <h4><i class="fas fa-bullhorn me-2"></i>New Announcement</h4>
                    <form id="createAnnouncementForm" method="post"
                        action="@Url.Action("CreateAnnouncement", "Communities")">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="CommunityId" value="@Model.CommunityId" />

                        <div class="mb-3">
                            <label for="announcementTitle" class="form-label">Title *</label>
                            <input type="text" id="announcementTitle" name="Title" class="form-control"
                                placeholder="Today's Game is ON!" required maxlength="255">
                            <div class="invalid-feedback">Please provide a title for the announcement.</div>
                        </div>
                        <div class="mb-3">
                            <label for="announcementBody" class="form-label">Details *</label>
                            <textarea id="announcementBody" name="Content" class="form-control" rows="3"
                                placeholder="Time and court changes..." required></textarea>
                            <div class="invalid-feedback">Please provide announcement content.</div>
                        </div>
                        <div class="mb-3">
                            <label for="announcementExpiry" class="form-label">Expiry Date (Optional)</label>
                            <input type="datetime-local" id="announcementExpiry" name="ExpiryDate" class="form-control">
                            <small class="form-text text-muted">Leave empty if the announcement should not expire
                                automatically.</small>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="submitAnnouncementBtn">
                            <i class="fas fa-paper-plane me-2"></i>Post Announcement
                        </button>
                    </form>
                </div>
            </div> @* Closing tag for left column *@
        </div>
        @* === RIGHT COLUMN: Join Requests + Member List + Announcements + Blocked (8/12) === *@
        <div class="col-lg-8">

            @* === Conditional: Join Request List (Above Member List) === *@
            @if (!string.IsNullOrEmpty(Model.CommunityType) && Model.CommunityType.Equals("Private",
                        StringComparison.OrdinalIgnoreCase))
            {
                <div class="section-card">
                    <h4>
                        <i class="fas fa-hand-paper me-2"></i>New Join Requests
                        <span class="badge bg-danger ms-2">@Model.JoinRequests.Count</span>
                    </h4>

                    @if (Model.JoinRequests.Any())
                    {
                        <div class="table-responsive" style="overflow: visible;">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Requested</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var request in Model.JoinRequests)
                                    {
                                        <tr>
                                            <td>@request.Username</td>
                                            <td>@request.RequestedDate.ToString("yyyy-MM-dd")</td>
                                            <td class="text-end">
                                                <div class="btn-action-group justify-content-end">
                                                    <button class="btn btn-sm btn-success"
                                                        onclick="acceptRequest(@request.RequestId)"><i class="fas fa-check"></i>
                                                        Accept</button>
                                                    <button class="btn btn-sm btn-danger"
                                                        onclick="rejectRequest(@request.RequestId)"><i class="fas fa-times"></i>
                                                        Reject</button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No pending join requests at this time.</p>
                    }
                </div>
            }

            @* === Member Management Section (Below Requests) === *@
<div class="section-card">
    <h4>
        <span><i class="fas fa-users-cog me-2"></i>Member Management</span>
        <span class="badge bg-secondary ms-2">Active: @Model.Members.Count(m => m.Status == "Active")</span>
    </h4>

    <div class="table-responsive" style="overflow: visible;">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody id="memberTableBody">
                @if (Model.Members?.Any(m => m.Status == "Active") == true)
                {
                    @foreach (var member in Model.Members.Where(m => m.Status == "Active"))
                    {
                        var roleClass = member.Role == "Admin" ? "role-admin" : "role-member";
                        var isCommunityCreator = member.UserId == Model.CreatedByUserId;

                        <tr>
                            <td>
                                @member.UserName
                                @if (isCommunityCreator)
                                {
                                    <span class="badge bg-primary ms-1">Creator</span>
                                }
                            </td>
                            <td><span class="@roleClass">@member.Role</span></td>
                            <td><span class="status-active">Active</span></td>
                            <td>@member.JoinDate.ToString("MMM d, yyyy, hh:mm tt")</td>

                            <td class="text-end">
                                @if (!isCommunityCreator) @* Only show actions for non-creators *@
                                {
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-secondary dropdown-toggle" type="button"
                                            data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
                                            Manage
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            @if (member.Role == "Member")
                                            {
                                                @* For Members: Show Make Admin, Remove, Block *@
                                                <li>
                                                    <a class="dropdown-item text-primary" href="#"
                                                        onclick="assignRole(@member.UserId, 'Admin','@member.UserName')">
                                                        <i class="fas fa-crown me-2"></i>Make Admin
                                                    </a>
                                                </li>
                                                <li>
                                                    <hr class="dropdown-divider" />
                                                </li>
                                                <li>
                                                    <a class="dropdown-item text-danger" href="#"
                                                        onclick="kickMember(@member.UserId, '@member.UserName')">
                                                        <i class="fas fa-user-minus me-2"></i>Remove Member
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item text-danger" href="#"
                                                        onclick="blockMember(@member.UserId, '@member.UserName')">
                                                        <i class="fas fa-ban me-2"></i>Block/Ban
                                                    </a>
                                                </li>
                                            }
                                            else if (member.Role == "Admin")
                                            {
                                                @* For Admins: Show ONLY Demote to Member *@
                                                var isCurrentUser = member.UserId == Model.CurrentUserId;
                                                <li>
                                                    @if (isCurrentUser)
                                                    {
                                                        <a class="dropdown-item text-info disabled" href="#" title="You cannot demote yourself.">
                                                            <i class="fas fa-user-tag me-2"></i>Demote to Member
                                                        </a>
                                                    }
                                                    else
                                                    {
                                                        <a class="dropdown-item text-info" href="#" onclick="assignRole(@member.UserId, 'Member', '@member.UserName')">
                                                            <i class="fas fa-user-tag me-2"></i>Demote to Member
                                                        </a>
                                                    }
                                                </li>
                                                @* Remove and Block buttons are HIDDEN for Admins *@
                                            }
                                        </ul>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted">No actions</span>
                                }
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="text-muted">No active members yet.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

            @* === Recent Announcements Section === *@
            <div class="section-card">
                <h4><i class="fas fa-bullhorn me-2"></i>Recent Announcements</h4>

                @if (Model.LatestAnnouncements.Any())
                {
                    <div id="announcementsList">
                        @foreach (var announcement in Model.LatestAnnouncements)
                        {
                            <div class="announcement-item" data-announcement-id="@announcement.Id">
                                <h5>@announcement.Title</h5>
                                <p>@announcement.Content</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small>Posted by: @announcement.PosterName</small>
                                    <small>@announcement.PostDate.ToString("MMM dd, yyyy 'at' hh:mm tt")</small>
                                </div>
                                @if (announcement.PostDate.Date == DateTime.UtcNow.Date)
                                {
                                    <span class="badge bg-success">New</span>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <i class="fas fa-bullhorn"></i>
                        <p>No announcements yet. Create one to get started!</p>
                    </div>
                }
            </div>

            @* === Blocked Users Section === *@
            <div class="section-card">
                <h4>
                    <i class="fas fa-ban me-2"></i>Blocked Users
                    <span class="badge bg-danger">@Model.BlockedUserCount</span>
                </h4>

                @if (Model.BlockedUsers != null && Model.BlockedUsers.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Blocked By</th>
                                    <th>Reason</th>
                                    <th>Date Blocked</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var blockedUser in Model.BlockedUsers)
                                {
                                    <tr>
                                        <td>@blockedUser.UserName</td>
                                        <td>@blockedUser.BlockedByUserName</td>
                                        <td>@(blockedUser.BlockReason ?? "No reason provided")</td>
                                        <td>@blockedUser.BlockDate.ToString("MMM dd, yyyy h:mm tt")</td>
                                        <td class="text-end">
                                            <button class="btn btn-success btn-sm"
                                                onclick="unblockMember(@blockedUser.UserId, '@blockedUser.UserName.Replace("'", "\\'")')"
                                                title="Unblock User">
                                                <i class="fas fa-unlock"></i> Unblock
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <i class="fas fa-ban"></i>
                        <p>No users are currently blocked from this community.</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@* RENDER SHARED INVITE MODAL (reusable) *@
@await Html.PartialAsync("_InviteFriendModal",
viewData: new ViewDataDictionary(ViewData)
{
    ["InviteContext"] = "community",
    ["InviteCommunityId"] = Model.CommunityId
})
@* Include the Delete Community Modal Partial *@
@await Html.PartialAsync("_DeleteCommunityModal", Model)

@section Scripts {
    <script>
        // Utility function to get AntiForgeryToken
        function getAntiForgeryToken() {
            return document.querySelector('input[name="__RequestVerificationToken"]').value;
        }

        // Utility function to format date for display
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'Invalid date';
            }
        }

        // Utility function to check if date is today
        function isToday(dateString) {
            try {
                const date = new Date(dateString);
                const today = new Date();
                return date.toDateString() === today.toDateString();
            } catch (error) {
                return false;
            }
        }

        // Utility function to show alerts
        function showAlert(message, type) {
            // Remove any existing alerts
            const existingAlert = document.querySelector('.alert-dismissible');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const alertHTML = `
                                        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                                            ${message}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                        </div>
                                    `;
            const mainContent = document.querySelector('.main-content-admin .container');
            if (mainContent) {
                mainContent.insertAdjacentHTML('afterbegin', alertHTML);
            }

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alert = document.querySelector('.alert-dismissible');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }

        // Function to update multiple statistics in the left column
        async function updateStatisticsCounts(data) {
            const statBoxes = document.querySelectorAll('.stat-box');
            statBoxes.forEach(box => {
                // Find the <p> tag text to identify which stat box it is
                const p = box.querySelector('p').textContent.trim();
                const h3 = box.querySelector('h3');

                if (p === 'Total Members') {
                    // Update Total Members using Active Count
                    h3.textContent = data.memberCountActive;
                } else if (p === 'Admins') {
                    h3.textContent = data.adminCount;
                } else if (p === 'Announcements') {
                    h3.textContent = data.announcementCount;
                } else if (p === 'Blocked Users') {
                    h3.textContent = data.blockedUserCount;
                }
            });
        }

        // Function to refresh member list data (for Assign/Kick/Block)
        async function refreshMemberData() {
            try {
                console.log('Refreshing member list...');
                const response = await fetch('@Url.Action("GetCommunityAdminData", "Communities")?communityId=@Model.CommunityId');
                const result = await response.json();

                if (result.success && result.data) {
                    const members = result.data.members;
                    const activeMembers = members.filter(m => m.status === "Active");
                    const memberCountActive = result.data.memberCountActive;

                    // 1. Update Active Member Count Badge
                    const activeBadge = document.querySelector('.section-card h4 span.badge.bg-secondary');
                    if (activeBadge) {
                        activeBadge.textContent = `Active: ${memberCountActive}`;
                    }

                    // 2. Update Statistics Counts
                    await updateStatisticsCounts(result.data);

                    // 3. Find the table body using the new ID
                    const tbody = document.getElementById('memberTableBody');
                    if (!tbody) {
                        console.error('Member table body (ID: memberTableBody) not found.');
                        return;
                    }

                    // 4. Clear existing rows
                    tbody.innerHTML = '';

                    // 5. Generate new rows
                    if (activeMembers && activeMembers.length > 0) {
                        const rowsHTML = activeMembers.map(member => {
                            const roleClass = member.role === "Admin" ? "role-admin" : "role-member";
                            const isCommunityCreator = member.userId === @Model.CreatedByUserId;

                            // Build dropdown items
                            let dropdownItems = '';
                            if (!isCommunityCreator) {
                                if (member.role !== "Admin") {
                                    dropdownItems += `
                                                                <li>
                                                                    <a class="dropdown-item text-primary" href="#"
                                                                       onclick="assignRole(${member.userId}, 'Admin', '${member.userName}')">
                                                                        <i class="fas fa-crown me-2"></i>Make Admin
                                                                    </a>
                                                                </li>`;
                                }
                                if (member.role === "Admin") {
                                    dropdownItems += `
                                                                <li>
                                                                    <a class="dropdown-item text-info" href="#"
                                                                       onclick="assignRole(${member.userId}, 'Member', '${member.userName}')">
                                                                        <i class="fas fa-user-tag me-2"></i>Demote to Member
                                                                    </a>
                                                                </li>`;
                                }
                                dropdownItems += `<li><hr class="dropdown-divider" /></li>
                                                                <li>
                                                                    <a class="dropdown-item text-danger" href="#"
                                                                       onclick="kickMember(${member.userId}, '${member.userName}')">
                                                                        <i class="fas fa-user-minus me-2"></i>Remove Member
                                                                    </a>
                                                                </li>
                                                                <li>
                                                                    <a class="dropdown-item text-danger" href="#"
                                                                       onclick="blockMember(${member.userId}, '${member.userName}')">
                                                                        <i class="fas fa-ban me-2"></i>Block/Ban
                                                                    </a>
                                                                </li>`;
                            }

                            const actionsCell = isCommunityCreator ?
                                `<span class="text-muted">No actions</span>` :
                                `<div class="dropdown">
                                                            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" 
                                                                    data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
                                                                Manage
                                                            </button>
                                                            <ul class="dropdown-menu dropdown-menu-end">
                                                                ${dropdownItems}
                                                            </ul>
                                                        </div>`;

                            return `
                                                        <tr>
                                                            <td>
                                                                ${member.userName}
                                                                ${isCommunityCreator ? '<span class="badge bg-primary ms-1">Creator</span>' : ''}
                                                            </td>
                                                            <td><span class="${roleClass}">${member.role}</span></td>
                                                            <td><span class="status-active">Active</span></td>
                                                            <td>${formatDate(member.joinDate)}</td>
                                                            <td class="text-end">
                                                                ${actionsCell}
                                                            </td>
                                                        </tr>
                                                    `;
                        }).join('');

                        tbody.innerHTML = rowsHTML;

                        // 6. Re-initialize Bootstrap dropdowns on the new elements
                        tbody.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(element => {
                            new bootstrap.Dropdown(element);
                        });

                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-muted">No active members yet.</td></tr>';
                    }

                } else {
                    console.error('Failed to fetch updated member data.');
                }
            } catch (error) {
                console.error('Error refreshing member data:', error);
                showAlert('Error refreshing member list.', 'error');
            }
        }

        // Function to refresh ALL community data
        async function refreshAllCommunityData() {
            await refreshMemberData();
            await refreshAnnouncementsList();
            await refreshJoinRequestsList();
            await refreshBlockedUsersList(); // Add this line
        }

        // Function to refresh blocked users list
        async function refreshBlockedUsersList() {
            try {
                const response = await fetch('@Url.Action("GetCommunityAdminData", "Communities")?communityId=@Model.CommunityId');
                const result = await response.json();

                if (result.success && result.data) {
                    const blockedUsers = result.data.blockedUsers || [];
                    const blockedUsersSection = document.querySelector('.section-card h4 i.fa-ban')?.closest('.section-card');
                    if (!blockedUsersSection) return;

                    // Remove existing content
                    const existingTable = blockedUsersSection.querySelector('.table-responsive');
                    const existingEmptyState = blockedUsersSection.querySelector('.empty-state');
                    if (existingTable) existingTable.remove();
                    if (existingEmptyState) existingEmptyState.remove();

                    if (blockedUsers.length > 0) {
                        // Create table HTML
                        const tableHTML = `
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Username</th>
                                                <th>Blocked By</th>
                                                <th>Reason</th>
                                                <th>Date Blocked</th>
                                                <th class="text-end">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="blockedUsersTableBody">
                                            ${blockedUsers.map(blockedUser => `
                                                <tr>
                                                    <td>${blockedUser.userName}</td>
                                                    <td>${blockedUser.blockedByUserName}</td>
                                                    <td>${blockedUser.blockReason || 'No reason provided'}</td>
                                                    <td>${formatDate(blockedUser.blockDate)}</td>
                                                    <td class="text-end">
                                                        <button class="btn btn-success btn-sm" 
                                                                onclick="unblockMember(${blockedUser.userId}, '${blockedUser.userName}')"
                                                                title="Unblock User">
                                                            <i class="fas fa-unlock"></i> Unblock
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `;

                        // Add table after the header
                        const header = blockedUsersSection.querySelector('h4');
                        header.insertAdjacentHTML('afterend', tableHTML);
                    } else {
                        // Show empty state
                        const emptyStateHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-ban"></i>
                                    <p>No users are currently blocked from this community.</p>
                                </div>
                            `;
                        const header = blockedUsersSection.querySelector('h4');
                        header.insertAdjacentHTML('afterend', emptyStateHTML);
                    }

                    // Update the badge count
                    const badge = blockedUsersSection.querySelector('.badge.bg-danger');
                    if (badge) {
                        badge.textContent = blockedUsers.length;
                    }
                }
            } catch (error) {
                console.error('Error refreshing blocked users:', error);
            }
        }

        // Function to refresh join requests list
        async function refreshJoinRequestsList() {
            try {
                const response = await fetch('@Url.Action("GetCommunityAdminData", "Communities")?communityId=@Model.CommunityId');
                const result = await response.json();

                if (result.success && result.data) {
                    const joinRequests = result.data.joinRequests;

                    // Update the join requests section
                    const joinRequestsSection = document.querySelector('.section-card h4 i.fa-hand-paper')?.closest('.section-card');
                    if (!joinRequestsSection) return;

                    const tableBody = joinRequestsSection.querySelector('tbody');
                    if (tableBody) {
                        if (joinRequests && joinRequests.length > 0) {
                            const rowsHTML = joinRequests.map(request => `
                                                    <tr>
                                                        <td>${request.username}</td>
                                                        <td>${formatDate(request.requestedDate)}</td>
                                                        <td class="text-end">
                                                            <div class="btn-action-group justify-content-end">
                                                                <button class="btn btn-sm btn-success" onclick="acceptRequest(${request.requestId})">
                                                                    <i class="fas fa-check"></i> Accept
                                                                </button>
                                                                <button class="btn btn-sm btn-danger" onclick="rejectRequest(${request.requestId})">
                                                                    <i class="fas fa-times"></i> Reject
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `).join('');

                            tableBody.innerHTML = rowsHTML;
                        } else {
                            tableBody.innerHTML = '<tr><td colspan="3" class="text-muted">No pending join requests at this time.</td></tr>';
                        }
                    }

                    // Update the badge count
                    const badge = joinRequestsSection.querySelector('.badge.bg-danger');
                    if (badge) {
                        badge.textContent = joinRequests.length;
                    }
                }
            } catch (error) {
                console.error('Error refreshing join requests:', error);
            }
        }

        // Join request functions
        async function acceptRequest(requestId) {
            if (!confirm('Are you sure you want to accept this join request?')) {
                return;
            }

            try {
                const formData = new FormData();
                formData.append('requestId', requestId);
                formData.append('__RequestVerificationToken', getAntiForgeryToken());

                const response = await fetch('@Url.Action("AcceptJoinRequest", "Communities")', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');
                    // Refresh the entire dashboard to show updated member list and remove the request
                    await refreshAllCommunityData();
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                console.error('Error accepting join request:', error);
                showAlert('An error occurred while accepting the join request.', 'error');
            }
        }

        // Updated rejectRequest function - removes only the rejected row
        async function rejectRequest(requestId) {
            if (!confirm('Are you sure you want to reject this join request?')) {
                return;
            }

            try {
                const formData = new FormData();
                formData.append('requestId', requestId);
                formData.append('__RequestVerificationToken', getAntiForgeryToken());

                const response = await fetch('@Url.Action("RejectJoinRequest", "Communities")', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');

                    // Remove only the rejected row from the table (no full refresh needed)
                    const row = document.querySelector(`tr:has(button[onclick*="rejectRequest(${requestId})"])`);
                    if (row) {
                        row.remove();
                    }

                    // Update the badge count
                    const badge = document.querySelector('.section-card h4 i.fa-hand-paper')?.closest('.section-card')?.querySelector('.badge.bg-danger');
                    if (badge) {
                        const currentCount = parseInt(badge.textContent) || 0;
                        badge.textContent = Math.max(0, currentCount - 1);
                    }

                    // If no more requests, show empty message
                    const tableBody = document.querySelector('.section-card h4 i.fa-hand-paper')?.closest('.section-card')?.querySelector('tbody');
                    if (tableBody && tableBody.querySelectorAll('tr').length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="3" class="text-muted">No pending join requests at this time.</td></tr>';
                    }

                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                console.error('Error rejecting join request:', error);
                showAlert('An error occurred while rejecting the join request.', 'error');
            }
        }

        // Announcement Form Handling
        document.getElementById('createAnnouncementForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const form = e.target;
            const submitBtn = document.getElementById('submitAnnouncementBtn');
            const originalBtnText = submitBtn.innerHTML;

            // Basic client-side validation
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Posting...';
            submitBtn.disabled = true;

            try {
                const formData = new FormData(form);
                // Convert expiry date to proper format if provided
                const expiryDate = document.getElementById('announcementExpiry').value;
                if (expiryDate) {
                    const localDate = new Date(expiryDate);
                    formData.set('ExpiryDate', localDate.toISOString());
                }

                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });
                const result = await response.json();

                if (result.success) {
                    showAlert('Announcement posted successfully!', 'success');
                    // Clear the form fields
                    form.reset();
                    form.classList.remove('was-validated');

                    // Refresh the announcements list immediately
                    await refreshAnnouncementsList();
                    // Update announcement count and other statistics
                    await refreshMemberData();
                } else {
                    showAlert(result.message || 'Failed to post announcement.', 'error');
                }

            } catch (error) {
                console.error('Error posting announcement:', error);
                showAlert('An error occurred while posting the announcement.', 'error');
            } finally {
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            }
        });

        // Function to refresh announcements list
        async function refreshAnnouncementsList() {
            try {
                console.log('Refreshing announcements list...');
                const response = await fetch('@Url.Action("GetCommunityAdminData", "Communities")?communityId=@Model.CommunityId');
                const result = await response.json();

                if (result.success && result.data) {
                    const announcements = result.data.latestAnnouncements;

                    // Find the announcements section using a stable selector
                    const announcementsSection = document.querySelector('.section-card h4 i.fa-bullhorn')?.closest('.section-card');
                    if (!announcementsSection) {
                        console.error('Announcements section not found');
                        return;
                    }

                    // Remove existing content (list or empty state)
                    const existingList = announcementsSection.querySelector('#announcementsList');
                    const existingEmptyState = announcementsSection.querySelector('.empty-state');

                    if (existingList) existingList.remove();
                    if (existingEmptyState) existingEmptyState.remove();

                    if (announcements && announcements.length > 0) {
                        // Create new announcements list
                        const announcementsHTML = announcements.map(announcement => `
                                                    <div class="announcement-item" data-announcement-id="${announcement.id}">
                                                        <h5>${announcement.title}</h5>
                                                        <p>${announcement.content || 'No content available'}</p>
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <small>Posted by: ${announcement.posterName}</small>
                                                            <small>${formatDate(announcement.postDate)}</small>
                                                        </div>
                                                        ${isToday(announcement.postDate) ? '<span class="badge bg-success">New</span>' : ''}
                                                    </div>
                                                `).join('');
                        const newContainer = document.createElement('div');
                        newContainer.id = 'announcementsList';
                        newContainer.innerHTML = announcementsHTML;
                        // Add the new list after the header
                        const header = announcementsSection.querySelector('h4');
                        header.insertAdjacentElement('afterend', newContainer);

                    } else {
                        // Show empty state
                        const emptyStateHTML = `
                                                    <div class="empty-state">
                                                        <i class="fas fa-bullhorn"></i>
                                                        <p>No announcements yet. Create one to get started!</p>
                                                    </div>
                                                `;
                        const header = announcementsSection.querySelector('h4');
                        header.insertAdjacentHTML('afterend', emptyStateHTML);
                    }
                }
            } catch (error) {
                console.error('Error refreshing announcements:', error);
                showAlert('Error refreshing announcements list.', 'error');
            }
        }

        // === MEMBER MANAGEMENT FUNCTIONS ===

        // Assign role function 
        async function assignRole(userId, newRole, userName) {
            if (!confirm(`Are you sure you want to change ${userName}'s role to ${newRole}?`)) {
                return;
            }

            try {
                const response = await fetch('@Url.Action("AssignRole", "Communities")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: JSON.stringify({
                        communityId: @Model.CommunityId,
                        userId: userId,
                        newRole: newRole
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');
                    // Refresh member table and statistics immediately
                    await refreshMemberData();
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                console.error('Error assigning role:', error);
                showAlert('An error occurred while updating the member role.', 'error');
            }
        }

        // Kick member function 
        async function kickMember(userId, userName) {
            if (!confirm(`Are you sure you want to remove ${userName} from the community?`)) {
                return;
            }

            try {
                const response = await fetch('@Url.Action("KickMember", "Communities")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: JSON.stringify({
                        communityId: @Model.CommunityId,
                        userId: userId
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');
                    // Refresh member table and statistics immediately
                    await refreshMemberData();
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                console.error('Error kicking member:', error);
                showAlert('An error occurred while removing the member.', 'error');
            }
        }

        // Block member function
        async function blockMember(userId, userName) {
    try {
        // First check if the target user is an admin
        const response = await fetch('@Url.Action("GetCommunityAdminData", "Communities")?communityId=@Model.CommunityId');
        const result = await response.json();

        if (result.success && result.data) {
            const targetMember = result.data.members.find(m => m.userId === userId && m.status === "Active");
            
            // NEW RULE: Prevent blocking admins with alert
            if (targetMember && targetMember.role === "Admin") {
                showAlert(`Cannot block ${userName} because they are an admin. Please demote them to member first before blocking.`, 'error');
                return;
            }

            // Continue with existing block modal if not admin
            createBlockModal(userId, userName);
        }
    } catch (error) {
        console.error('Error checking member role:', error);
        showAlert('Error checking member information.', 'error');
    }
}

// Keep your existing createBlockModal function, just make sure it's defined
function createBlockModal(userId, userName) {
    // Your existing block modal creation code here
    const modalHTML = `
        <div class="modal fade" id="blockModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Block User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>You are about to block <strong>${userName}</strong>.</p>
                        <div class="mb-3">
                            <label for="blockReason" class="form-label">Reason for blocking (optional):</label>
                            <textarea class="form-control" id="blockReason" rows="3" placeholder="Enter reason..."></textarea>
                        </div>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Warning:</strong> This will remove the user from the community and prevent them from rejoining.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmBlockBtn">Confirm Block</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('blockModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show modal
    const blockModal = new bootstrap.Modal(document.getElementById('blockModal'));
    blockModal.show();

    // Handle confirm button click
    document.getElementById('confirmBlockBtn').addEventListener('click', async function () {
        const blockReason = document.getElementById('blockReason').value;

        try {
            const response = await fetch('@Url.Action("BlockMember", "Communities")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': getAntiForgeryToken()
                },
                body: `communityId=@Model.CommunityId&userId=${userId}&blockReason=${encodeURIComponent(blockReason || '')}`
            });

            const result = await response.json();

            // Hide modal
            blockModal.hide();

            if (result.success) {
                showAlert(result.message, 'success');
                // Refresh ALL data (members, stats, blocked list) from server
                await refreshAllCommunityData();
            } else {
                showAlert(result.message, 'error');
            }
        } catch (error) {
            console.error('Error blocking member:', error);
            showAlert('An error occurred while blocking the member.', 'error');
        }
    });

    // Clean up modal when hidden
    document.getElementById('blockModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

        // Unblock member function
        async function unblockMember(userId, userName) {
            if (!confirm(`Are you sure you want to unblock ${userName}? They will be able to rejoin the community.`)) {
                return;
            }

            try {
                const response = await fetch('@Url.Action("UnblockMember", "Communities")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: `communityId=@Model.CommunityId&userId=${userId}`
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');
                    // Refresh the blocked users list
                    await refreshBlockedUsersList();
                    // Also refresh member data to update counts
                    await refreshMemberData();
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                console.error('Error unblocking member:', error);
                showAlert('An error occurred while unblocking the member.', 'error');
            }
        }

        // Set minimum datetime for expiry date to current time
        document.addEventListener('DOMContentLoaded', function () {
            const expiryInput = document.getElementById('announcementExpiry');
            if (expiryInput) {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                expiryInput.min = now.toISOString().slice(0, 16);
            }

            // Add :contains selector for jQuery-like text search in announcement refresh
            if (!document.querySelectorAll(':contains').length) {
                // Simple :contains implementation for our use case
                document.querySelectorAll = new Proxy(document.querySelectorAll, {
                    apply: function (target, thisArg, args) {
                        if (args[0].includes(':contains(')) {
                            const [selector, text] = args[0].split(':contains(');
                            const cleanText = text.slice(0, -1).trim().replace(/['"]+/g, '');
                            const elements = target.apply(thisArg, [selector.trim() || '*']);

                            return Array.from(elements).filter(el =>
                                el.textContent.includes(cleanText)
                            );
                        }
                        return target.apply(thisArg, args);
                    }
                });
            }
        });
    </script>
}