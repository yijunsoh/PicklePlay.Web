@model PicklePlay.Models.ViewModels.MatchListingViewModel
@using PicklePlay.Data
@using PicklePlay.Models

<style>
    /* Styles are unchanged */
    .match-container { border: 3px solid #dee2e6; border-radius: 0.375rem; margin-bottom: 1rem; background-color: #fff; }
    .status-active { border-color: #198754; }
    .status-progressing { border-color: #ffc107; }
    .status-done { border-color: #6c757d; }
    .status-bye { border-color: #adb5bd; }
    .match-header { background-color: #f8f9fa; padding: 0.75rem 1.25rem; border-bottom: 1px solid #dee2e6; }
    .match-body { padding: 1.25rem; }
    .team-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
    .team-name { font-weight: 500; font-size: 1.1rem; }
    .score-sets-container { display: flex; gap: 5px; flex-wrap: wrap; }
    .score-set-input { width: 45px; text-align: center; padding-left: 2px; padding-right: 2px; }
    .score-set-text { font-size: 1.1rem; font-weight: 500; padding: 0.25rem 0.5rem; }
</style>

@if (!Model.Matches!.Any())
{
    <div class="alert alert-info">
        Matches have not been generated for this competition yet.
    </div>
    return;
}

@foreach (var roundGroup in Model.Matches!.GroupBy(m => m.RoundName).OrderBy(g => g.First().RoundNumber))
{
    <h4 class="mt-4 mb-3">@roundGroup.Key</h4>
    
    foreach (var match in roundGroup.OrderBy(m => m.MatchNumber))
    {
        string statusClass = $"status-{match.Status.ToString().ToLower()}";
        
        <div class="match-container @statusClass">
            <div class="match-header d-flex justify-content-between align-items-center">
                <div>
                    <strong>Match @match.MatchNumber</strong>
                    <small class="text-muted ms-2">
                        @if (Model.IsOrganizer)
                        {
                            <button type="button" class="btn btn-sm btn-link p-0 me-1 edit-match-btn" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#editMatchModal"
                                    data-match-id="@match.MatchId"
                                    data-match-time="@(match.MatchTime.HasValue ? match.MatchTime.Value.ToString("yyyy-MM-ddTHH:mm") : "")"
                                    data-court="@match.Court"
                                    title="Edit Time/Court">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <span>Time: @(match.MatchTime?.ToString("hh:mm tt") ?? "TBD")</span>
                            <span class="ms-2">Court: @(match.Court ?? "TBD")</span>
                        }
                        else
                        {
                            <span>Time: @(match.MatchTime?.ToString("hh:mm tt") ?? "TBD")</span>
                            <span class="ms-2">Court: @(match.Court ?? "TBD")</span>
                        }
                    </small>
                </div>
                <span class="badge bg-@statusClass text-dark">@match.Status</span>
            </div>
            
            <div class="match-body">
                @if (Model.IsOrganizer)
                {
                    <div class="organizer-match-form" data-match-id="@match.MatchId">
                        @{
                            var isDone = match.Status == MatchStatus.Done;
                            var isActive = match.Status == MatchStatus.Active;
                            var isProgressing = match.Status == MatchStatus.Progressing;
                        }

                        <div class="team-row">
                            <span class="team-name">@(match.Team1?.TeamName ?? "TBD")</span>
                            <div class="score-sets-container" data-team-id="1">
                                @if (isProgressing)
                                {
                                    if (!string.IsNullOrEmpty(match.Team1Score)) {
                                        foreach (var score in match.Team1Score.Split(',')) {
                                            <input type="number" class="form-control form-control-sm score-set-input" data-team-score="1" value="@score.Trim()" min="0" />
                                        }
                                    } else {
                                        <input type="number" class="form-control form-control-sm score-set-input" data-team-score="1" placeholder="e.g. 11" min="0" />
                                    }
                                }
                                else if (isDone) {
                                    <span class="score-set-text">@match.Team1Score</span>
                                }
                                @if (match.IsBye) { <span class="badge bg-secondary">BYE</span> }
                            </div>
                        </div>
                        
                        <div class="text-center text-muted my-2">VS</div>
                        
                        <div class="team-row">
                            <span class="team-name">@(match.Team2?.TeamName ?? "TBD")</span>
                            <div class="score-sets-container" data-team-id="2">
                                @if (isProgressing)
                                {
                                    if (!string.IsNullOrEmpty(match.Team2Score)) {
                                        foreach (var score in match.Team2Score.Split(',')) {
                                            <input type="number" class="form-control form-control-sm score-set-input" data-team-score="2" value="@score.Trim()" min="0" />
                                        }
                                    } else {
                                        <input type="number" class="form-control form-control-sm score-set-input" data-team-score="2" placeholder="e.g. 5" min="0" />
                                    }
                                }
                                else if (isDone) {
                                    <span class="score-set-text">@match.Team2Score</span>
                                }
                                @if (match.IsBye) { <span class="badge bg-secondary">BYE</span> }
                            </div>
                        </div>
                        
                        @if (!match.IsBye)
                        {
                            <hr />
                            <div class="d-flex justify-content-between">
                                <div class="btn-group">
                                    @if (isActive)
                                    {
                                        <form asp-action="UpdateMatchStatus" asp-controller="Match" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="MatchId" value="@match.MatchId" />
                                            <input type="hidden" name="Status" value="@MatchStatus.Progressing" />
                                            <button type="submit" class="btn btn-sm btn-outline-secondary" title="Set Status to Progressing">
                                                <i class="bi bi-play-circle"></i> Start
                                            </button>
                                        </form>
                                    }
                                </div>
                                
                                <div class="btn-group">
                                    @if (isDone)
                                    {
                                        <form asp-action="UpdateMatchStatus" asp-controller="Match" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="MatchId" value="@match.MatchId" />
                                            <input type="hidden" name="Status" value="@MatchStatus.Progressing" />
                                            <button type="submit" class="btn btn-sm btn-outline-warning" title="Edit Score">
                                                <i class="bi bi-pencil"></i> Edit Score
                                            </button>
                                        </form>
                                    }

                                    @if (isProgressing)
                                    {
                                        <button type="button" class="btn btn-sm btn-outline-success btn-add-set">
                                            <i class="bi bi-plus"></i> Add Set
                                        </button>
                                        
                                        <form asp-action="UpdateMatch" asp-controller="Match" method="post" class="d-inline save-score-form">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="MatchId" value="@match.MatchId" />
                                            <input type="hidden" class="hidden-team1-score" name="Team1Score" />
                                            <input type="hidden" class="hidden-team2-score" name="Team2Score" />
                                            
                                            <button type="submit" class="btn btn-sm btn-primary btn-save-score">
                                                <i class="bi bi-save"></i> Save Score
                                            </button>
                                        </form>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="team-row">
                        <span class="team-name">@(match.Team1?.TeamName ?? "TBD")</span>
                        
                        @if(match.Status == MatchStatus.Done)
                        {
                            <span class="fs-5 fw-bold">@match.Team1Score</span>
                        }
                    </div>
                    
                    <div class="text-center text-muted my-2">VS</div>
                    
                    <div class="team-row">
                        <span class="team-name">@(match.Team2?.TeamName ?? "TBD")</span>
                        
                        @if(match.Status == MatchStatus.Done)
                        {
                            <span class="fs-5 fw-bold">@match.Team2Score</span>
                        }
                    </div>
                    
                    @if(match.IsBye)
                    {
                         <div class="text-center mt-3">
                             <span class="badge bg-secondary">BYE Round</span>
                         </div>
                    }
                }
            </div>
        </div>
    }
}

<script>
(function() {
    $('.btn-add-set').on('click', function() {
        var $formContainer = $(this).closest('.organizer-match-form');
        var $newSetT1 = $('<input type="number" class="form-control form-control-sm score-set-input" data-team-score="1" min="0" placeholder="0" />');
        var $newSetT2 = $('<input type="number" class="form-control form-control-sm score-set-input" data-team-score="2" min="0" placeholder="0" />');
        $formContainer.find('.score-sets-container[data-team-id="1"]').append($newSetT1);
        $formContainer.find('.score-sets-container[data-team-id="2"]').append($newSetT2);
    });

    $('.save-score-form').on('submit', function(e) {
        e.preventDefault(); 
        var $form = $(this);
        var $formContainer = $form.closest('.organizer-match-form'); 
        var scoresT1 = $formContainer.find('input[data-team-score="1"]').map(function() { return $(this).val() || "0"; }).get().join(',');
        var scoresT2 = $formContainer.find('input[data-team-score="2"]').map(function() { return $(this).val() || "0"; }).get().join(',');
        $form.find('.hidden-team1-score').val(scoresT1);
        $form.find('.hidden-team2-score').val(scoresT2);
        this.submit();
    });
})();
</script>