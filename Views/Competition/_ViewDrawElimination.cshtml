@using PicklePlay.Models.ViewModels
@using PicklePlay.Models
@using System.Text
@model DrawEliminationViewModel
@{
    // --- Determine bracket size (next power of 2) ---
    int bracketSize = 8;
    if (Model.TotalSeeds > 32) bracketSize = 64;
    else if (Model.TotalSeeds > 16) bracketSize = 32;
    else if (Model.TotalSeeds > 8) bracketSize = 16;
    
    // --- Create team lookup dictionary ---
    var teamLookup = Model.Teams.Where(t => t.BracketSeed.HasValue).ToDictionary(t => t.BracketSeed!.Value, t => t);
    
    // --- Standard seeding orders ---
    Dictionary<int, int[]> seeding = new Dictionary<int, int[]>
    {
        { 8, new[] { 1, 8, 4, 5, 3, 6, 2, 7 } },
        { 16, new[] { 1, 16, 8, 9, 5, 12, 4, 13, 6, 11, 3, 14, 7, 10, 2, 15 } },
        { 32, new[] { 1, 32, 17, 16, 9, 24, 25, 8, 5, 28, 21, 12, 13, 20, 
                29, 4, 3, 30, 19, 14, 11, 22, 27, 6, 7, 26, 23, 10, 15, 18, 31, 2 } },
        { 64, new int[64] }
    };
    var seeds = seeding.GetValueOrDefault(bracketSize) ?? new int[bracketSize];
    if (bracketSize == 64 && seeds[0] == 0)
    {
        for(int i = 0; i < 32; i++) { seeds[i*2] = i+1; seeds[i*2+1] = 64-i; }
    }

    // --- Build JSON string manually for bracket data ---
    var teamPairs = new List<string>();
    for (int i = 0; i < seeds.Length; i += 2)
    {
        var team1 = teamLookup.GetValueOrDefault(seeds[i]);
        var team2 = teamLookup.GetValueOrDefault(seeds[i + 1]);
        
        string team1Json;
        if (team1 != null) 
        { 
            var escapedName = team1.TeamName.Replace("\"", "\\\"").Replace("\\", "\\\\");
            team1Json = $"\"{escapedName}\""; 
        }
        else if (seeds[i] <= Model.TotalSeeds) 
        { 
            team1Json = $"\"Seed {seeds[i]}\""; 
        }
        else 
        { 
            team1Json = "\"BYE\""; 
        }
        
        string team2Json;
        if (team2 != null) 
        { 
            var escapedName = team2.TeamName.Replace("\"", "\\\"").Replace("\\", "\\\\");
            team2Json = $"\"{escapedName}\""; 
        }
        else if (seeds[i + 1] <= Model.TotalSeeds) 
        { 
            team2Json = $"\"Seed {seeds[i + 1]}\""; 
        }
        else 
        { 
            team2Json = "\"BYE\""; 
        }

        teamPairs.Add($"[{team1Json},{team2Json}]");
    }
    
    var firstRoundResults = string.Join(",", Enumerable.Repeat("[]", teamPairs.Count));
    string bracketDataJson = $"{{\"teams\":[{string.Join(",", teamPairs)}], \"results\":[[{firstRoundResults}]]}}";
    
    // --- Correct Round Header Logic ---
    int rounds = (int)Math.Log(bracketSize, 2);
    var roundHeaders = new List<string>();
    for (int r = 0; r < rounds; r++)
    {
        int teamsInRound = (int)Math.Pow(2, rounds - r);
        if (teamsInRound == 2) roundHeaders.Add("Final");
        else if (teamsInRound == 4) roundHeaders.Add("Semi-Finals");
        else if (teamsInRound == 8) roundHeaders.Add("Quarter-Finals");
        else roundHeaders.Add("Round of " + teamsInRound);
    }
    
    var jsonOptions = new System.Text.Json.JsonSerializerOptions
    {
        WriteIndented = false
    };
    string roundHeadersJson = System.Text.Json.JsonSerializer.Serialize(roundHeaders, jsonOptions);
}

<style>
    .round-header {
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
        font-size: 1.1rem;
        color: #333;
    }
</style>

<h5 class="mb-3">Published Bracket (@bracketSize Teams)</h5>
<div id="bracketVisual_Published" style="width: 100%; overflow-x: auto; min-height: 400px;"></div>

<!-- Store data in data attributes instead of inline script -->
<div id="bracket-data-holder" 
     data-bracket='@Html.Raw(bracketDataJson)'
     data-headers='@Html.Raw(roundHeadersJson)'
     data-third-place="@Model.HasThirdPlaceMatch.ToString().ToLower()"
     style="display:none;">
</div>

<script>
(function() {
    console.log('_ViewDrawElimination script executing...');
    
    // Get data from data attributes
    var dataHolder = document.getElementById('bracket-data-holder');
    
    if (!dataHolder) {
        console.error('ERROR: bracket-data-holder not found!');
        return;
    }
    
    try {
        var bracketDataStr = dataHolder.getAttribute('data-bracket');
        var headersStr = dataHolder.getAttribute('data-headers');
        var thirdPlaceStr = dataHolder.getAttribute('data-third-place');
        
        console.log('Raw bracket data:', bracketDataStr);
        console.log('Raw headers:', headersStr);
        console.log('Third place:', thirdPlaceStr);
        
        window.publishedBracketData = {
            bracketData: JSON.parse(bracketDataStr),
            roundHeaders: JSON.parse(headersStr),
            hasThirdPlaceMatch: thirdPlaceStr === 'true'
        };
        
        window.publishedBracketDataReady = true;
        
        console.log('Published bracket data set:', window.publishedBracketData);
        console.log('publishedBracketDataReady:', window.publishedBracketDataReady);
        
    } catch (e) {
        console.error('Error parsing bracket data:', e);
        console.error('Stack:', e.stack);
    }
})();
</script>