@using PicklePlay.Models.ViewModels
@using PicklePlay.Models
@using System.Text
@model DrawEliminationViewModel
@{
    // --- *** NEW: DYNAMIC BRACKET SIZE LOGIC *** ---
    int bracketSize;
    if (Model.TotalSeeds <= 8)
    {
        bracketSize = 8;
    }
    else
    {
        // Calculate the next power of 2
        bracketSize = (int)Math.Pow(2, Math.Ceiling(Math.Log(Model.TotalSeeds, 2)));
    }
    // Ensure bracket size doesn't exceed 64 (based on your seeding dictionary)
    if (bracketSize > 64) bracketSize = 64;
    // --- *** END OF NEW LOGIC *** ---
    
    // --- Create team lookup dictionary ---
    var teamLookup = Model.Teams.Where(t => t.BracketSeed.HasValue).ToDictionary(t => t.BracketSeed!.Value, t => t);
    
    // --- Standard seeding orders ---
    Dictionary<int, int[]> seeding = new Dictionary<int, int[]>
    {
        { 8, new[] { 1, 8, 4, 5, 3, 6, 2, 7 } },
        { 16, new[] { 1, 16, 8, 9, 5, 12, 4, 13, 6, 11, 3, 14, 7, 10, 2, 15 } },
        { 32, new[] { 1, 32, 17, 16, 9, 24, 25, 8, 5, 28, 21, 12, 13, 20, 
                29, 4, 3, 30, 19, 14, 11, 22, 27, 6, 7, 26, 23, 10, 15, 18, 31, 2 } },
        { 64, new int[64] }
    };
    var seeds = seeding.GetValueOrDefault(bracketSize) ?? new int[bracketSize];
    if (bracketSize == 64 && seeds[0] == 0)
    {
        for(int i = 0; i < 32; i++) { seeds[i*2] = i+1; seeds[i*2+1] = 64-i; }
    }

    // --- Build JSON string manually for bracket data ---
    var teamPairs = new List<string>();
    for (int i = 0; i < seeds.Length; i += 2)
    {
        var team1 = teamLookup.GetValueOrDefault(seeds[i]);
        var team2 = teamLookup.GetValueOrDefault(seeds[i + 1]);
        
        string team1Json;
        if (team1 != null) 
        { 
            var escapedName = team1.TeamName.Replace("\"", "\\\"").Replace("\\", "\\\\");
            team1Json = $"\"{escapedName}\""; 
        }
        else if (seeds[i] <= Model.TotalSeeds) 
        { 
            team1Json = $"\"Seed {seeds[i]}\""; 
        }
        else 
        { 
            team1Json = "\"BYE\""; 
        }
        
        string team2Json;
        if (team2 != null) 
        { 
            var escapedName = team2.TeamName.Replace("\"", "\\\"").Replace("\\", "\\\\");
            team2Json = $"\"{escapedName}\""; 
        }
        else if (seeds[i + 1] <= Model.TotalSeeds) 
        { 
            team2Json = $"\"Seed {seeds[i + 1]}\""; 
        }
        else 
        { 
            team2Json = "\"BYE\""; 
        }

        teamPairs.Add($"[{team1Json},{team2Json}]");
    }
    
    var firstRoundResults = string.Join(",", Enumerable.Repeat("[]", teamPairs.Count));
    string bracketDataJson = $"{{\"teams\":[{string.Join(",", teamPairs)}], \"results\":[[{firstRoundResults}]]}}";
    
    // --- Correct Round Header Logic ---
    int rounds = (int)Math.Log(bracketSize, 2);
    var roundHeaders = new List<string>();
    for (int r = 0; r < rounds; r++)
    {
        int teamsInRound = (int)Math.Pow(2, rounds - r);
        if (teamsInRound == 2) roundHeaders.Add("Final");
        else if (teamsInRound == 4) roundHeaders.Add("Semi-Finals");
        else if (teamsInRound == 8) roundHeaders.Add("Quarter-Finals");
        else roundHeaders.Add("Round of " + teamsInRound);
    }
    
    var jsonOptions = new System.Text.Json.JsonSerializerOptions
    {
        WriteIndented = false
    };
    string roundHeadersJson = System.Text.Json.JsonSerializer.Serialize(roundHeaders, jsonOptions);
}

<style>
    .round-header {
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
        font-size: 1.1rem;
        color: #333;
    }
    /* --- ADD THIS NEW STYLE --- */
    .bracket-container {
        width: 100%;
        overflow: auto; /* This adds scrollbars if needed */
        min-height: 600px; /* Gives the bracket space */
        border: 1px solid #ddd;
        background-color: #fcfcfc;
    }
</style>

<h5 class="mb-3">Published Bracket (@bracketSize Teams)</h5>
<div id="bracketVisual_Published" style="width: 100%; overflow: auto; min-height: 600px; border: 1px solid #ddd; background-color: #fcfcfc;"></div>

<!-- Third place small panel -->
<div id="thirdPlaceContainer" class="mt-3" style="min-height:56px;"></div>

<!-- Store data in data attributes instead of inline script -->
<div id="bracket-data-holder" 
     data-schedule-id="@Model.ScheduleId"
     data-bracket='@Html.Raw(bracketDataJson)'
     data-headers='@Html.Raw(roundHeadersJson)'
     data-third-place="@Model.HasThirdPlaceMatch.ToString().ToLower()"
     style="display:none;">
</div>

<script>
(function() {
    console.log('_ViewDrawElimination script executing (robust 3rd-place)...');

    var dataHolder = document.getElementById('bracket-data-holder');
    if (!dataHolder) { console.error('ERROR: bracket-data-holder not found!'); return; }

    var scheduleId = dataHolder.getAttribute('data-schedule-id');
    if (!scheduleId) { console.error('ERROR: data-schedule-id not found on bracket-data-holder!'); return; }

    function fetchAndRender() {
        fetch('/Match/GetBracketData?scheduleId=' + scheduleId)
            .then(r => r.json())
            .then(data => {
                console.log('BRACKET API RESPONSE (full):', data);
                renderFull(data);
            })
            .catch(err => console.error('Error fetching bracket:', err));
    }

    function renderFull(response) {
        var container = document.getElementById('bracketVisual_Published');
        if (!container) { console.error('No bracket container'); return; }

        try {
            if (typeof $ !== 'undefined' && typeof $.fn.bracket === 'function') {
                $(container).empty();
                $(container).bracket({
                    init: response.bracketData,
                    teamWidth: 170,
                    scoreWidth: 30,
                    roundMargin: 40,
                    skipConsolationRound: !response.hasThirdPlaceMatch
                });
                console.log('Bracket rendered successfully!');
            } else {
                container.innerHTML = '<pre>' + JSON.stringify(response.bracketData, null, 2) + '</pre>';
            }
        } catch (err) {
            console.error('Bracket plugin failed:', err);
            container.innerHTML = '<div class="alert alert-danger">Could not render bracket. ' + err.message + '</div>';
        }

        // Robust third-place rendering
        var thirdEl = document.getElementById('thirdPlaceContainer');
        if (!thirdEl) {
            console.warn('thirdPlaceContainer not found - creating one');
            thirdEl = document.createElement('div');
            thirdEl.id = 'thirdPlaceContainer';
            container.insertAdjacentElement('afterend', thirdEl);
        }
        thirdEl.style.display = 'block';

        if (response && response.thirdPlace) {
            var tp = response.thirdPlace;
            console.log('thirdPlace payload:', tp);

            // Coerce winnerIndex to number and treat 0 as valid
            var winnerIndex = null;
            if (tp.winnerIndex !== undefined && tp.winnerIndex !== null) {
                var parsed = Number(tp.winnerIndex);
                if (Number.isFinite(parsed)) winnerIndex = parsed;
            }

            // fallback: check result array if present
            if (winnerIndex === null && Array.isArray(tp.result) && tp.result.length === 2) {
                if (tp.result[0] === 1 && tp.result[1] === 0) winnerIndex = 0;
                else if (tp.result[0] === 0 && tp.result[1] === 1) winnerIndex = 1;
            }

            // Determine winner name explicitly so 0 is handled correctly
            var winnerName = null;
            if (winnerIndex === 0) winnerName = tp.team1 || null;
            else if (winnerIndex === 1) winnerName = tp.team2 || null;

            // Build visible UI (always show teams; indicate winner if known)
            var inner = '<div class="card p-2"><strong>3rd Place</strong>' +
                        '<div class="d-flex justify-content-between mt-2"><span>' + (tp.team1 || 'TBD') + '</span>' +
                        '<span>vs</span><span>' + (tp.team2 || 'TBD') + '</span></div>';

            if (winnerName) {
                // Explicit Winner label to avoid styling/visibility issues
                inner += '<div class="mt-2 text-success"><small><strong>Winner: </strong>' + winnerName + '</small></div>';
            } else if (tp.status) {
                inner += '<div class="mt-2 text-muted"><small>Status: ' + tp.status + '</small></div>';
            }

            inner += '</div>';

            thirdEl.innerHTML = inner;
            console.log('Third place rendered. winnerIndex used:', winnerIndex, 'winnerName:', winnerName);
        } else {
            thirdEl.innerHTML = '';
            thirdEl.style.display = 'none';
            console.log('No third-place match to render.');
        }
    }

    // initial + polling
    fetchAndRender();
    var poll = setInterval(fetchAndRender, 5000);
    window.stopBracketPolling = function() { clearInterval(poll); };
})();
</script>