@model Schedule
@using PicklePlay.Models
@using PicklePlay.Models.ViewModels

@{
    ViewData["Title"] = Model.GameName ?? "Competition Details";
    bool setupPending = ViewData["SetupPending"] as bool? ?? false;

    // --- NEW: Get data for Registration Tab ---
    var organizers = Model.Participants.Where(p => p.Role == ParticipantRole.Organizer).ToList();
    var pendingTeams = Model.Teams.Where(t => t.Status == TeamStatus.Pending).ToList();
    var confirmedTeams = Model.Teams.Where(t => t.Status == TeamStatus.Confirmed).ToList();
    
    // --- NEW: Data for "Register Team" button ---
    bool hasUserRegisteredTeam = ViewBag.HasUserRegisteredTeam ?? false;
    int? currentUserId = ViewBag.CurrentUserId as int?;
}

<style>
    .organizer-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 80px;
        margin-right: 15px;
        margin-bottom: 10px;
    }
    .organizer-item img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #0d6efd;
    }
    .organizer-item .player-name {
        font-size: 0.8rem;
        margin-top: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 80px;
        text-align: center;
    }

    .team-card {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
        box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
    }
    .team-header {
        background-color: #f8f9fa;
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid #dee2e6;
    }
    .team-icon {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 50%;
        margin-right: 10px;
    }
    .team-body {
        padding: 1.25rem;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
        gap: 15px;
    }

    /* Copied from Details.cshtml */
    .player-slot, .empty-slot {
        width: 65px;
        height: 65px;
        border-radius: 50%;
        background-color: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        position: relative;
    }
    .player-slot img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #198754;
    }
    .player-slot .player-name {
        display: block;
        font-size: 0.75rem;
        margin-top: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 65px;
    }
    .player-slot-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 10px;
    }
    .empty-slot {
        border: 2px dashed #ced4da;
        cursor: pointer;
    }
    .empty-slot:hover {
        background-color: #e9ecef;
    }
    .empty-slot i {
        font-size: 1.5rem;
        color: #ced4da;
    }
    /* --- NEW STYLES FOR INVITE MODAL --- */
    #invite-search-results {
        max-height: 250px;
        overflow-y: auto;
    }
    .user-search-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        border-radius: 0.25rem;
    }
    .user-search-item:hover {
        background-color: #f8f9fa;
    }
    .user-search-item img {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 10px;
    }
</style>

<div class="container mt-4">
@if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @* --- Header Section --- *@
     <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
        <div>
            <h2>@Model.GameName</h2>
            <p class="text-muted mb-0">@Model.Location</p>
             @if (Model.Status == ScheduleStatus.PendingSetup) {
                 <span class="badge bg-warning text-dark">Pending Setup</span>
             } else {
                 <span class="badge bg-success">@Model.Status?.ToString()</span>
             }
        </div>
        <div>
            <button class="btn btn-outline-secondary"><i class="bi bi-share"></i> Share</button>
             @if (Model.Status == ScheduleStatus.PendingSetup) {
                 <a asp-action="SetupMatch" asp-controller="Community" asp-route-id="@Model.ScheduleId" class="btn btn-warning"><i class="bi bi-pencil-square"></i> Continue Setup</a>
             } else if (currentUserId.HasValue && !hasUserRegisteredTeam) {
                 <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerTeamModal">
                     <i class="bi bi-person-plus"></i> Register Team
                 </button>
             } else if (hasUserRegisteredTeam) {
                 <button class="btn btn-success" disabled><i class="bi bi-check-all"></i> Team Registered</button>
             } else {
                 <a asp-controller="Auth" asp-action="Login" asp-route-returnUrl="@Context.Request.Path" class="btn btn-primary">
                     <i class="bi bi-box-arrow-in-right"></i> Log in to Register
                 </a>
             }

@if (organizers.Any(o => o.UserId == currentUserId))
{
           @* --- UPDATED DROPDOWN --- *@
            <div class="dropdown d-inline-block">
                 <button class="btn btn-secondary dropdown-toggle" type="button" id="compActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Actions
                </button>
                 <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="compActionsDropdown">
                     
                    @* 1. Edit Details Link *@
                    @if (Model.Status == ScheduleStatus.PendingSetup) {
                        <li><a class="dropdown-item" asp-action="EditCompetition" asp-controller="Community" asp-route-id="@Model.ScheduleId"><i class="bi bi-pencil-fill me-2"></i> Edit Draft Details</a></li>
                    } else {
                        <li><a class="dropdown-item" asp-action="EditCompetition" asp-controller="Community" asp-route-id="@Model.ScheduleId"><i class="bi bi-pencil-fill me-2"></i> Edit Details</a></li>
                    }

                    @* 2. NEW: Edit Setup Match Link *@
                    <li>
                        <a class="dropdown-item" asp-action="SetupMatch" asp-controller="Community" asp-route-id="@Model.ScheduleId">
                            <i class="bi bi-gear-fill me-2"></i> Edit Format & Rules
                        </a>
                    </li>

                     <li><a class="dropdown-item disabled" href="#">Manage Teams (Future)</a></li>
                     <li><hr class="dropdown-divider"></li>

                    @* 3. Delete Link (No changes here) *@
                    @if (Model.Status == ScheduleStatus.PendingSetup) {
                        <li><a class="dropdown-item text-danger" asp-action="Delete" asp-controller="Schedule" asp-route-id="@Model.ScheduleId"><i class="bi bi-trash-fill me-2"></i> Delete Draft</a></li>
                    } else {
                        <li><a class="dropdown-item text-danger" asp-action="Delete" asp-controller="Schedule" asp-route-id="@Model.ScheduleId" onclick="return confirm('Are you sure you want to permanently delete this competition? This action cannot be undone.')"><i class="bi bi-trash-fill me-2"></i> Delete Competition</a></li>
                    }
                </ul>
            </div>
            @* --- END UPDATED DROPDOWN --- *@
 }
        </div>
   
 </div>

    @* --- Poster Image (from previous step) --- *@
    @if (!string.IsNullOrEmpty(Model.CompetitionImageUrl))
    {
        <div class="mb-4 text-center">
            <img src="@Url.Content(Model.CompetitionImageUrl)" alt="@Model.GameName Poster" 
                 style="max-width: 100%; height: auto; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" />
        </div>
    }

    @* --- Main Tabs --- *@
    <ul class="nav nav-tabs" id="competitionTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details-tab-pane" type="button" role="tab" aria-controls="details-tab-pane" aria-selected="true">Details</button>
        </li>
       <li class="nav-item" role="presentation">
           <button class="nav-link" id="registration-tab" data-bs-toggle="tab" data-bs-target="#registration-tab-pane" type="button" role="tab" aria-controls="registration-tab-pane" aria-selected="false">Registration</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="match-tab" data-bs-toggle="tab" data-bs-target="#match-tab-pane" type="button" role="tab" aria-controls="match-tab-pane" aria-selected="false">Match</button>
        </li>
         <li class="nav-item" role="presentation">
            <button class="nav-link disabled" id="result-tab" data-bs-toggle="tab" data-bs-target="#result-tab-pane" type="button" role="tab" aria-controls="result-tab-pane" aria-selected="false">Result</button>
        </li>
          <li class="nav-item" role="presentation">
           <button class="nav-link disabled" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat-tab-pane" type="button" role="tab" aria-controls="chat-tab-pane" aria-selected="false">Chat</button>
        </li>
    </ul>

    @* --- Main Tab Content --- *@
    <div class="tab-content" id="competitionTabContent">
        @* --- Details Tab Pane (with null-checks from previous step) --- *@
        <div class="tab-pane fade show active p-3" id="details-tab-pane" role="tabpanel" aria-labelledby="details-tab" tabindex="0">

             @if (setupPending && Model.Competition != null)
             {
                 <div class="alert alert-warning" role="alert">
                    This competition setup is not complete.
                    <a asp-action="SetupMatch" asp-controller="Community" asp-route-id="@Model.ScheduleId" class="alert-link">Continue Setup</a> or <a asp-action="Publish" asp-controller="Community" asp-route-id="@Model.ScheduleId" onclick="event.preventDefault(); document.getElementById('publish-form-@Model.ScheduleId').submit();" class="alert-link">Publish</a> with default settings for **@Model.Competition.Format**.
                 </div>
                 <form id="publish-form-@Model.ScheduleId" asp-controller="Community" asp-action="Publish" asp-route-id="@Model.ScheduleId" method="post" class="d-none"> @Html.AntiForgeryToken() </form>
             }

            <h5>About</h5>
            <p>@Model.Description</p>
            <hr/>
            
            <h5>Schedule & Registration</h5>
            <div class="row">
                 <div class="col-md-6">
                    <p><strong>Start:</strong> @Model.StartTime?.ToString("dd MMM yyyy, hh:mm tt")</p>
                    <p><strong>End:</strong> @Model.EndTime?.ToString("dd MMM yyyy, hh:mm tt")</p>
                    
                    @if (Model.ApproxStartTime.HasValue)
                    {
                        <p><strong>Approx Start:</strong> @Model.ApproxStartTime?.ToString("hh:mm tt")</p>
                    }
                </div>
                <div class="col-md-6">
                    <p><strong>Reg Opens:</strong> @Model.RegOpen?.ToString("dd MMM yyyy, hh:mm tt")</p>
                    <p><strong>Reg Closes:</strong> @Model.RegClose?.ToString("dd MMM yyyy, hh:mm tt")</p>
                    
                    @if (Model.EarlyBirdClose.HasValue)
                    {
                        <p><strong>Early Bird:</strong> @Model.EarlyBirdClose?.ToString("dd MMM yyyy, hh:mm tt")</p>
                    }
                </div>
            </div>
            <hr/>

             <h5>Participation</h5>
            <div class="row">
                <div class="col-md-6">
                     <p><strong>Teams Limit:</strong> @Model.NumTeam</p>
                    <p>
                        <strong>Fee:</strong>
                         @if(Model.FeeType == FeeType.Free) { <span>Free</span> }
                         else if (Model.FeeType == FeeType.PerPerson) { <span>RM @Model.FeeAmount?.ToString("0.00") per Team</span> }
                         else { <span>N/A</span> }
                    </p>
                </div>
                 
                 <div class="col-md-6">
                    <p><strong>Gender:</strong> @(Model.GenderRestriction.HasValue && Model.GenderRestriction != GenderRestriction.None ? Model.GenderRestriction.ToString() : "Any")</p>
                    <p><strong>Age Group:</strong> @(Model.AgeGroupRestriction.HasValue && Model.AgeGroupRestriction != AgeGroupRestriction.Adult ? Model.AgeGroupRestriction.ToString() : "Any")</p>
                    <p><strong>Rank:</strong> @(Model.MinRankRestriction?.ToString("0.00") ?? "Any") - @(Model.MaxRankRestriction?.ToString("0.00") ?? "Any")</p>
                 </div>
             </div>

        </div> @* End Details Tab Pane *@

        <div class="tab-pane fade p-3" id="registration-tab-pane" role="tabpanel" aria-labelledby="registration-tab" tabindex="0">
            
            <ul class="nav nav-pills mb-3" id="registrationSubTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="teams-subtab" data-bs-toggle="tab" data-bs-target="#teams-subtab-pane" type="button" role="tab" aria-controls="teams-subtab-pane" aria-selected="true">
                        Teams (@Model.Teams.Count / @Model.NumTeam)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="staff-subtab" data-bs-toggle="tab" data-bs-target="#staff-subtab-pane" type="button" role="tab" aria-controls="staff-subtab-pane" aria-selected="false">
                        Staff
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="registrationSubTabsContent">
                <div class="tab-pane fade" id="staff-subtab-pane" role="tabpanel" aria-labelledby="staff-subtab" tabindex="0">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Organizers</h5>
                        @if (organizers.Any(o => o.UserId == currentUserId))
                        {
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addStaffModal" disabled>
                                <i class="bi bi-person-plus-fill"></i> Add Staff (Future)
                            </button>
                        }
                    </div>
                    @if (organizers.Any())
                    {
                        <div class="d-flex flex-wrap align-items-center mt-3">
                            @foreach (var p in organizers)
                            {
                                <div class="organizer-item" data-bs-toggle="tooltip" data-bs-placement="top" title="@p.User?.Username">
                                    <img src="@(string.IsNullOrEmpty(p.User?.ProfilePicture) ? "/images/profile_image.jpg" : p.User.ProfilePicture)" alt="Profile"/>
                                    <span class="player-name">@p.User?.Username</span>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No staff listed.</p>
                    }
                </div>

                <div class="tab-pane fade show active" id="teams-subtab-pane" role="tabpanel" aria-labelledby="teams-subtab" tabindex="0">
                    
                    <ul class="nav nav-tabs" id="teamStatusTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="confirmed-teams-tab" data-bs-toggle="tab" data-bs-target="#confirmed-teams-pane" type="button" role="tab" aria-controls="confirmed-teams-pane" aria-selected="true">
                                Confirmed (@confirmedTeams.Count)
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pending-teams-tab" data-bs-toggle="tab" data-bs-target="#pending-teams-pane" type="button" role="tab" aria-controls="pending-teams-pane" aria-selected="false">
                                Pending (@pendingTeams.Count)
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="teamStatusTabsContent">
                        <div class="tab-pane fade" id="pending-teams-pane" role="tabpanel" aria-labelledby="pending-teams-tab" tabindex="0">
                            <div class="pt-3">
                                @if (!pendingTeams.Any())
                                {
                                    <p class="text-muted">No teams pending approval.</p>
                                }
                                @foreach (var team in pendingTeams)
                                {
                                    <div class="team-card">
                                        <div class="team-header d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <img src="@(string.IsNullOrEmpty(team.TeamIconUrl) ? "/images/team_icon.png" : team.TeamIconUrl)" alt="Team Icon" class="team-icon" />
                                                <h5 class="mb-0">@team.TeamName</h5>
                                            </div>
                                            @if (team.CreatedByUserId == currentUserId)
                                            {
                                                <a href="#" class="btn btn-sm btn-outline-secondary edit-team-btn"
                                                   data-bs-toggle="modal"
                                                   data-bs-target="#editTeamModal"
                                                   data-team-id="@team.TeamId"
                                                   data-team-name="@team.TeamName"
                                                   data-team-icon-url="@(string.IsNullOrEmpty(team.TeamIconUrl) ? "/images/team_icon.png" : team.TeamIconUrl)">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                            }
                                        </div>
                                        <div class="team-body">
                                            @foreach (var member in team.TeamMembers)
                                            {
                                                <div class="player-slot-wrapper" data-bs-toggle="tooltip" data-bs-placement="top" title="@member.User?.Username">
                                                    <div class="player-slot">
                                                        <img src="@(string.IsNullOrEmpty(member.User?.ProfilePicture) ? "/images/profile_image.jpg" : member.User.ProfilePicture)" alt="Profile"/>
                                                    </div>
                                                    <span class="player-name">@member.User?.Username</span>
                                                </div>
                                            }
                                            <!-- *** MODIFIED: Invite Slot *** -->
                                            @if (team.CreatedByUserId == currentUserId && team.TeamMembers.Count < 2) // Assuming 2 players max
                                            {
                                                <div class="player-slot-wrapper">
                                                    <div class="empty-slot" 
                                                         data-bs-toggle="modal" 
                                                         data-bs-target="#invitePlayerModal" 
                                                         data-team-id="@team.TeamId"
                                                         title="Invite Player">
                                                        <i class="bi bi-person-plus"></i>
                                                    </div>
                                                    <span class="player-name text-muted">Invite</span>
                                                </div>
                                            }                         
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="tab-pane fade show active" id="confirmed-teams-pane" role="tabpanel" aria-labelledby="confirmed-teams-tab" tabindex="0">
                            <div class="pt-3">
                                @if (!confirmedTeams.Any())
                                {
                                    <p class="text-muted">No teams confirmed yet.</p>
                                }
                                @foreach (var team in confirmedTeams)
                                {
                                    <div class="team-card">
                                        <div class="team-header d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <img src="@(string.IsNullOrEmpty(team.TeamIconUrl) ? "/images/team_icon.png" : team.TeamIconUrl)" alt="Team Icon" class="team-icon" />
                                                <h5 class="mb-0">@team.TeamName</h5>
                                            </div>
                                            @if (team.CreatedByUserId == currentUserId)
                                            {
                                                <a href="#" class="btn btn-sm btn-outline-secondary edit-team-btn"
                                                   data-bs-toggle="modal"
                                                   data-bs-target="#editTeamModal"
                                                   data-team-id="@team.TeamId"
                                                   data-team-name="@team.TeamName"
                                                   data-team-icon-url="@(string.IsNullOrEmpty(team.TeamIconUrl) ? "/images/team_icon.png" : team.TeamIconUrl)">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                            }
                                        </div>
                                        <div class="team-body">
                                            @foreach (var member in team.TeamMembers)
                                            {
                                                <div class="player-slot-wrapper" data-bs-toggle="tooltip" data-bs-placement="top" title="@member.User?.Username">
                                                    <div class="player-slot">
                                                        <img src="@(string.IsNullOrEmpty(member.User?.ProfilePicture) ? "/images/profile_image.jpg" : member.User.ProfilePicture)" alt="Profile"/>
                                                    </div>
                                                    <span class="player-name">@member.User?.Username</span>
                                                </div>
                                            }
                                            <!-- *** MODIFIED: Invite Slot (for confirmed teams) *** -->
                                            @if (team.CreatedByUserId == currentUserId && team.TeamMembers.Count < 2)
                                            {
                                                <div class="player-slot-wrapper">
                                                    <div class="empty-slot" 
                                                         data-bs-toggle="modal" 
                                                         data-bs-target="#invitePlayerModal" 
                                                         data-team-id="@team.TeamId"
                                                         title="Invite Player">
                                                        <i class="bi bi-person-plus"></i>
                                                    </div>
                                                    <span class="player-name text-muted">Invite</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* --- Match Tab Pane --- *@
        <div class="tab-pane fade p-3" id="match-tab-pane" role="tabpanel" aria-labelledby="match-tab" tabindex="0">

             @if (setupPending)
             {
                 <div class="alert alert-warning" role="alert">
                    Match setup cannot be completed until the initial competition setup is saved.
                    <a asp-action="SetupMatch" asp-controller="Community" asp-route-id="@Model.ScheduleId" class="alert-link">Go to Setup</a>.
                 </div>
             }
             else if (Model.Competition == null)
             {
                  <div class="alert alert-danger" role="alert">
                    Error: Competition details are missing.
                    Cannot display match information.
                 </div>
             }
             else
             {
                @* --- Nested Match Tabs --- *@
                 <ul class="nav nav-pills mb-3" id="matchSubTabs" role="tablist">
             
               <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="format-subtab" data-bs-toggle="tab" data-bs-target="#format-subtab-pane" type="button" role="tab" aria-controls="format-subtab-pane" aria-selected="true">Format</button>
                    </li>
                    <li class="nav-item" role="presentation">
                 <button class="nav-link disabled" id="listing-subtab" data-bs-toggle="tab" data-bs-target="#listing-subtab-pane" type="button" role="tab" aria-controls="listing-subtab-pane" aria-selected="false">Listing</button>
                    </li>
                     <li class="nav-item" role="presentation">
                        <button class="nav-link disabled" id="standing-subtab" data-bs-toggle="tab" data-bs-target="#standing-subtab-pane" type="button" role="tab" aria-controls="standing-subtab-pane" aria-selected="false">Standing</button>
                     </li>
                </ul>

                <div class="tab-content" id="matchSubTabsContent">
                    @* --- Format Sub-Tab Pane --- *@
                    <div class="tab-pane fade show active" id="format-subtab-pane" role="tabpanel" 
 aria-labelledby="format-subtab" tabindex="0">
                        <h5>Format & Rules</h5>
                        <div class="row">
                            <div class="col-md-6">
                             <p><strong>Format:</strong> @Model.Competition.Format.ToString()</p>
                                @if (Model.Competition.Format == CompetitionFormat.PoolPlay)
                                {
                                    <p><strong>Pools:</strong> @Model.Competition.NumPool</p>
                                    <p><strong>Winners/Pool:</strong> @Model.Competition.WinnersPerPool</p>
                                    <p><strong>Standings:</strong> @Model.Competition.StandingCalculation.ToString()</p>
                                    @if (Model.Competition.StandingCalculation == StandingCalculation.WinLossPoints)
                                    {
                                        <h6>Point System</h6>
                                         <ul>
                                            <li>Standard Win: @Model.Competition.StandardWin pts</li>
                                            <li>Standard Loss: @Model.Competition.StandardLoss pts</li>
                                            <li>Tie-Break Win: @Model.Competition.TieBreakWin pts</li>
                                            <li>Tie-Break Loss: @Model.Competition.TieBreakLoss pts</li>
                                            <li>Draw: @Model.Competition.Draw pts</li>
                                        </ul>
                                    }
                                }
                                @if (Model.Competition.Format == CompetitionFormat.Elimination)
                                {
                                    <p><strong>3rd Place Match:</strong> @(Model.Competition.ThirdPlaceMatch ? "Yes" : "No")</p>
                                }
                                @if (Model.Competition.Format == CompetitionFormat.RoundRobin)
                                {
                                    <p><strong>Double Round:</strong> @(Model.Competition.DoublePool ? "Yes" : "No")</p>
                                }
                            </div>
                            <div class="col-md-6">
                                @if (!string.IsNullOrEmpty(Model.Competition.MatchRule))
                                {
                                     <p><strong>Match Rules:</strong></p>
                                    <p style="white-space: pre-wrap;">@Model.Competition.MatchRule</p> 
                                }
                            </div>
                        </div>
                    </div> @* End Format Sub-Tab Pane *@

                    @* --- Listing Sub-Tab Pane --- *@
                    <div class="tab-pane fade" id="listing-subtab-pane" role="tabpanel" aria-labelledby="listing-subtab" tabindex="0">
                        <h5>Match Listing</h5>
                        <p>Match listing feature coming soon.</p>
                    </div>

                    @* --- Standing Sub-Tab Pane --- *@
                     <div class="tab-pane fade" id="standing-subtab-pane" role="tabpanel" aria-labelledby="standing-subtab" tabindex="0">
                        <h5>Standings</h5>
                         <p>Standings feature coming soon.</p>
                     </div>
                </div> @* End Nested Tab Content *@
             } @* End else block for setupPending / Competition null check *@
        </div> @* End Match Tab Pane *@


        @* --- Other Main Tab Panes (Placeholders) --- *@
        <div class="tab-pane fade p-3" id="result-tab-pane" role="tabpanel" aria-labelledby="result-tab" tabindex="0">... Result content coming soon ...</div>
         <div class="tab-pane fade p-3" id="chat-tab-pane" role="tabpanel" aria-labelledby="chat-tab" tabindex="0">... Chat content coming soon ...</div>

    </div> @* End Main Tab Content *@

</div> @* End Container *@

<div class="modal fade" id="registerTeamModal" tabindex="-1" aria-labelledby="registerTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-controller="Team" asp-action="CreateTeam" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" name="ScheduleId" value="@Model.ScheduleId" />
                
                <div class="modal-header">
                    <h5 class="modal-title" id="registerTeamModalLabel">Register Your Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="mb-3">
                        <label for="TeamName" class="form-label">Team Name</label>
                        <input type="text" name="TeamName" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="TeamIconFile" class="form-label">Team Icon (Optional)</label>
                        <input type="file" name="TeamIconFile" class="form-control" accept="image/*" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Team</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editTeamModal" tabindex="-1" aria-labelledby="editTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-controller="Team" asp-action="EditTeam" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" id="editTeamId" name="TeamId" value="0" />
                
                <div class="modal-header">
                    <h5 class="modal-title" id="editTeamModalLabel">Edit Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="mb-3">
                        <label for="editTeamName" class="form-label">Team Name</label>
                        <input type="text" id="editTeamName" name="TeamName" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="editTeamIconFile" class="form-label">Team Icon</label>
                        <div class="mb-2 text-center">
                            <img id="currentTeamIcon" src="" alt="Current Icon" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;" />
                        </div>
                        <input type="file" name="TeamIconFile" class="form-control" accept="image/*" />
                        <small class="form-text text-muted">Upload a new file to replace the current icon.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- *** NEW: Invite Player Modal *** -->
<div class="modal fade" id="invitePlayerModal" tabindex="-1" aria-labelledby="invitePlayerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invitePlayerModalLabel">Invite Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="inviteTeamId" value="0" />
                <div class="mb-3">
                    <label for="userSearchInput" class="form-label">Search by username:</label>
                    <input type="text" id="userSearchInput" class="form-control" placeholder="Enter username..." />
                </div>
                <div id="invite-search-spinner" class="text-center d-none">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="invite-search-results">
                    <!-- Search results will be injected here by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Enable tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    // *** NEW SCRIPT: To populate the Edit Team modal ***
        var editTeamModal = document.getElementById('editTeamModal');
        if (editTeamModal) {
            editTeamModal.addEventListener('show.bs.modal', function (event) {
                // Button that triggered the modal
                var button = event.relatedTarget;
                
                // Extract info from data-* attributes
                var teamId = button.getAttribute('data-team-id');
                var teamName = button.getAttribute('data-team-name');
                var teamIconUrl = button.getAttribute('data-team-icon-url');

                // Update the modal's content
                var modal = this;
                modal.querySelector('#editTeamId').value = teamId;
                modal.querySelector('#editTeamName').value = teamName;
                modal.querySelector('#currentTeamIcon').src = teamIconUrl;
            });
        }

        // --- *** NEW SCRIPT for Invite Player modal *** ---
        var invitePlayerModal = document.getElementById('invitePlayerModal');
        var userSearchInput = document.getElementById('userSearchInput');
        var searchResultsContainer = document.getElementById('invite-search-results');
        var spinner = document.getElementById('invite-search-spinner');
        var inviteTeamIdInput = document.getElementById('inviteTeamId');
        var searchTimeout;

        if (invitePlayerModal) {
            // 1. When modal opens, get the teamId from the '+' button
            invitePlayerModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var teamId = button.getAttribute('data-team-id');
                inviteTeamIdInput.value = teamId;
                // Clear old results
                userSearchInput.value = '';
                searchResultsContainer.innerHTML = '';
            });

            // 2. When user types in search box
            userSearchInput.addEventListener('keyup', function () {
                clearTimeout(searchTimeout);
                var query = userSearchInput.value;
                var teamId = inviteTeamIdInput.value;

                if (query.length < 2) {
                    searchResultsContainer.innerHTML = '';
                    return;
                }

                spinner.classList.remove('d-none'); // Show spinner

                // Debounce search to avoid spamming server
                searchTimeout = setTimeout(function () {
                    fetch(`/Team/SearchUsersForInvite?teamId=${teamId}&query=${query}`)
                        .then(response => {
                            spinner.classList.add('d-none');
                            if (!response.ok) {
                                throw new Error('Search failed');
                            }
                            return response.json();
                        })
                        .then(users => {
                            renderSearchResults(users, teamId);
                        })
                        .catch(error => {
                            searchResultsContainer.innerHTML = '<p class="text-danger">Error searching users.</p>';
                        });
                }, 500);
            });
        }

        // 3. Render the search results
        function renderSearchResults(users, teamId) {
            searchResultsContainer.innerHTML = ''; // Clear
            if (users.length === 0) {
                searchResultsContainer.innerHTML = '<p class="text-muted">No users found.</p>';
                return;
            }

            users.forEach(user => {
                var profilePic = user.profilePicture ? user.profilePicture : '/images/profile_image.jpg';
                var userHtml = `
                    <div class="user-search-item">
                        <div class="d-flex align-items-center">
                            <img src="${profilePic}" alt="${user.username}" />
                            <strong>${user.username}</strong>
                        </div>
                        <button class="btn btn-sm btn-primary send-invite-btn" 
                                data-team-id="${teamId}" 
                                data-invitee-id="${user.userId}">
                            Invite
                        </button>
                    </div>`;
                searchResultsContainer.insertAdjacentHTML('beforeend', userHtml);
            });

            // 4. Add click listeners to the new "Invite" buttons
            document.querySelectorAll('.send-invite-btn').forEach(button => {
                button.addEventListener('click', sendInvite);
            });
        }

        // 5. Send the invite
        function sendInvite(event) {
            var button = event.target;
            var teamId = button.getAttribute('data-team-id');
            var inviteeId = button.getAttribute('data-invitee-id');
            var token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

            fetch('/Team/SendInvite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token
                },
                body: `teamId=${teamId}&inviteeUserId=${inviteeId}`
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.message || 'Failed to send invite') });
                }
                return response.json();
            })
            .then(data => {
                button.innerHTML = 'Sent!';
                button.classList.remove('btn-primary');
                button.classList.add('btn-secondary');
            })
            .catch(error => {
                button.innerHTML = 'Error';
                button.classList.remove('btn-primary');
                button.classList.add('btn-danger');
                alert('Error: ' + error.message);
            });
        }
    </script>
}