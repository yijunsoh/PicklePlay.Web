@model Schedule
@using PicklePlay.Models
@using PicklePlay.Models.ViewModels
@using PicklePlay.Data
@using System.Security.Claims;
@using Microsoft.EntityFrameworkCore;
@inject PicklePlay.Data.ApplicationDbContext _context

@{
    ViewData["Title"] = Model.GameName ?? "Competition Details";

    // Get the active tab from query string or default to "overview"
    var activeTab = Context.Request.Query["tab"].ToString();
    if (string.IsNullOrEmpty(activeTab)) activeTab = "overview";

    // Get the active sub-tab from query string or default to "listing"
    var activeSubTab = Context.Request.Query["subtab"].ToString();
    if (string.IsNullOrEmpty(activeSubTab)) activeSubTab = "listing";

    bool setupPending = Model.Status == ScheduleStatus.PendingSetup;

    // --- NEW: Get data for Registration Tab ---
    var organizers = Model.Participants.Where(p => p.Role == ParticipantRole.Organizer).ToList();
    var pendingTeams = Model.Teams.Where(t => t.Status == TeamStatus.Pending).ToList();
    var confirmedTeams = Model.Teams.Where(t => t.Status == TeamStatus.Confirmed).ToList();

    // --- NEW: Data for "Register Team" button ---
    bool hasUserRegisteredTeam = ViewBag.HasUserRegisteredTeam ?? false;
    int? currentUserId = ViewBag.CurrentUserId as int?;

    // --- NEW: Control variables for UI state ---
    bool isCompetitionOpen = Model.Status == ScheduleStatus.Active;
    bool isCompetitionInProgress = Model.Status == ScheduleStatus.InProgress;
    bool isCompetitionDone = Model.Status == ScheduleStatus.Completed;
    bool canManage = (isCompetitionOpen || setupPending) && organizers.Any(o => o.UserId == currentUserId);

    bool isScheduleOrganizer = currentUserId.HasValue &&
    organizers.Any(o => o.UserId == currentUserId.Value);

    // ⬇️ FIXED: Check if user is in a CONFIRMED team
    bool isInConfirmedTeam = currentUserId.HasValue &&
    Model.Teams.Any(team =>
    team.Status == TeamStatus.Confirmed &&
    team.TeamMembers.Any(member =>
    member.UserId == currentUserId.Value &&
    member.Status == TeamMemberStatus.Joined
    )
    );

    // ⬇️ User can access chat if they are organizer OR in confirmed team
    bool isConfirmedParticipant = isScheduleOrganizer || isInConfirmedTeam;

    Console.WriteLine($"User {currentUserId} - IsScheduleOrganizer: {isScheduleOrganizer}, IsInConfirmedTeam: {isInConfirmedTeam}, CanAccessChat: {isConfirmedParticipant}");

    Console.WriteLine($"User {currentUserId} - IsConfirmedParticipant (from Team table): {isConfirmedParticipant}");

    int confirmedCount = Model.Teams.Count(t => t.Status == TeamStatus.Confirmed);
    int maxTeams = Model.NumTeam ?? 0;
    bool isFull = maxTeams > 0 && confirmedTeams.Count >= maxTeams;

bool isEligible = true;
    List<string> restrictionReasons = new List<string>();

    if (currentUserId.HasValue)
    {
        // Fetch full user details
        var currentUser = _context.Users
            .Include(u => u.Rank)
            .AsNoTracking()
            .FirstOrDefault(u => u.UserId == currentUserId.Value);

        if (currentUser != null)
        {
            // 1. Gender Check
            if (Model.GenderRestriction != GenderRestriction.None)
            {
                string userGender = currentUser.Gender?.Trim() ?? "";
                if (Model.GenderRestriction == GenderRestriction.Male && !userGender.Equals("Male", StringComparison.OrdinalIgnoreCase))
                {
                    isEligible = false;
                    restrictionReasons.Add("Restricted to Male players.");
                }
                else if (Model.GenderRestriction == GenderRestriction.Female && !userGender.Equals("Female", StringComparison.OrdinalIgnoreCase))
                {
                    isEligible = false;
                    restrictionReasons.Add("Restricted to Female players.");
                }
            }

            // 2. Age Check
            if (Model.AgeGroupRestriction != AgeGroupRestriction.None)
            {
                int userAge = 0;
                if (currentUser.DateOfBirth.HasValue)
                {
                    var today = DateTime.Today;
                    userAge = today.Year - currentUser.DateOfBirth.Value.Year;
                    if (currentUser.DateOfBirth.Value.Date > today.AddYears(-userAge)) userAge--;
                }
                else { userAge = currentUser.Age ?? 0; }

                if (userAge == 0)
                {
                    isEligible = false;
                    restrictionReasons.Add("Update Date of Birth/Age in profile.");
                }
                else
                {
                    if (Model.AgeGroupRestriction == AgeGroupRestriction.Junior && userAge >= 18)
                    {
                        isEligible = false;
                        restrictionReasons.Add("Junior (Under 18) only.");
                    }
                    else if (Model.AgeGroupRestriction == AgeGroupRestriction.Adult && (userAge < 18 || userAge >= 60))
                    {
                        isEligible = false;
                        restrictionReasons.Add("Adult (18-59) only.");
                    }
                    else if (Model.AgeGroupRestriction == AgeGroupRestriction.Senior && userAge < 60)
                    {
                        isEligible = false;
                        restrictionReasons.Add("Senior (60+) only.");
                    }
                }
            }

            // 3. Rank Check
            decimal userRating = 0.000m;
            if (currentUser.Rank != null) { userRating = currentUser.Rank.Rating; } // Use your specific property name

            if (Model.MinRankRestriction.HasValue && Model.MinRankRestriction.Value > 0 && userRating < Model.MinRankRestriction.Value)
            {
                isEligible = false;
                restrictionReasons.Add($"Min Rank: {Model.MinRankRestriction.Value:0.00} (Yours: {userRating:0.00})");
            }
            if (Model.MaxRankRestriction.HasValue && Model.MaxRankRestriction.Value > 0 && userRating > Model.MaxRankRestriction.Value)
            {
                isEligible = false;
                restrictionReasons.Add($"Max Rank: {Model.MaxRankRestriction.Value:0.00} (Yours: {userRating:0.00})");
            }
        }
    }
}

<style>
    .organizer-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 80px;
        margin-right: 15px;
        margin-bottom: 10px;
    }

    .organizer-item img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #0d6efd;
    }

    .organizer-item .player-name {
        font-size: 0.8rem;
        margin-top: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 80px;
        text-align: center;
    }

    .team-card {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
        box-shadow: 0 .125rem .25rem rgba(0, 0, 0, .075);
    }

    .team-header {
        background-color: #f8f9fa;
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid #dee2e6;
    }

    .team-icon {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 50%;
        margin-right: 10px;
    }

    .team-body {
        padding: 1.25rem;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
        gap: 15px;
    }

    /* Copied from Details.cshtml */
    .player-slot,
    .empty-slot {
        width: 65px;
        height: 65px;
        border-radius: 50%;
        background-color: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        position: relative;
    }

    .player-slot img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #198754;
    }

    .player-slot .player-name {
        display: block;
        font-size: 0.75rem;
        margin-top: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 65px;
    }

    .player-slot-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 10px;
    }

    .empty-slot {
        border: 2px dashed #ced4da;
        cursor: pointer;
    }

    .empty-slot:hover {
        background-color: #e9ecef;
    }

    .empty-slot i {
        font-size: 1.5rem;
        color: #ced4da;
    }

    /* --- NEW STYLES FOR INVITE MODAL --- */
    #invite-search-results {
        max-height: 250px;
        overflow-y: auto;
    }

    .user-search-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        border-radius: 0.25rem;
    }

    .user-search-item:hover {
        background-color: #f8f9fa;
    }

    .user-search-item img {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 10px;
    }

    .toggle-icon {
        transition: transform 0.2s ease-in-out;
        display: inline-block;
    }

    .toggle-icon.rotated {
        /* This points the arrow up */
        transform: rotate(180deg);
    }

    .round-header {
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
        font-size: 1.1rem;
        color: #333;
    }

    .chat-message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
    }

    .chat-message.own-message {
        flex-direction: row-reverse;
    }

    .chat-message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin: 0 10px;
        flex-shrink: 0;
        border: 2px solid #dee2e6;
    }

    .chat-message-content {
        max-width: 70%;
    }

    .chat-message-header {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        gap: 8px;
    }

    .chat-message-avatar:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border-color: #2E8B57;
    }

    .chat-message-sender {
        font-weight: 600;
        font-size: 14px;
        color: #2E8B57;
        cursor: pointer;
        /* ⬅️ ADD THIS */
        transition: color 0.2s ease;
        /* ⬅️ ADD THIS */
    }

    /* ⬇️ ADD THIS: Hover effect for sender name */
    .chat-message-sender:hover {
        color: #1E5B32;
        text-decoration: underline;
    }

    .chat-message-role {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 12px;
        background-color: #ffc107;
        color: #000;
    }

    .chat-message-role.organizer {
        background-color: #dc3545;
        color: #fff;
    }

    .chat-message-time {
        font-size: 11px;
        color: #6c757d;
    }

    .chat-message-bubble {
        padding: 10px 15px;
        border-radius: 18px;
        background-color: #e9ecef;
        word-wrap: break-word;
        position: relative;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .chat-message.own-message .chat-message-bubble {
        background-color: #2E8B57;
        color: white;
    }

    .chat-message.own-message .chat-message-header {
        flex-direction: row-reverse;
    }

    .chat-message.own-message .chat-message-sender {
        color: #2E8B57;
    }

    .chat-message-delete {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 14px;
        font-weight: bold;
        display: none;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
        z-index: 10;
    }

    .chat-message:hover .chat-message-delete {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chat-message-delete:hover {
        background: #bb2d3b;
        transform: scale(1.15);
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
    }

    .chat-message-delete:active {
        transform: scale(0.95);
    }

    .system-message {
        text-align: center;
        color: #6c757d;
        font-size: 12px;
        margin: 10px 0;
        font-style: italic;
    }

    #chatMessages {
        scroll-behavior: smooth;
    }

    #chatMessages::-webkit-scrollbar {
        width: 8px;
    }

    #chatMessages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    #chatMessages::-webkit-scrollbar-thumb {
        background: #2E8B57;
        border-radius: 10px;
    }

    #chatMessages::-webkit-scrollbar-thumb:hover {
        background: #1E5B32;
    }

    #chatInput {
        border: 2px solid #dee2e6;
        transition: border-color 0.2s ease;
    }

    #chatInput:focus {
        border-color: #2E8B57;
        box-shadow: 0 0 0 0.2rem rgba(46, 139, 87, 0.25);
    }
</style>

<div class="container mt-4">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @* --- Header Section --- *@
    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
        <div>
            <h2>@Model.GameName</h2>
            <p class="text-muted mb-0">@Model.Location</p>

            @if (Model.Status == ScheduleStatus.PendingSetup)
            {
                <span class="badge bg-warning text-dark">Pending Setup</span>
            }
            else if (Model.Status == ScheduleStatus.InProgress)
            {
                <span class="badge bg-primary">In Progress</span>
            }
            else if (Model.Status == ScheduleStatus.Completed)
            {
                <span class="badge bg-secondary">Completed</span>
            }
            else
            {
                <span class="badge bg-success">@Model.Status.ToString()</span>
            }
        </div>
        <div>
            <button class="btn btn-outline-secondary"><i class="bi bi-share"></i> Share</button>

            @if (Model.Status == ScheduleStatus.PendingSetup)
            {
                <a asp-action="SetupMatch" asp-controller="Community" asp-route-id="@Model.ScheduleId"
                    class="btn btn-warning"><i class="bi bi-pencil-square"></i> Continue Setup</a>
            }
            else if (hasUserRegisteredTeam)
            {
                <button class="btn btn-success" disabled><i class="bi bi-check-all"></i> Team Registered</button>
            }
            @* ⬇️ NEW: Block registration if full *@
            else if (isFull)
            {
                <button class="btn btn-secondary" disabled>
                    <i class="bi bi-lock-fill"></i> Competition Full
                </button>
            }
            else if (currentUserId.HasValue && !isEligible)
            {
                <button class="btn btn-secondary" disabled>
                    <i class="bi bi-slash-circle"></i> Not Eligible
                </button>
                @* Tooltip to show why *@
                <div class="text-danger small mt-1" style="max-width: 200px; line-height: 1.2;">
                    @foreach(var reason in restrictionReasons) { <div>• @reason</div> }
                </div>
            }
            else if (isCompetitionOpen && currentUserId.HasValue)
            {
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerTeamModal">
                    <i class="bi bi-person-plus"></i> Register Team
                </button>
            }
            else if (isCompetitionOpen && !currentUserId.HasValue)
            {
                <a asp-controller="Auth" asp-action="Login" asp-route-returnUrl="@Context.Request.Path"
                    class="btn btn-primary">
                    <i class="bi bi-box-arrow-in-right"></i> Log in to Register
                </a>
            }

            @if (organizers.Any(o => o.UserId == currentUserId))
            {
                @if (isCompetitionOpen)
                {
                    <button class="btn btn-success" id="startCompetitionBtn">
                        <i class="bi bi-play-fill"></i> Start Competition
                    </button>
                }

                @if (Model.Status == ScheduleStatus.InProgress)
                {
                    var canEnd = Model.EndTime.HasValue && DateTime.UtcNow >= Model.EndTime.Value;
                    var timeUntilEnd = Model.EndTime.HasValue ? Model.EndTime.Value - DateTime.UtcNow : TimeSpan.Zero;

                    <button class="btn btn-danger" id="endCompetitionBtn" @(canEnd ? "" : "disabled")
                        title="@(canEnd ? "End Competition" : $"Competition can be ended after {Model.EndTime:MMM dd, yyyy hh:mm tt}")">
                        <i class="bi bi-stop-fill"></i> End Competition
                    </button>
                }

                @* Submit Result to RANK button (only for completed competitions) *@
                @if (Model.Status == ScheduleStatus.Completed)
                {
                    <div id="rankSubmitContainer" class="d-flex gap-2">
                        <!-- Submit Button -->
                        <button type="button" class="btn btn-primary" id="submitRankBtn">
                            <i class="bi bi-graph-up-arrow"></i> Submit to RANK
                        </button>



                        <!-- Submitted Status -->
                        <div id="rankSubmittedStatus" style="display: none;">
                            <button type="button" class="btn btn-success" disabled>
                                <i class="bi bi-check-circle-fill me-2"></i>Submitted to RANK
                            </button>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle me-1"></i>
                                <span id="rankSubmissionInfo"></span>
                            </small>
                        </div>
                    </div>
                }

                @if (canManage && Model.Status != ScheduleStatus.Completed)
                {
                    <div class="dropdown d-inline-block">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="compActionsDropdown"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            Actions
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="compActionsDropdown">
                            @if (Model.Status == ScheduleStatus.PendingSetup)
                            {
                                <li><a class="dropdown-item" asp-action="EditCompetition" asp-controller="Community"
                                        asp-route-id="@Model.ScheduleId"><i class="bi bi-pencil-fill me-2"></i> Edit Draft
                                        Details</a></li>
                            }
                            else
                            {
                                <li><a class="dropdown-item" asp-action="EditCompetition" asp-controller="Community"
                                        asp-route-id="@Model.ScheduleId"><i class="bi bi-pencil-fill me-2"></i> Edit Details</a>
                                </li>
                            }
                            <li>
                                <a class="dropdown-item" asp-action="SetupMatch" asp-controller="Community"
                                    asp-route-id="@Model.ScheduleId">
                                    <i class="bi bi-gear-fill me-2"></i> Edit Format & Rules
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#setAwardModal">
                                    <i class="bi bi-trophy-fill me-2"></i> Set Award
                                </a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                @if (Model.Competition?.Format == CompetitionFormat.RoundRobin)
                                {
                                    <a class="dropdown-item disabled" href="#"
                                        title="Round Robin format does not require a manual draw.">
                                        <i class="bi bi-diagram-3-fill me-2"></i> Generate Draw
                                    </a>
                                }
                                else
                                {
                                    <a class="dropdown-item" asp-action="GenerateDraw" asp-controller="Draw"
                                        asp-route-id="@Model.ScheduleId">
                                        <i class="bi bi-diagram-3-fill me-2"></i> Generate Draw
                                    </a>
                                }
                            </li>
                            <li><a class="dropdown-item" asp-action="Index" asp-controller="ManageTeam"
                                    asp-route-id="@Model.ScheduleId"><i class="bi bi-people-fill me-2"></i> Manage Teams</a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            @if (Model.Status == ScheduleStatus.PendingSetup)
                            {
                                <li><a class="dropdown-item text-danger" asp-action="Delete" asp-controller="Schedule"
                                        asp-route-id="@Model.ScheduleId"><i class="bi bi-trash-fill me-2"></i> Delete Draft</a></li>
                            }
                            else
                            {
                                <li><a class="dropdown-item text-danger" asp-action="Delete" asp-controller="Schedule"
                                        asp-route-id="@Model.ScheduleId"
                                        onclick="return confirm('Are you sure you want to permanently delete this competition? This action cannot be undone.')"><i
                                            class="bi bi-trash-fill me-2"></i> Delete Competition</a></li>
                            }
                        </ul>
                    </div>
                }
            }
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.CompetitionImageUrl))
    {
        <div class="card shadow-sm mb-3">
            <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#posterCollapse"
                aria-expanded="true" aria-controls="posterCollapse">

                <h5 class="mb-0 d-flex justify-content-between align-items-center">
                    Competition Poster
                    <a class="text-decoration-none text-secondary">
                        <span class="toggle-icon small rotated">▼</span>
                    </a>
                </h5>
            </div>
            <div class="collapse show" id="posterCollapse">
                <div class="card-body text-center p-2">
                    <img src="@Url.Content(Model.CompetitionImageUrl)" alt="@Model.GameName Poster"
                        style="max-width: 100%; height: auto; max-height: 400px; border-radius: 8px;" />
                </div>
            </div>
        </div>
    }

    @* --- Main Tabs --- *@
    <ul class="nav nav-tabs" id="competitionTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details-tab-pane"
                type="button" role="tab" aria-controls="details-tab-pane" aria-selected="true">Details</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="registration-tab" data-bs-toggle="tab" data-bs-target="#registration-tab-pane"
                type="button" role="tab" aria-controls="registration-tab-pane"
                aria-selected="false">Registration</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="match-tab" data-bs-toggle="tab" data-bs-target="#match-tab-pane" type="button"
                role="tab" aria-controls="match-tab-pane" aria-selected="false">Match</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="result-subtab" data-bs-toggle="tab" data-bs-target="#result-content"
                type="button" role="tab">
                <i class="bi bi-trophy-fill"></i> Results
            </button>
        </li>
        <li class="nav-item" role="presentation">
            @* Only show chat if competition is active/in-progress AND user is confirmed participant *@
    @if ((Model.Status == ScheduleStatus.Active ||
                        Model.Status == ScheduleStatus.InProgress ||
                        Model.Status == ScheduleStatus.Completed) &&
                        isConfirmedParticipant)
            {
                <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat-tab-pane" type="button"
                    role="tab" aria-controls="chat-tab-pane" aria-selected="false">
                    <i class="bi bi-chat-dots"></i> Chat
                    <span class="badge bg-danger ms-2" id="unreadChatCount" style="display: none;">0</span>
                </button>
            }
            else if (!isConfirmedParticipant && currentUserId.HasValue)
            {
                <button class="nav-link disabled" id="chat-tab" type="button"
                    title="Only confirmed participants can access chat">
                    <i class="bi bi-chat-dots"></i> Chat
                    <i class="bi bi-lock-fill ms-1" style="font-size: 0.8rem;"></i>
                </button>
            }
            else if (!currentUserId.HasValue)
            {
                <button class="nav-link disabled" id="chat-tab" type="button" title="Login to access chat">
                    <i class="bi bi-chat-dots"></i> Chat
                    <i class="bi bi-lock-fill ms-1" style="font-size: 0.8rem;"></i>
                </button>
            }
            else
            {
                <button class="nav-link disabled" id="chat-tab" type="button"
                    title="Chat available after competition starts">
                    <i class="bi bi-chat-dots"></i> Chat
                </button>
            }
        </li>
    </ul>

    @* --- Main Tab Content --- *@
    <div class="tab-content" id="competitionTabContent">
        @* --- Details Tab Pane (with null-checks from previous step) --- *@
        <div class="tab-pane fade show active p-3" id="details-tab-pane" role="tabpanel" aria-labelledby="details-tab"
            tabindex="0">

            @if (setupPending && Model.Competition != null)
            {
                <div class="alert alert-warning" role="alert">
                    This competition setup is not complete.
                    <a asp-action="SetupMatch" asp-controller="Community" asp-route-id="@Model.ScheduleId"
                        class="alert-link">Continue Setup</a> or <a asp-action="Publish" asp-controller="Community"
                        asp-route-id="@Model.ScheduleId"
                        onclick="event.preventDefault(); document.getElementById('publish-form-@Model.ScheduleId').submit();"
                        class="alert-link">Publish</a> with default settings for **@Model.Competition.Format**.
                </div>
                <form id="publish-form-@Model.ScheduleId" asp-controller="Community" asp-action="Publish"
                    asp-route-id="@Model.ScheduleId" method="post" class="d-none"> @Html.AntiForgeryToken() </form>
            }

            <h5>About</h5>
            <p>@Model.Description</p>
            <hr />

            <h5>Schedule & Registration</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Start:</strong> @Model.StartTime?.ToString("dd MMM yyyy, hh:mm tt")</p>
                    <p><strong>End:</strong> @Model.EndTime?.ToString("dd MMM yyyy, hh:mm tt")</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Reg Opens:</strong> @Model.RegOpen?.ToString("dd MMM yyyy, hh:mm tt")</p>
                    <p><strong>Reg Closes:</strong> @Model.RegClose?.ToString("dd MMM yyyy, hh:mm tt")</p>

                    @if (Model.EarlyBirdClose.HasValue)
                    {
                        <p><strong>Early Bird:</strong> @Model.EarlyBirdClose?.ToString("dd MMM yyyy, hh:mm tt")</p>
                    }
                </div>
            </div>
            <hr />

            <h5>Participation</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Teams Limit:</strong> @Model.NumTeam</p>
                    <p>
                        <strong>Fee:</strong>
                        @if (Model.FeeType == FeeType.Free)
                        {
                            <span>Free</span>
                        }
                        else if (Model.FeeType == FeeType.PerPerson)
                        {

                            <span>RM @Model.FeeAmount?.ToString("0.00") per
                                Team</span>
                        }
                        else
                        {

                            <span>N/A</span>
                        }
                    </p>
                </div>

                <div class="col-md-6">
                    <p><strong>Gender:</strong> @(Model.GenderRestriction.HasValue && Model.GenderRestriction !=
                                                GenderRestriction.None ? Model.GenderRestriction.ToString() : "Any")</p>
                    <p><strong>Age Group:</strong> @(Model.AgeGroupRestriction.HasValue && Model.AgeGroupRestriction !=
                                                AgeGroupRestriction.Adult ? Model.AgeGroupRestriction.ToString() : "Any")</p>
                    <p><strong>Rank:</strong> @(Model.MinRankRestriction?.ToString("0.00") ?? "Any") -
                        @(Model.MaxRankRestriction?.ToString("0.00") ?? "Any")</p>
                </div>
            </div>

        </div> @* End Details Tab Pane *@

        <div class="tab-pane fade p-3" id="registration-tab-pane" role="tabpanel" aria-labelledby="registration-tab"
            tabindex="0">

            <ul class="nav nav-pills mb-3" id="registrationSubTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="teams-subtab" data-bs-toggle="tab"
                        data-bs-target="#teams-subtab-pane" type="button" role="tab" aria-controls="teams-subtab-pane"
                        aria-selected="true">
                        Teams (@confirmedTeams.Count / @Model.NumTeam)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="staff-subtab" data-bs-toggle="tab" data-bs-target="#staff-subtab-pane"
                        type="button" role="tab" aria-controls="staff-subtab-pane" aria-selected="false">
                        Staff
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="registrationSubTabsContent">
                <div class="tab-pane fade" id="staff-subtab-pane" role="tabpanel" aria-labelledby="staff-subtab"
                    tabindex="0">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Competition Staff</h5>
                        @if (organizers.Any(o => o.UserId == currentUserId))
                        {
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                                data-bs-target="#addStaffModal">
                                <i class="bi bi-person-plus-fill"></i> Add Staff
                            </button>
                        }
                    </div>

                    @* Display Organizer/Creator *@
    <div class="mb-4">
                        <h6 class="text-muted mb-2">Organizer</h6>
                        @if (organizers.Any())
                        {
                            <div class="d-flex flex-wrap align-items-center">
                                @foreach (var p in organizers)
                                {
                                    <div class="organizer-item" style="cursor: pointer;"
                                        onclick="showUserProfilePreview(@p.UserId)"
                                        title="Click to view @p.User?.Username's profile">
                                        <img src="@(string.IsNullOrEmpty(p.User?.ProfilePicture) ? "/images/profile_image.jpg" : p.User.ProfilePicture)"
                                            alt="Profile" onerror="this.src='/images/user.png'"/>
                                        <span class="player-name">@p.User?.Username</span>
                                        <span class="badge bg-warning text-dark mt-1">Organizer</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">No organizer found.</p>
                        }
                    </div>

                    @* Display Staff Members *@
    <div>
                        <h6 class="text-muted mb-2">Staff Members</h6>
                        @{
                            var staffMembers = Model.Participants.Where(p => p.Role == ParticipantRole.Staff).ToList();
                        }

                        @if (staffMembers.Any())
                        {
                            <div class="d-flex flex-wrap align-items-start gap-3">
                                @foreach (var staff in staffMembers)
                                {
                                    <div class="card shadow-sm" style="width: 200px;">
                                        <div class="card-body text-center">
                                            <img src="@(string.IsNullOrEmpty(staff.User?.ProfilePicture) ? "/images/profile_image.jpg" : staff.User.ProfilePicture)"
                                                alt="Profile"
                                                style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; cursor: pointer;"
                                                onclick="showUserProfilePreview(@staff.UserId)"
                                                title="Click to view @staff.User?.Username's profile" onerror="this.src='/images/user.png'"/>

                                            <h6 class="mb-1" style="cursor: pointer;"
                                                onclick="showUserProfilePreview(@staff.UserId) onerror="this.src='/images/user.png'"">
                                                @staff.User?.Username
                                            </h6>
                                            <span class="badge bg-primary mb-2">Staff</span>

                                            <p class="text-muted small mb-2">
                                                <i class="bi bi-calendar-check"></i> Staff member
                                            </p>

                                            @if (organizers.Any(o => o.UserId == currentUserId))
                                            {
                                                <button class="btn btn-sm btn-outline-danger w-100"
                                                    onclick="removeStaff(@staff.UserId)" title="Remove Staff">
                                                    <i class="bi bi-person-dash"></i> Remove
                                                </button>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                No staff members assigned yet.
                                @if (organizers.Any(o => o.UserId == currentUserId))
                                {
                                    <span>Click "Add Staff" to assign helpers for managing this competition.</span>
                                }
                            </div>
                        }
                    </div>

                    @* Staff Permissions Info *@
    <div class="alert alert-light mt-4">
                        <h6><i class="bi bi-shield-check me-2"></i>Staff Permissions</h6>
                        <ul class="mb-0 small">
                            <li>Update match scores and status</li>
                            <li>Set competition awards</li>
                            <li>Manage match schedules and courts</li>
                            <li>View all competition data</li>
                        </ul>
                        <p class="mb-0 mt-2 text-muted small">
                            <strong>Note:</strong> Staff cannot add/remove other staff or delete the competition.
                        </p>
                    </div>
                </div>

                <div class="tab-pane fade show active" id="teams-subtab-pane" role="tabpanel"
                    aria-labelledby="teams-subtab" tabindex="0">

                    <ul class="nav nav-tabs" id="teamStatusTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="confirmed-teams-tab" data-bs-toggle="tab"
                                data-bs-target="#confirmed-teams-pane" type="button" role="tab"
                                aria-controls="confirmed-teams-pane" aria-selected="true">
                                Confirmed (@confirmedTeams.Count)
                            </button>
                        </li>
                        @if (Model.FeeType != FeeType.Free && (Model.FeeAmount ?? 0) > 0)
    {
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pending-teams-tab" data-bs-toggle="tab"
                data-bs-target="#pending-teams-pane" type="button" role="tab" aria-controls="pending-teams-pane" aria-selected="false">
                Pending Payment (@pendingTeams.Count)
            </button>
        </li>
    }
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="onhold-teams-tab" data-bs-toggle="tab"
                                data-bs-target="#onhold-teams-pane" type="button" role="tab"
                                aria-controls="onhold-teams-pane" aria-selected="false">
                                On Hold (@Model.Teams.Count(t => t.Status == TeamStatus.Onhold))
                            </button>
                        </li>
                    </ul>
                    

                <div class="tab-content" id="teamStatusTabsContent">
                    @* pending teams tab content *@
                        <div class="tab-pane fade" id="pending-teams-pane" role="tabpanel"
                            aria-labelledby="pending-teams-tab" tabindex="0">
                            <div class="pt-3">
                                @if (!pendingTeams.Any())
                                {
                                    <p class="text-muted">No teams pending approval.</p>
                                }
                                @foreach (var team in pendingTeams)
                                {
                                    <div class="team-card">
                                        <div class="team-header d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                               <img src="@(string.IsNullOrEmpty(team.TeamIconUrl) ? "/images/team_icon.png" : team.TeamIconUrl)"
     alt="Team Icon" class="team-icon"
     loading="lazy" decoding="async"
     onerror="this.onerror=null;this.src='/images/teamdfpic.jpg';" />
                                                <h5 class="mb-0">@team.TeamName</h5>
                                                @if (team.PaymentStatusForSchedule == PaymentStatusForSchedule.Paid)
                                                {
                                                    <span class="badge bg-success ms-2">Paid</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning text-dark ms-2">Unpaid</span>
                                                }
                                            </div>

                                            <div class="btn-group">
                                               @if (currentUserId == team.CreatedByUserId && team.PaymentStatusForSchedule == PaymentStatusForSchedule.Unpaid)
{
    // --- EARLY BIRD LOGIC START ---
    decimal finalFee = Model.FeeAmount ?? 0;
    bool isEarlyBirdActive = false;

    // Check if Early Bird is configured and we are before the deadline
    if (Model.EarlyBirdClose.HasValue && DateTime.Now <= Model.EarlyBirdClose.Value && Model.EarlyBirdPrice.HasValue)
    {
        finalFee = Model.EarlyBirdPrice.Value;
        isEarlyBirdActive = true;
    }
    // --- EARLY BIRD LOGIC END ---

    <button onclick="openCompetitionPaymentModal(@team.TeamId, @Model.ScheduleId, @finalFee, @(isEarlyBirdActive.ToString().ToLower()))"
            class="btn btn-sm btn-primary">
        <i class="bi bi-credit-card"></i> Pay Entry Fee 
        @if(isEarlyBirdActive) { <span class="badge bg-warning text-dark ms-1">Early Bird</span> }
    </button>
}
                                                @if (team.CreatedByUserId == currentUserId)
                                                {
                                                                        <form asp-controller="Team" asp-action="DeleteTeam" method="post" class="d-inline"
                          onsubmit="return confirm('Are you sure you want to withdraw?');">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="teamId" value="@team.TeamId" />
                        <button type="submit" class="btn btn-sm btn-outline-danger ms-1">
                            <i class="bi bi-trash"></i> Quit
                        </button>
                    </form>
                                                    <a href="#" class="btn btn-sm btn-outline-secondary edit-team-btn"
                                                        data-bs-toggle="modal" data-bs-target="#editTeamModal"
                                                        data-team-id="@team.TeamId" data-team-name="@team.TeamName"
                                                        data-team-icon-url="@(string.IsNullOrEmpty(team.TeamIconUrl) ? "/images/team_icon.png" : team.TeamIconUrl)">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                }
                                            </div>
                                        </div>
                                        <div class="team-body">
                                            @foreach (var member in team.TeamMembers)
                                            {
                                                <div class="player-slot-wrapper" style="cursor: pointer;"
                                                    onclick="showUserProfilePreview(@member.UserId)"
                                                    title="Click to view @member.User?.Username's profile">
                                                    <div class="player-slot">
                                                        <img src="@(string.IsNullOrEmpty(member.User?.ProfilePicture) ? "/images/profile_image.jpg" : member.User.ProfilePicture)"
                                                            alt="Profile" loading="lazy" decoding="async"
                                                            onerror="this.onerror=null;this.src='/images/user.png';" />
                                                    </div>
                                                    <span class="player-name">@member.User?.Username</span>
                                                </div>
                                            }
                                        </div>

                                    </div>
                                }
                            </div>
                        </div> 
                         @* pending tabs content end *@
                         @* confirmed tabs content *@
                         
                        <div class="tab-pane fade show active" id="confirmed-teams-pane" role="tabpanel"
                            aria-labelledby="confirmed-teams-tab" tabindex="0">
                            <div class="pt-3">
                                @if (!confirmedTeams.Any())
                                {
                                    <p class="text-muted">No teams confirmed yet.</p>
                                }
                                @foreach (var team in confirmedTeams)
                                {
                                    <div class="team-card">
                                        <div class="team-header d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <img src="@(string.IsNullOrEmpty(team.TeamIconUrl) ? "/images/team_icon.png" : team.TeamIconUrl)"
     alt="Team Icon" class="team-icon"
     loading="lazy" decoding="async"
     onerror="this.onerror=null;this.src='/images/teamdfpic.jpg';" />
                                                <h5 class="mb-0">@team.TeamName</h5>
                                            </div>
                                            @if (team.CreatedByUserId == currentUserId)
                                            {
                                                <a href="#" class="btn btn-sm btn-outline-secondary edit-team-btn"
                                                    data-bs-toggle="modal" data-bs-target="#editTeamModal"
                                                    data-team-id="@team.TeamId" data-team-name="@team.TeamName"
                                                    data-team-icon-url="@(string.IsNullOrEmpty(team.TeamIconUrl) ? "/images/team_icon.png" : team.TeamIconUrl)" onerror="this.src='/images/teamdfpic.jpg'">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                            }
                                        </div>
                                        <div class="team-body">
                                            @foreach (var member in team.TeamMembers)
                                            {
                                                <div class="player-slot-wrapper" style="cursor: pointer;"
                                                    onclick="showUserProfilePreview(@member.UserId)"
                                                    title="Click to view @member.User?.Username's profile">
                                                    <div class="player-slot">
                                                        <img src="@(string.IsNullOrEmpty(member.User?.ProfilePicture) ? "/images/profile_image.jpg" : member.User.ProfilePicture)"
                                                            alt="Profile" loading="lazy" decoding="async"
                                                            onerror="this.onerror=null;this.src='/images/user.png';" />
                                                    </div>
                                                    <span class="player-name">@member.User?.Username</span>
                                                </div>
                                            }
                                            <!-- *** MODIFIED: Invite Slot (for confirmed teams) *** -->
                                            @if (team.CreatedByUserId == currentUserId && team.TeamMembers.Count < 2)
                                            {
                                                <div class="player-slot-wrapper">
                                                    <div class="empty-slot" data-bs-toggle="modal"
                                                        data-bs-target="#invitePlayerModal" data-team-id="@team.TeamId"
                                                        title="Invite Player">
                                                        <i class="bi bi-person-plus"></i>
                                                    </div>
                                                    <span class="player-name text-muted">Invite</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                        @* confirmed tabs content end*@
@* on hold tabs content*@
<div class="tab-pane fade" id="onhold-teams-pane" role="tabpanel"
    aria-labelledby="onhold-teams-tab" tabindex="0">
    <div class="pt-3">
        @{ var onHoldTeams = Model.Teams.Where(t => t.Status == TeamStatus.Onhold).ToList(); }
        
        @if (!onHoldTeams.Any())
        {
            <p class="text-muted">No teams currently on hold.</p>
        }

        @foreach (var team in onHoldTeams)
        {
            <div class="team-card opacity-75">
                <div class="team-header d-flex align-items-center justify-content-between bg-light">
                    <div class="d-flex align-items-center">
<img src="@(string.IsNullOrEmpty(team.TeamIconUrl) ? "/images/team_icon.png" : team.TeamIconUrl)"
     alt="Team Icon" class="team-icon"
     loading="lazy" decoding="async"
     onerror="this.onerror=null;this.src='/images/teamdfpic.jpg';" />
                        <h5 class="mb-0">@team.TeamName</h5>
                        <span class="badge bg-secondary ms-2">On Hold</span>
                    </div>
                    
                    @if (team.CreatedByUserId == currentUserId)
                    {
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-muted small fst-italic">Waiting approval...</span>
                            
                            @* Withdraw Button *@
                            <form asp-controller="Team" asp-action="DeleteTeam" method="post" 
                                  onsubmit="return confirm('Are you sure you want to withdraw your team application?');">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="teamId" value="@team.TeamId" />
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i> Withdraw
                                </button>
                            </form>
                        </div>
                    }
                </div>
                <div class="team-body">
                    @foreach (var member in team.TeamMembers)
                    {
                        <div class="player-slot-wrapper" style="cursor: pointer;"
                             onclick="showUserProfilePreview(@member.UserId)"
                             title="Click to view @member.User?.Username's profile">
                            <div class="player-slot">
                                <img src="@(string.IsNullOrEmpty(member.User?.ProfilePicture) ?
                                    "/images/profile_image.jpg" : member.User.ProfilePicture)"
                                    alt="Profile" loading="lazy" decoding="async"
                                    onerror="this.onerror=null;this.src='/images/user.png';" />
                            </div>
                            <span class="player-name">@member.User?.Username</span>
                        </div>

                        @* ⬇️ RESTORED: Captain Controls (Make Captain / Remove Member) *@
                        @if (currentUserId == team.CreatedByUserId && member.UserId != team.CreatedByUserId)
                        {
                            <div class="btn-group-vertical btn-group-sm" style="width: 65px; align-items: center;">
                                <form asp-action="MakeCaptain" asp-controller="Competition" method="post"
                                      class="d-inline"
                                      onsubmit="return confirm('Make @member.User!.Username captain? You will lose captain permissions.')">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="teamId" value="@team.TeamId" />
                                    <input type="hidden" name="newCaptainUserId" value="@member.UserId" />
                                    <button type="submit" class="btn btn-sm btn-outline-warning w-100" title="Make Captain">
                                        <i class="bi bi-star-fill"></i>
                                    </button>
                                </form>

                                <form asp-action="RemoveMember" asp-controller="Competition" method="post"
                                      class="d-inline"
                                      onsubmit="return confirm('Remove @member.User.Username from the team?')">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="teamId" value="@team.TeamId" />
                                    <input type="hidden" name="userId" value="@member.UserId" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger w-100" title="Remove Member">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </form>
                            </div>
                        }
                    }

                    @* ⬇️ Invite Logic (Only on OnHold Tab) *@
                    @if (team.CreatedByUserId == currentUserId && team.TeamMembers.Count < 2)
                    {
                        <div class="player-slot-wrapper">
                            <div class="empty-slot" data-bs-toggle="modal"
                                 data-bs-target="#invitePlayerModal" data-team-id="@team.TeamId"
                                 title="Invite Player">
                                <i class="bi bi-person-plus"></i>
                            </div>
                            <span class="player-name text-muted">Invite</span>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>
                    </div>
                </div>
            </div>
        </div>

        @* --- Match Tab Pane (MODIFIED) --- *@
        <div class="tab-pane fade p-3" id="match-tab-pane" role="tabpanel" aria-labelledby="match-tab" tabindex="0">

            @if (setupPending)
            {
                <div class="alert alert-warning" role="alert">
                    Match setup cannot be completed until the initial competition setup is saved.
                    <a asp-action="SetupMatch" asp-controller="Community" asp-route-id="@Model.ScheduleId"
                        class="alert-link">Go to Setup</a>.
                </div>
            }
            else if (Model.Competition == null)
            {
                <div class="alert alert-danger" role="alert">
                    Error: Competition details are missing. Cannot display match information.
                </div>
            }
            else
            {
                bool isDrawPublished = Model.Competition.DrawPublished;
                bool isRoundRobin = Model.Competition.Format == CompetitionFormat.RoundRobin;
                bool canViewDraw = isDrawPublished && !isRoundRobin;

                @* --- Nested Match Tabs (MODIFIED) --- *@
                                     <ul class="nav nav-pills mb-3" id="matchSubTabs" role="tablist">

                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="format-subtab" data-bs-toggle="tab"
                            data-bs-target="#format-subtab-pane" type="button" role="tab" aria-controls="format-subtab-pane"
                            aria-selected="true">Format</button>
                    </li>

                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="draw-subtab" data-bs-toggle="tab" data-bs-target="#draw-subtab-pane"
                            type="button" role="tab" aria-controls="draw-subtab-pane" aria-selected="false" @(canViewDraw ?
                                                                                                                                    "" : "disabled")
                            title="@(canViewDraw ? "View Published Draw" : (isRoundRobin ? "Draw not applicable for Round Robin" : "Draw has not been published"))">
                            Draw
                            @if (!canViewDraw && !isRoundRobin)
                            {
                                <i class="bi bi-lock-fill ms-1" style="font-size: 0.8rem;"></i>
                            }
                        </button>
                    </li>

                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="listing-subtab" data-bs-toggle="tab"
                            data-bs-target="#listing-subtab-pane" type="button" role="tab"
                            aria-controls="listing-subtab-pane" aria-selected="false">
                            Listing
                        </button>
                    </li>
                    @if (Model.Competition?.Format != CompetitionFormat.Elimination)
                    {
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(activeSubTab == "standing" ? "active" : "")" id="standing-subtab"
                                data-bs-toggle="tab" data-bs-target="#standing-subtab-pane" type="button" role="tab"
                                aria-controls="standing-subtab-pane"
                                aria-selected="@(activeSubTab == "standing" ? "true" : "false")">
                                Standing
                            </button>
                        </li>
                    }
                </ul>

                <div class="tab-content" id="matchSubTabsContent">
                    @* --- Format Sub-Tab Pane --- *@
                                        <div class="tab-pane fade show active" id="format-subtab-pane" role="tabpanel"
                        aria-labelledby="format-subtab" tabindex="0">
                        <h5>Format & Rules</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Format:</strong> @Model.Competition!.Format.ToString()</p>
                                @if (Model.Competition.Format == CompetitionFormat.PoolPlay)
                                {
                                    <p><strong>Pools:</strong> @Model.Competition.NumPool</p>
                                    <p><strong>Winners/Pool:</strong> @Model.Competition.WinnersPerPool</p>
                                    <p><strong>Standings:</strong> @Model.Competition.StandingCalculation.ToString()</p>
                                    @if (Model.Competition.StandingCalculation == StandingCalculation.WinLossPoints)
                                    {
                                        <h6>Point System</h6>
                                        <ul>
                                            <li>Standard Win: @Model.Competition.StandardWin pts</li>
                                            <li>Standard Loss: @Model.Competition.StandardLoss pts</li>
                                            <li>Tie-Break Win: @Model.Competition.TieBreakWin pts</li>
                                            <li>Tie-Break Loss: @Model.Competition.TieBreakLoss pts</li>
                                            <li>Draw: @Model.Competition.Draw pts</li>
                                        </ul>
                                    }
                                }
                                @if (Model.Competition.Format == CompetitionFormat.Elimination)
                                {
                                    <p><strong>3rd Place Match:</strong> @(Model.Competition.ThirdPlaceMatch ? "Yes" : "No")</p>
                                }
                                @if (Model.Competition.Format == CompetitionFormat.RoundRobin)
                                {
                                    <p><strong>Double Round:</strong> @(Model.Competition.DoubleRR ? "Yes" : "No")</p>
                                }
                            </div>
                            <div class="col-md-6">
                                @if (!string.IsNullOrEmpty(Model.Competition.MatchRule))
                                {
                                    <p><strong>Match Rules:</strong></p>
                                    <p style="white-space: pre-wrap;">@Model.Competition.MatchRule</p>
                                }
                            </div>
                        </div>
                    </div> @* End Format Sub-Tab Pane *@
                        
                                         @* Draw Sub-Tab Pane *@
                                        <div class="tab-pane fade" id="draw-subtab-pane" role="tabpanel" aria-labelledby="draw-subtab"
                        tabindex="0">
                        @if (canViewDraw)
                        {
                            <div id="draw-visual-container">
                                <div class="text-center p-5">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading Draw...</span>
                                    </div>
                                    <p class="mt-2">Loading Draw...</p>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                The draw is not yet published or is not applicable for this competition format.
                            </div>
                        }
                    </div>

                    @* --- Listing Sub-Tab Pane --- *@
                    <div class="tab-pane fade @(activeSubTab == "listing" ? "show active" : "")" id="listing-subtab-pane"
                        role="tabpanel" aria-labelledby="listing-subtab" tabindex="0">
                        <div id="listing-container">
                            <div class="text-center p-3">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    @* --- Standing Sub-Tab Pane --- *@
                                         <div class="tab-pane fade @(activeSubTab == "standing" ? "show active" : "")" id="standing-subtab-pane"
                        role="tabpanel" aria-labelledby="standing-subtab" tabindex="0">
                        <div id="standing-container">
                            <div class="text-center p-3">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> @* End Nested Tab Content *@
             } @* End else block for setupPending / Competition null check *@
        </div> @* End Match Tab Pane *@


<div class="tab-pane fade" id="result-content" role="tabpanel">
            <div id="result-container">
                <div class="text-center p-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        @* --- Other Main Tab Panes (Placeholders) --- *@
        <div class="tab-pane fade p-3" id="result-tab-pane" role="tabpanel" aria-labelledby="result-tab" tabindex="0">
            ... Result content coming soon ...</div>
        <div class="tab-pane fade p-3" id="chat-tab-pane" role="tabpanel" aria-labelledby="chat-tab" tabindex="0">
            @if (!isConfirmedParticipant)
            {
                <div class="alert alert-warning">
                    <i class="bi bi-info-circle me-2"></i>
                    Only confirmed participants can access the chat room.
                </div>
            }
            else if (Model.Status == ScheduleStatus.PendingSetup || Model.Status == ScheduleStatus.Cancelled)
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Chat room will be available once the competition starts.
                </div>
            }
            else
            {
                <div class="card shadow-sm" style="height: 600px; display: flex; flex-direction: column;">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-chat-dots"></i> Competition Chat Room
                        </h5>
                        <small id="onlineParticipantsStatus">
                            <i class="bi bi-circle-fill text-light"></i>
                            <span id="onlineCount">0</span> participants online
                        </small>
                    </div>

                    <!-- Chat Messages Area -->
                    <div class="card-body overflow-auto" id="chatMessages" style="flex: 1; background-color: #f8f9fa;">
                        <div class="text-center py-5 text-muted">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading chat history...</p>
                        </div>
                    </div>

                    <!-- Chat Input Area -->
                    <div class="card-footer bg-white">
                        @if (Model.Status == ScheduleStatus.Completed)
                        {
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                This competition has ended. You can still view messages but cannot send new ones.
                            </div>
                        }
                        else
                        {
                            <form id="chatForm" onsubmit="sendScheduleMessage(event); return false;">
                                @Html.AntiForgeryToken()
                                <div class="input-group">
                                    <input type="text" class="form-control" id="chatInput" placeholder="Type your message..."
                                        maxlength="2000" required>
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-send-fill"></i> Send
                                    </button>
                                </div>
                                <small class="text-muted">Press Enter to send • Max 2000 characters</small>
                            </form>
                        }
                    </div>
                </div>
            }
        </div>

    </div> @* End Main Tab Content *@

</div> @* End Container *@

<div class="modal fade" id="registerTeamModal" tabindex="-1" aria-labelledby="registerTeamModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-controller="Team" asp-action="CreateTeam" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" name="ScheduleId" value="@Model.ScheduleId" />

                <div class="modal-header">
                    <h5 class="modal-title" id="registerTeamModalLabel">Register Your Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="mb-3">
                        <label for="TeamName" class="form-label">Team Name</label>
                        <input type="text" name="TeamName" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="TeamIconFile" class="form-label">Team Icon (Optional)</label>
                        <input type="file" name="TeamIconFile" class="form-control" accept="image/*" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Team</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="editTeamModal" tabindex="-1" aria-labelledby="editTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-controller="Team" asp-action="EditTeam" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" id="editTeamId" name="TeamId" value="0" />

                <div class="modal-header">
                    <h5 class="modal-title" id="editTeamModalLabel">Edit Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="mb-3">
                        <label for="editTeamName" class="form-label">Team Name</label>
                        <input type="text" id="editTeamName" name="TeamName" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="editTeamIconFile" class="form-label">Team Icon</label>
                        <div class="mb-2 text-center">
<img id="currentTeamIcon" src="" alt="Current Icon"
         style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;"
         loading="lazy" decoding="async"
         onerror="this.onerror=null;this.src='/images/teamdfpic.jpg';" />
                        </div>
                        <input type="file" name="TeamIconFile" class="form-control" accept="image/*" />
                        <small class="form-text text-muted">Upload a new file to replace the current icon.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addStaffModal" tabindex="-1" aria-labelledby="addStaffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addStaffModalLabel">Add Staff Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="staffSearchInput" class="form-label">Search by username:</label>
                    <input type="text" id="staffSearchInput" class="form-control" placeholder="Enter username..." />
                </div>
                <div id="staff-search-spinner" class="text-center d-none">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="staff-search-results">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- *** NEW: Invite Player Modal *** -->
<div class="modal fade" id="invitePlayerModal" tabindex="-1" aria-labelledby="invitePlayerModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invitePlayerModalLabel">Invite Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="inviteTeamId" value="0" />
                <div class="mb-3">
                    <label for="userSearchInput" class="form-label">Search by username:</label>
                    <input type="text" id="userSearchInput" class="form-control" placeholder="Enter username..." />
                </div>
                <div id="invite-search-spinner" class="text-center d-none">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="invite-search-results">
                    <!-- Search results will be injected here by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="startCompetitionModal" tabindex="-1" aria-labelledby="startCompetitionModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <form asp-controller="Match" asp-action="StartCompetition" asp-route-id="@Model.ScheduleId" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="startCompetitionModalLabel">Start Competition</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="startCompetitionModalBody">
                    <div class="text-center p-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading Details...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-play-fill"></i> Confirm and Start
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editMatchModal" tabindex="-1" aria-labelledby="editMatchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-controller="Match" asp-action="UpdateMatchDetails" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" id="editMatchId" name="MatchId" value="0" />

                <div class="modal-header">
                    <h5 class="modal-title" id="editMatchModalLabel">Edit Match Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editMatchTime" class="form-label">Match Time</label>
                        <input type="datetime-local" id="editMatchTime" name="MatchTime" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="editCourt" class="form-label">Court</label>
                        <input type="text" id="editCourt" name="Court" class="form-control"
                            placeholder="e.g. Court 3" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Details</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="alert alert-warning mt-3" id="editWarning" style="display: none;">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <strong>Warning:</strong> Editing a completed match score will reset all subsequent matches in the bracket.
    Teams that have already advanced will need to replay their matches.
</div>

<!-- Set Award Modal -->
<div class="modal fade" id="setAwardModal" tabindex="-1" aria-labelledby="setAwardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="setAwardForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="scheduleId" value="@Model.ScheduleId" />

                <div class="modal-header">
                    <h5 class="modal-title" id="setAwardModalLabel">
                        <i class="bi bi-trophy-fill text-warning me-2"></i>Set Competition Award
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Award must be configured before starting the competition. Winners will be assigned automatically
                        after matches complete.
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Award Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="awardName" value="@Model.GameName Championship"
                            required placeholder="e.g., Summer Championship 2024" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Award Type <span class="text-danger">*</span></label>
                        <select class="form-select" name="awardType" required>
                            <option value="0">🏆 Trophy</option>
                            <option value="1">🥇 Medal</option>
                            <option value="2">🎀 Ribbon</option>
                            <option value="3">👑 Crown</option>
                            <option value="4">⭐ Star</option>
                            <option value="5">👕 Shirt</option>
                            <option value="6">👟 Shoe</option>
                            <option value="7">🎫 Ticket</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea class="form-control" name="description" rows="3"
                            placeholder="Add a special message or achievement description..."></textarea>
                    </div>

                    <div id="setAwardStatus"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-2"></i>Save Award Settings
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Score Modal -->
<div class="modal fade" id="editScoreModal" tabindex="-1" aria-labelledby="editScoreModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <form asp-controller="Match" asp-action="UpdateMatch" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" id="editScoreMatchId" name="MatchId" value="0" />

                <div class="modal-header">
                    <h5 class="modal-title" id="editScoreModalLabel">Edit Match Score</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <!-- Warning Alert -->
                    <div class="alert alert-warning" id="editWarningInModal">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Warning:</strong> Editing a completed match score will reset all subsequent matches in
                        the bracket.
                        Teams that have already advanced will need to replay their matches.
                    </div>

                    <!-- Match Info -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-5">
                                    <h6 id="editTeam1Name" class="mb-0">Team 1</h6>
                                </div>
                                <div class="col-2">
                                    <span class="text-muted">VS</span>
                                </div>
                                <div class="col-5">
                                    <h6 id="editTeam2Name" class="mb-0">Team 2</h6>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Score Input -->
                    <div class="row">
                        <div class="col-md-5">
                            <label class="form-label fw-bold">Team 1 Score</label>
                            <input type="text" id="editTeam1Score" name="Team1Score" class="form-control"
                                placeholder="e.g., 21,19,15"
                                title="Enter scores separated by commas (e.g., 21,19,15)" />
                            <small class="text-muted">Format: 21,19,15</small>
                        </div>
                        <div class="col-md-2 d-flex align-items-center justify-content-center">
                            <div class="text-center mt-4">
                                <i class="bi bi-dash-lg fs-4"></i>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label fw-bold">Team 2 Score</label>
                            <input type="text" id="editTeam2Score" name="Team2Score" class="form-control"
                                placeholder="e.g., 18,21,13"
                                title="Enter scores separated by commas (e.g., 18,21,13)" />
                            <small class="text-muted">Format: 18,21,13</small>
                        </div>
                    </div>

                    <!-- Score Format Help -->
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>How to enter scores:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Enter scores for each set separated by commas</li>
                            <li>Example: <code>21,18,15</code> means Set 1: 21, Set 2: 18, Set 3: 15</li>
                            <li>Number of scores must match for both teams</li>
                        </ul>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-2"></i>Update Score
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="submitRankModal" tabindex="-1" aria-labelledby="submitRankModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="submitRankModalLabel">
                    <i class="bi bi-graph-up-arrow"></i> Submit Competition Results to RANK
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>About RANK System:</strong> This will automatically process all completed matches from this
                    competition and update participant ratings using our DUPR-like algorithm.
                </div>

                <div id="rankSubmissionSummary" class="mb-3" style="display: none;">
                    <h6><i class="bi bi-list-check me-2"></i>Match Summary</h6>
                    <div class="card">
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <h3 class="text-primary mb-0" id="totalMatchesCount">0</h3>
                                    <small class="text-muted">Total Matches</small>
                                </div>
                                <div class="col-md-4">
                                    <h3 class="text-success mb-0" id="singlesMatchesCount">0</h3>
                                    <small class="text-muted">Singles</small>
                                </div>
                                <div class="col-md-4">
                                    <h3 class="text-info mb-0" id="doublesMatchesCount">0</h3>
                                    <small class="text-muted">Doubles</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="rankLoadingSpinner" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading match data...</p>
                </div>

                <div id="rankProcessingStatus" style="display: none;">
                    <!-- Status messages will appear here -->
                </div>

                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Important:</strong>
                    <ul class="mb-0 mt-2">
                        <li>All completed matches will be submitted to RANK</li>
                        <li>Player ratings will be updated based on match results</li>
                        <li>This action cannot be undone</li>
                        <li>Only matches with valid scores will be processed</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAutoSubmitRank" style="display: none;">
                    <i class="bi bi-graph-up-arrow me-2"></i>Submit All Matches to RANK
                </button>
            </div>
        </div>
    </div>
</div>
@await Html.PartialAsync(
    "~/Views/Shared/_PaymentModal.cshtml",
    new ViewDataDictionary(ViewData) {
        ["ScheduleId"] = Model.ScheduleId,
        ["FeeAmount"] = Model.FeeAmount,      // fee per team (competition)
        ["GameName"]   = Model.GameName
    }
)
@section Scripts {
    @* Make sure these scripts are loaded FIRST *@
                <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.14/signalr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-bracket@0.11.0/dist/jquery.bracket.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-bracket@0.11.0/dist/jquery.bracket.min.css" />

    <script>
        // --- Store model data in JS vars for checking ---
        const COMP_DATA = {
            scheduleId: @Model.ScheduleId,
            isSetupComplete: @(Model.Competition != null ? "true" : "false"),
            isDrawPublished: @(Model.Competition?.DrawPublished == true ? "true" : "false"),
            isRoundRobin: @(Model.Competition?.Format == CompetitionFormat.RoundRobin ? "true" : "false"),
            format: '@Model.Competition?.Format'
        };

        // Enable tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // Edit Team modal script
        var editTeamModal = document.getElementById('editTeamModal');
        if (editTeamModal) {
            editTeamModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var teamId = button.getAttribute('data-team-id');
                var teamName = button.getAttribute('data-team-name');
                var teamIconUrl = button.getAttribute('data-team-icon-url');

                var modal = this;
                modal.querySelector('#editTeamId').value = teamId;
                modal.querySelector('#editTeamName').value = teamName;
                modal.querySelector('#currentTeamIcon').src = teamIconUrl;
            });
        }

        // Invite Player modal scripts
        var invitePlayerModal = document.getElementById('invitePlayerModal');
        var userSearchInput = document.getElementById('userSearchInput');
        var searchResultsContainer = document.getElementById('invite-search-results');
        var spinner = document.getElementById('invite-search-spinner');
        var inviteTeamIdInput = document.getElementById('inviteTeamId');
        var searchTimeout;

        if (invitePlayerModal) {
            invitePlayerModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var teamId = button.getAttribute('data-team-id');
                inviteTeamIdInput.value = teamId;
                userSearchInput.value = '';
                searchResultsContainer.innerHTML = '';
            });

            userSearchInput.addEventListener('keyup', function () {
                clearTimeout(searchTimeout);
                var query = userSearchInput.value;
                var teamId = inviteTeamIdInput.value;

                if (query.length < 2) {
                    searchResultsContainer.innerHTML = '';
                    return;
                }

                spinner.classList.remove('d-none');

                searchTimeout = setTimeout(function () {
                    fetch(`/Team/SearchUsersForInvite?teamId=${teamId}&query=${query}`)
                        .then(response => {
                            spinner.classList.add('d-none');
                            if (!response.ok) {
                                throw new Error('Search failed');
                            }
                            return response.json();
                        })
                        .then(users => {
                            renderSearchResults(users, teamId);
                        })
                        .catch(error => {
                            searchResultsContainer.innerHTML = '<p class="text-danger">Error searching users.</p>';
                        });
                }, 500);
            });
        }

        // Global function to show edit score modal
        window.showEditScoreModal = function (matchId, team1Name, team2Name, team1Score, team2Score, isCompleted) {
            console.log('Opening edit score modal for match', matchId);

            var modal = document.getElementById('editScoreModal');
            if (!modal) {
                console.error('Edit score modal not found');
                return;
            }

            // Populate modal fields
            document.getElementById('editScoreMatchId').value = matchId;
            document.getElementById('editTeam1Name').textContent = team1Name || 'Team 1';
            document.getElementById('editTeam2Name').textContent = team2Name || 'Team 2';
            document.getElementById('editTeam1Score').value = team1Score || '';
            document.getElementById('editTeam2Score').value = team2Score || '';

            // Show/hide warning based on completion status
            var warning = document.getElementById('editWarningInModal');
            if (warning) {
                if (isCompleted) {
                    warning.style.display = 'block';
                } else {
                    warning.style.display = 'none';
                }
            }

            // Show the modal
            var bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        };

        console.log('✓ Edit Score Modal function registered');

        function renderSearchResults(users, teamId) {
            searchResultsContainer.innerHTML = '';
            if (users.length === 0) {
                searchResultsContainer.innerHTML = '<p class="text-muted">No users found.</p>';
                return;
            }

            users.forEach(user => {
                var profilePic = user.profilePicture ? user.profilePicture : '/images/profile_image.jpg';
                
                // ⬇️ NEW: Determine button state
                var buttonHtml = '';
                
                if (user.isEligible) {
                    // Show Invite Button
                    buttonHtml = `
                        <button class="btn btn-sm btn-primary send-invite-btn" 
                                data-team-id="${teamId}" 
                                data-invitee-id="${user.userId}">
                            Invite
                        </button>`;
                } else {
                    // Show Disabled Button with Reason
                    buttonHtml = `
                        <button class="btn btn-sm btn-secondary" disabled 
                                title="User does not meet requirements: ${user.reason}">
                            <i class="bi bi-slash-circle me-1"></i>${user.reason}
                        </button>`;
                }

                var userHtml = `
                    <div class="user-search-item">
                        <div class="d-flex align-items-center">
                            <img src="${profilePic}" alt="${user.username}" />
                            <strong>${user.username}</strong>
                        </div>
                        ${buttonHtml}
                    </div>`;
                    
                searchResultsContainer.insertAdjacentHTML('beforeend', userHtml);
            });

            // Re-attach events only for active buttons
            document.querySelectorAll('.send-invite-btn').forEach(button => {
                button.addEventListener('click', sendInvite);
            });
        }

        function sendInvite(event) {
            var button = event.target;
            var teamId = button.getAttribute('data-team-id');
            var inviteeId = button.getAttribute('data-invitee-id');
            var token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

            fetch('/Team/SendInvite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token
                },
                body: `teamId=${teamId}&inviteeUserId=${inviteeId}`
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || 'Failed to send invite') });
                    }
                    return response.json();
                })
                .then(data => {
                    button.innerHTML = 'Sent!';
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-secondary');
                })
                .catch(error => {
                    button.innerHTML = 'Error';
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-danger');
                    alert('Error: ' + error.message);
                });
        }

        // Add Staff Modal Scripts
        var addStaffModal = document.getElementById('addStaffModal');
        var staffSearchInput = document.getElementById('staffSearchInput');
        var staffSearchResultsContainer = document.getElementById('staff-search-results');
        var staffSpinner = document.getElementById('staff-search-spinner');
        var staffSearchTimeout;

        if (addStaffModal) {
            addStaffModal.addEventListener('show.bs.modal', function (event) {
                staffSearchInput.value = '';
                staffSearchResultsContainer.innerHTML = '';
            });

            staffSearchInput.addEventListener('keyup', function () {
                clearTimeout(staffSearchTimeout);
                var query = staffSearchInput.value;
                var scheduleId = COMP_DATA.scheduleId;

                if (query.length < 2) {
                    staffSearchResultsContainer.innerHTML = '';
                    return;
                }

                staffSpinner.classList.remove('d-none');

                staffSearchTimeout = setTimeout(function () {
                    fetch(`/Competition/SearchUsersForStaff?scheduleId=${scheduleId}&query=${query}`)
                        .then(response => {
                            staffSpinner.classList.add('d-none');
                            if (!response.ok) {
                                throw new Error('Search failed');
                            }
                            return response.json();
                        })
                        .then(users => {
                            renderStaffSearchResults(users, scheduleId);
                        })
                        .catch(error => {
                            staffSearchResultsContainer.innerHTML = '<p class="text-danger">Error searching users.</p>';
                        });
                }, 500);
            });
        }

        function renderStaffSearchResults(users, scheduleId) {
            staffSearchResultsContainer.innerHTML = '';
            if (users.length === 0) {
                staffSearchResultsContainer.innerHTML = '<p class="text-muted">No users found or user is already a participant.</p>';
                return;
            }

            users.forEach(user => {
                var profilePic = user.profilePicture ? user.profilePicture : '/images/profile_image.jpg';
                var userHtml = `
                                    <div class="user-search-item">
                                        <div class="d-flex align-items-center">
                                            <img src="${profilePic}" alt="${user.username}" />
                                            <strong>${user.username}</strong>
                                        </div>
                                        <button class="btn btn-sm btn-primary add-staff-btn" 
                                                data-schedule-id="${scheduleId}" 
                                                data-user-id="${user.userId}">
                                            Add Staff
                                        </button>
                                    </div>`;
                staffSearchResultsContainer.insertAdjacentHTML('beforeend', userHtml);
            });

            document.querySelectorAll('.add-staff-btn').forEach(button => {
                button.addEventListener('click', addStaffMember);
            });
        }

        function addStaffMember(event) {
            var button = event.target;
            var scheduleId = button.getAttribute('data-schedule-id');
            var userId = button.getAttribute('data-user-id');
            var token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

            fetch('/Competition/AddStaff', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token
                },
                body: `scheduleId=${scheduleId}&userId=${userId}`
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || 'Failed to add staff') });
                    }
                    return response.json();
                })
                .then(data => {
                    button.innerHTML = 'Added!';
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-secondary');
                    location.reload();
                })
                .catch(error => {
                    button.innerHTML = 'Error';
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-danger');
                    alert('Error: ' + error.message);
                });
        }

        // Competition Poster Toggle
        var posterCollapseElement = document.getElementById('posterCollapse');
        var posterTriggerElement = document.querySelector('[data-bs-target="#posterCollapse"]');

        if (posterCollapseElement && posterTriggerElement) {
            var posterIcon = posterTriggerElement.querySelector('.toggle-icon');

            if (posterIcon) {
                posterCollapseElement.addEventListener('show.bs.collapse', function () {
                    posterIcon.classList.add('rotated');
                });

                posterCollapseElement.addEventListener('hide.bs.collapse', function () {
                    posterIcon.classList.remove('rotated');
                });
            }
        }

        // Start Competition Button Logic
        var startCompBtn = document.getElementById('startCompetitionBtn');
        if (startCompBtn) {
            var startModal = new bootstrap.Modal(document.getElementById('startCompetitionModal'));
            var startModalBody = document.getElementById('startCompetitionModalBody');

            startCompBtn.addEventListener('click', function (event) {
                event.preventDefault();

                if (!COMP_DATA.isSetupComplete) {
                    alert('Please complete "Match Setup & Format" before starting.');
                    return;
                }

                if (!COMP_DATA.isRoundRobin && !COMP_DATA.isDrawPublished) {
                    alert('Please publish the draw before starting the competition.');
                    return;
                }

                // ⬇️ ADD THIS NEW CHECK
                // Check if award is configured
                fetch('/Award/CheckAwardSettings?scheduleId=' + COMP_DATA.scheduleId)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.hasAwardSettings) {
                            alert('Please configure award settings in the Actions dropdown before starting the competition.');
                            return;
                        }

                        // If all checks pass, show the confirmation modal
                        startModalBody.innerHTML = `
                                    <div class="text-center p-5">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading Details...</span>
                                        </div>
                                    </div>`;
                        startModal.show();

                        fetch(`/Match/GetConfirmationDetails/${COMP_DATA.scheduleId}`)
                            .then(response => response.text())
                            .then(html => {
                                startModalBody.innerHTML = html;
                            })
                            .catch(err => {
                                startModalBody.innerHTML = '<div class="alert alert-danger">Could not load details. Please try again.</div>';
                            });
                    })
                    .catch(error => {
                        alert('Failed to check award settings. Please try again.');
                    });
            });
        }

        // *** LISTING TAB LOADING (Pool Play & Elimination) ***
        var listingTab = document.getElementById('listing-subtab');
        if (listingTab) {
            var listingLoaded = false;

            listingTab.addEventListener('show.bs.tab', function (event) {
                if (!listingLoaded) {
                    loadListing();
                    listingLoaded = true;
                }
            });

            function loadListing() {
                var container = document.getElementById('listing-container');
                if (!container) return;

                console.log('Loading listing for schedule:', COMP_DATA.scheduleId);
                container.innerHTML = `
                                <div class="text-center p-5">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading Matches...</span>
                                    </div>
                                    <p class="mt-2">Loading Matches...</p>
                                </div>`;

                fetch('/Match/GetMatchListing?id=' + COMP_DATA.scheduleId)
                    .then(response => {
                        console.log('Listing response status:', response.status);
                        if (!response.ok) {
                            throw new Error('HTTP error ' + response.status);
                        }
                        return response.text();
                    })
                    .then(html => {
                        console.log('Listing HTML received, length:', html.length);
                        container.innerHTML = html;

                        // *** IMPORTANT: Set up match card handlers AFTER HTML is loaded ***
                        setupMatchCardHandlers();
                    })
                    .catch(error => {
                        console.error('Failed to load listing:', error);
                        container.innerHTML =
                            '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Failed to load match listing: ' + error.message + '</div>';
                    });
            }
        }

        window.switchToStandingTab = function () {
            console.log('switchToStandingTab called');

            // First, ensure we're on the Match main tab
            var matchTab = document.getElementById('match-tab');
            if (matchTab) {
                var tab = new bootstrap.Tab(matchTab);
                tab.show();
                console.log('Switched to Match tab');
            }

            // Wait a bit, then switch to Standing sub-tab
            setTimeout(function () {
                var standingTab = document.getElementById('standing-subtab');
                if (standingTab) {
                    var subtab = new bootstrap.Tab(standingTab);
                    subtab.show();
                    console.log('Switched to Standing sub-tab');
                } else {
                    console.error('Standing tab not found');
                }
            }, 300);
        };

        // *** MATCH CARD HANDLERS - Called after listing is loaded ***
        function setupMatchCardHandlers() {
            console.log('Setting up match card event handlers...');

            // *** SIMPLIFIED: Check round name pattern to determine pool vs playoff ***
            $(document).on('submit', '.match-form', function (e) {
                var $form = $(this);
                var roundName = $form.data('round-name');

                if (!roundName) {
                    console.log('No round name on form, skipping');
                    return true;
                }

                console.log('Form submitting with round name:', roundName);

                var cleanRoundName = String(roundName).trim();

                // Check if this is a pool round (starts with "Pool")
                if (cleanRoundName.startsWith('Pool ')) {
                    console.log('✓ POOL match detected, storing:', cleanRoundName);
                    sessionStorage.setItem('activePoolTab', cleanRoundName);
                    sessionStorage.removeItem('activeSubTab');
                }
                // Check if this is a playoff round
                else if (cleanRoundName.includes('Final') ||
                    cleanRoundName.includes('Semi') ||
                    cleanRoundName.includes('Quarter') ||
                    cleanRoundName.includes('Round of') ||
                    cleanRoundName.includes('3rd Place')) {
                    console.log('✓ PLAYOFF match detected, storing flag');
                    sessionStorage.setItem('activeSubTab', 'playoff');
                    sessionStorage.removeItem('activePoolTab');
                }
                else {
                    console.log('⚠ Unknown round type, no storage:', cleanRoundName);
                }

                return true;
            });

            // Add Set button
            $(document).off('click', '.btn-add-set').on('click', '.btn-add-set', function () {
                var matchId = $(this).data('match-id');
                console.log('Add set clicked for match', matchId);

                var $matchContainer = $('#match-' + matchId);
                if ($matchContainer.length === 0) {
                    console.error('Match container not found for ID:', matchId);
                    return;
                }

                var $formContainer = $matchContainer.find('.organizer-match-form');

                var $newSetT1 = $('<input type="number" class="form-control form-control-sm score-set-input" data-team-score="1" min="0" placeholder="0" />');
                var $newSetT2 = $('<input type="number" class="form-control form-control-sm score-set-input" data-team-score="2" min="0" placeholder="0" />');
                $formContainer.find('.score-sets-container[data-team-id="1"]').append($newSetT1);
                $formContainer.find('.score-sets-container[data-team-id="2"]').append($newSetT2);

                var $titleContainer = $matchContainer.find('.score-set-titles');
                var newSetNum = $titleContainer.find('.score-set-title').length + 1;
                $titleContainer.append('<span class="score-set-title">Set ' + newSetNum + '</span>');

                console.log('Set added successfully');
            });

            // Minus Set button
            $(document).off('click', '.btn-minus-set').on('click', '.btn-minus-set', function () {
                var matchId = $(this).data('match-id');
                console.log('Minus set clicked for match', matchId);

                var $matchContainer = $('#match-' + matchId);
                if ($matchContainer.length === 0) {
                    console.error('Match container not found for ID:', matchId);
                    return;
                }

                var $formContainer = $matchContainer.find('.organizer-match-form');

                var $team1Inputs = $formContainer.find('.score-sets-container[data-team-id="1"] .score-set-input');
                var $team2Inputs = $formContainer.find('.score-sets-container[data-team-id="2"] .score-set-input');

                if ($team1Inputs.length > 1) {
                    $team1Inputs.last().remove();
                    $team2Inputs.last().remove();

                    var $titleContainer = $matchContainer.find('.score-set-titles');
                    $titleContainer.find('.score-set-title').last().remove();

                    console.log('Set removed successfully');
                } else {
                    alert('At least one set is required.');
                }
            });

            // Save Score form submission
            $(document).off('submit', '.save-score-form').on('submit', '.save-score-form', function (e) {
                e.preventDefault();

                var matchId = $(this).data('match-id');
                console.log('Save score form submitted for match', matchId);

                var $form = $(this);
                var $matchContainer = $('#match-' + matchId);

                if ($matchContainer.length === 0) {
                    console.error('Match container not found for ID:', matchId);
                    return false;
                }

                var $formContainer = $matchContainer.find('.organizer-match-form');

                var scoresT1 = $formContainer.find('input[data-team-score="1"]').map(function () {
                    return $(this).val() || "0";
                }).get().join(',');

                var scoresT2 = $formContainer.find('input[data-team-score="2"]').map(function () {
                    return $(this).val() || "0";
                }).get().join(',');

                console.log('Team1 Score:', scoresT1);
                console.log('Team2 Score:', scoresT2);

                $form.find('.hidden-team1-score').val(scoresT1);
                $form.find('.hidden-team2-score').val(scoresT2);

                console.log('Form data:', $form.serialize());

                this.submit();
                return true;
            });

            console.log('Match card event handlers ready!');
        }

        // *** STANDING TAB LOADING (Pool Play Only) ***
        var standingTab = document.getElementById('standing-subtab');
        if (standingTab) {
            var standingLoaded = false;

            standingTab.addEventListener('show.bs.tab', function (event) {
                if (!standingLoaded) {
                    // choose endpoint based on format
                    var url = COMP_DATA.isRoundRobin
                        ? '/Standing/GetRoundRobinStandings?id=' + COMP_DATA.scheduleId
                        : '/Standing/GetPoolStandings?id=' + COMP_DATA.scheduleId;

                    fetch(url)
                        .then(r => r.text())
                        .then(html => {
                            var container = document.getElementById('standing-container');
                            if (container) {
                                container.innerHTML = html;
                            }
                            standingLoaded = true;
                        })
                        .catch(err => console.error('Failed to load standings', err));
                }
            });

            function loadStanding() {
                var container = document.getElementById('standing-container');
                if (!container) return;

                console.log('Loading standing for schedule:', COMP_DATA.scheduleId);
                container.innerHTML = `
                                    <div class="text-center p-5">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading Standings...</span>
                                        </div>
                                    </div>`;

                // choose appropriate endpoint for current format
                var endpoint = COMP_DATA.isRoundRobin
                    ? '/Standing/GetRoundRobinStandings?id=' + COMP_DATA.scheduleId
                    : '/Standing/GetPoolStandings?id=' + COMP_DATA.scheduleId;
                fetch(endpoint)
                     .then(response => {
                         console.log('Standing response status:', response.status);
                         if (!response.ok) {
                             throw new Error('HTTP error ' + response.status);
                         }
                         return response.text();
                     })
                     .then(html => {
                         console.log('Standing HTML received, length:', html.length);
                         container.innerHTML = html;
                     })
                     .catch(error => {
                         console.error('Failed to load standing:', error);
                         container.innerHTML =
                             '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Failed to load standings: ' + error.message + '</div>';
                     });
            }
        }

        // *** DRAW TAB LOADING (Pool Play & Elimination) ***
        var drawTab = document.getElementById('draw-subtab');
        if (drawTab) {
            var drawContainer = document.getElementById('draw-visual-container');
            var drawLoaded = false;
            var pollInterval = null;

            drawTab.addEventListener('show.bs.tab', function (event) {
                if (drawContainer && !drawLoaded) {
                    drawLoaded = true;

                    console.log('Loading draw visual...');

                    drawContainer.innerHTML = `
                                        <div class="text-center p-5">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Loading Draw...</span>
                                            </div>
                                            <p class="mt-2">Loading Draw...</p>
                                        </div>
                                    `;

                    var competitionFormat = COMP_DATA.format;
                    console.log('Competition Format:', competitionFormat);

                    if (competitionFormat === 'PoolPlay') {
                        // Load Pool Play Draw
                        fetch('/Draw/ViewPoolPlayDraw?id=' + COMP_DATA.scheduleId)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('HTTP ' + response.status);
                                }
                                return response.text();
                            })
                            .then(html => {
                                drawContainer.innerHTML = html;
                                console.log('Pool Play draw loaded successfully');

                                // *** NEW: Initialize playoff bracket after HTML is loaded ***
                                setTimeout(function () {
                                    initializePoolPlayDrawScripts();
                                }, 200);
                            })
                            .catch(error => {
                                console.error('Failed to load Pool Play draw:', error);
                                drawContainer.innerHTML = `
                                                    <div class="alert alert-danger">
                                                        <strong>Error:</strong> Could not load the draw.
                                                        <br><small>${error.message}</small>
                                                    </div>
                                                `;
                            });
                    } else if (competitionFormat === 'Elimination') {
                        // Load Bracket for Elimination
                        drawContainer.innerHTML = `
                                            <h5 class="mb-3">Tournament Bracket</h5>
                                            <div id="bracketVisual_Published" style="width: 100%; overflow: auto; min-height: 600px; border: 1px solid #ddd; background-color: #fcfcfc;"></div>
                                            <div id="thirdPlaceContainer" class="mt-3" style="min-height: 56px;"></div>
                                        `;

                        function fetchAndRenderBracket() {
                            fetch('/Match/GetBracketData?scheduleId=' + COMP_DATA.scheduleId)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('HTTP ' + response.status);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    console.log('Bracket data received:', data);

                                    if (!data || !data.bracketData) {
                                        throw new Error('No bracket data in response');
                                    }

                                    renderBracket(data.bracketData, data.roundHeaders, data.hasThirdPlaceMatch, data.thirdPlace);
                                })
                                .catch(error => {
                                    console.error('Failed to load bracket:', error);
                                    drawContainer.innerHTML = `
                                                        <div class="alert alert-danger">
                                                            <strong>Error:</strong> Could not load the bracket.
                                                            <br><small>${error.message}</small>
                                                            <br><br>
                                                            <button class="btn btn-sm btn-primary" onclick="location.reload()">Reload Page</button>
                                                        </div>
                                                    `;
                                });
                        }

                        function renderBracket(bracketData, roundHeaders, hasThirdPlace, thirdPlaceData) {
                            try {
                                if (typeof $ === 'undefined') {
                                    throw new Error('jQuery is not loaded');
                                }

                                if (typeof $.fn.bracket === 'undefined') {
                                    throw new Error('jQuery Bracket plugin is not loaded');
                                }

                                var bracketElement = $('#bracketVisual_Published');
                                if (bracketElement.length === 0) {
                                    throw new Error('Bracket container not found');
                                }

                                console.log('Initializing bracket with data:', bracketData);

                                bracketElement.empty();

                                bracketElement.bracket({
                                    init: bracketData,
                                    teamWidth: 170,
                                    scoreWidth: 30,
                                    roundMargin: 40,
                                    skipConsolationRound: true
                                });

                                setTimeout(function () {
                                    $('#bracketVisual_Published .round').each(function (index) {
                                        if (roundHeaders && roundHeaders[index]) {
                                            if ($(this).find('.round-header').length === 0) {
                                                $(this).prepend('<div class="round-header">' + roundHeaders[index] + '</div>');
                                            }
                                        }
                                    });

                                    $('#bracketVisual_Published .score').each(function () {
                                        var scoreText = $(this).text().trim();
                                        if (scoreText === '1') {
                                            $(this).text('W').css({ 'color': '#198754', 'font-weight': 'bold' });
                                        } else if (scoreText === '0') {
                                            $(this).text('L').css({ 'color': '#dc3545', 'font-weight': 'bold' });
                                        }
                                    });
                                }, 100);

                                console.log('Bracket rendered successfully!');
                                renderThirdPlaceMatch(thirdPlaceData);

                            } catch (e) {
                                console.error('Error rendering bracket:', e);
                                drawContainer.innerHTML = `
                                                    <div class="alert alert-danger">
                                                        <strong>Error:</strong> Could not render bracket.
                                                        <br><small>${e.message}</small>
                                                    </div>
                                                `;
                            }
                        }



                        function renderThirdPlaceMatch(thirdPlaceData) {
                            var thirdEl = document.getElementById('thirdPlaceContainer');
                            if (!thirdEl) return;

                            if (!thirdPlaceData) {
                                thirdEl.innerHTML = '';
                                thirdEl.style.display = 'none';
                                return;
                            }

                            thirdEl.style.display = 'block';

                            var team1Name = thirdPlaceData.team1 || 'TBD';
                            var team2Name = thirdPlaceData.team2 || 'TBD';
                            var winnerIndex = thirdPlaceData.winnerIndex;

                            var team1Class = (winnerIndex === 0) ? 'fw-bold text-success' : '';
                            var team2Class = (winnerIndex === 1) ? 'fw-bold text-success' : '';

                            var team1Display = '<span class="' + team1Class + '">' + team1Name;
                            if (winnerIndex === 0) team1Display += ' <i class="bi bi-trophy-fill text-warning"></i>';
                            team1Display += '</span>';

                            var team2Display = '<span class="' + team2Class + '">' + team2Name;
                            if (winnerIndex === 1) team2Display += ' <i class="bi bi-trophy-fill text-warning"></i>';
                            team2Display += '</span>';

                            var cardHTML = '<div class="card shadow-sm">' +
                                '<div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">' +
                                '<strong><i class="bi bi-award-fill me-2"></i>3rd Place Match</strong>';

                            if (thirdPlaceData.status) {
                                if (thirdPlaceData.status === 'Done') {
                                    cardHTML += '<span class="badge bg-success">Completed</span>';
                                } else if (thirdPlaceData.status === 'Active' || thirdPlaceData.status === 'Progressing') {
                                    cardHTML += '<span class="badge bg-warning text-dark">' + thirdPlaceData.status + '</span>';
                                }
                            }

                            cardHTML += '</div><div class="card-body">' +
                                '<div class="d-flex justify-content-around align-items-center">' +
                                '<div class="text-center" style="flex: 1;">' + team1Display + '</div>' +
                                '<div class="text-muted fw-bold">VS</div>' +
                                '<div class="text-center" style="flex: 1;">' + team2Display + '</div>' +
                                '</div>';

                            if (winnerIndex === 0 || winnerIndex === 1) {
                                var winnerName = (winnerIndex === 0) ? team1Name : team2Name;
                                cardHTML += '<hr class="my-2"><div class="text-center text-success">' +
                                    '<strong><i class="bi bi-trophy-fill text-warning me-1"></i>3rd Place: ' + winnerName + '</strong>' +
                                    '</div>';
                            }

                            cardHTML += '</div></div>';
                            thirdEl.innerHTML = cardHTML;
                        }

                        fetchAndRenderBracket();
                        pollInterval = setInterval(fetchAndRenderBracket, 5000);
                    }
                }
            });

            drawTab.addEventListener('hide.bs.tab', function (event) {
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
            });
        }

        // *** NEW FUNCTION: Initialize Pool Play Draw Scripts ***
        function initializePoolPlayDrawScripts() {
            console.log('=== Initializing Pool Play Draw Scripts ===');

            var playoffBracketTab = document.getElementById('playoff-bracket-tab');
            var playoffBracketVisual = document.getElementById('playoffBracketVisual');

            if (!playoffBracketTab) {
                console.warn('playoff-bracket-tab not found, skipping playoff initialization');
                return;
            }

            if (!playoffBracketVisual) {
                console.warn('playoffBracketVisual not found, skipping playoff initialization');
                return;
            }

            console.log('Found playoff bracket elements');

            var playoffContent = document.getElementById('playoff-bracket-content');
            if (!playoffContent) {
                console.warn('playoff-bracket-content not found');
                return;
            }

            var isPending = playoffContent.querySelector('.alert-info') !== null;

            if (isPending) {
                console.log('Playoff is pending, not initializing bracket');
                return;
            }

            console.log('Playoff is active/completed, setting up bracket');

            var pollInterval = null;
            var isInitialized = false;

            playoffBracketTab.addEventListener('shown.bs.tab', function (event) {
                console.log('✓ Playoff bracket tab SHOWN event fired');

                if (!isInitialized) {
                    isInitialized = true;
                    console.log('>>> Initializing playoff bracket for the first time');

                    setTimeout(function () {
                        fetchAndRenderPlayoffBracket();
                        pollInterval = setInterval(fetchAndRenderPlayoffBracket, 5000);
                    }, 300);
                }
            });

            playoffBracketTab.addEventListener('hidden.bs.tab', function () {
                if (pollInterval) {
                    console.log('Stopping playoff bracket polling');
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
            });

            function fetchAndRenderPlayoffBracket() {
                console.log('Fetching playoff bracket data from API...');

                fetch('/Match/GetPlayoffBracketData?scheduleId=' + COMP_DATA.scheduleId)
                    .then(response => {
                        console.log('API response status:', response.status);
                        if (!response.ok) {
                            throw new Error('HTTP ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('✓ Playoff bracket data received:', data);
                        renderPlayoffBracket(data);
                    })
                    .catch(error => {
                        console.error('✗ Failed to load playoff bracket:', error);
                        var container = document.getElementById('playoffBracketVisual');
                        if (container) {
                            container.innerHTML = '<div class="alert alert-danger">Could not load playoff bracket: ' + error.message + '</div>';
                        }
                    });
            }

            function renderPlayoffBracket(response) {
                var container = document.getElementById('playoffBracketVisual');
                if (!container) {
                    console.error('playoffBracketVisual container not found in DOM!');
                    return;
                }

                console.log('Rendering bracket in container...');

                try {
                    if (typeof $ === 'undefined') {
                        throw new Error('jQuery is not loaded');
                    }

                    if (typeof $.fn.bracket === 'undefined') {
                        throw new Error('jQuery Bracket plugin is not loaded');
                    }

                    console.log('✓ jQuery and Bracket plugin verified');

                    $(container).empty();

                    if (!response.bracketData || !response.bracketData.teams || response.bracketData.teams.length === 0) {
                        console.warn('No bracket data available');
                        container.innerHTML = '<div class="alert alert-info">No playoff matches available yet.</div>';
                        return;
                    }

                    console.log('Initializing jQuery bracket with data:', response.bracketData);

                    $(container).bracket({
                        init: response.bracketData,
                        teamWidth: 170,
                        scoreWidth: 30,
                        roundMargin: 40,
                        skipConsolationRound: true
                    });

                    console.log('✓ Bracket rendered, applying styling...');

                    setTimeout(function () {
                        $('#playoffBracketVisual .score').each(function () {
                            var scoreText = $(this).text().trim();
                            if (scoreText === '1') {
                                $(this).text('W').css({ 'color': '#198754', 'font-weight': 'bold' });
                            } else if (scoreText === '0') {
                                $(this).text('L').css({ 'color': '#dc3545', 'font-weight': 'bold' });
                            }
                        });

                        if (response.roundHeaders) {
                            $('#playoffBracketVisual .round').each(function (index) {
                                if (response.roundHeaders[index] && $(this).find('.round-header').length === 0) {
                                    $(this).prepend('<div class="round-header">' + response.roundHeaders[index] + '</div>');
                                }
                            });
                        }

                        console.log('✓ Bracket styling complete');
                    }, 150);

                } catch (err) {
                    console.error('✗ Bracket rendering failed:', err);
                    container.innerHTML = '<div class="alert alert-danger">Could not render bracket: ' + err.message +
                        '<br><br><strong>Debug Info:</strong><pre>' + JSON.stringify(response.bracketData, null, 2) + '</pre></div>';
                }

                renderThirdPlaceMatch(response.thirdPlace);
            }

            function renderThirdPlaceMatch(thirdPlaceData) {
                var thirdEl = document.getElementById('playoffThirdPlaceContainer');
                if (!thirdEl) return;

                if (!thirdPlaceData) {
                    thirdEl.innerHTML = '';
                    thirdEl.style.display = 'none';
                    return;
                }

                thirdEl.style.display = 'block';

                var team1Name = thirdPlaceData.team1 || 'TBD';
                var team2Name = thirdPlaceData.team2 || 'TBD';
                var winnerIndex = thirdPlaceData.winnerIndex;

                var team1Class = (winnerIndex === 0) ? 'fw-bold text-success' : '';
                var team2Class = (winnerIndex === 1) ? 'fw-bold text-success' : '';

                var team1Display = '<span class="' + team1Class + '">' + team1Name;
                if (winnerIndex === 0) team1Display += ' <i class="bi bi-trophy-fill text-warning"></i>';
                team1Display += '</span>';

                var team2Display = '<span class="' + team2Class + '">' + team2Name;
                if (winnerIndex === 1) team2Display += ' <i class="bi bi-trophy-fill text-warning"></i>';
                team2Display += '</span>';

                var cardHTML = '<div class="card shadow-sm">' +
                    '<div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">' +
                    '<strong><i class="bi bi-award-fill me-2"></i>3rd Place Match</strong>';

                if (thirdPlaceData.status) {
                    if (thirdPlaceData.status === 'Done') {
                        cardHTML += '<span class="badge bg-success">Completed</span>';
                    } else if (thirdPlaceData.status === 'Active' || thirdPlaceData.status === 'Progressing') {
                        cardHTML += '<span class="badge bg-warning text-dark">' + thirdPlaceData.status + '</span>';
                    }
                }

                cardHTML += '</div><div class="card-body">' +
                    '<div class="d-flex justify-content-around align-items-center">' +
                    '<div class="text-center" style="flex: 1;">' + team1Display + '</div>' +
                    '<div class="text-muted fw-bold">VS</div>' +
                    '<div class="text-center" style="flex: 1;">' + team2Display + '</div>' +
                    '</div>';

                if (winnerIndex === 0 || winnerIndex === 1) {
                    var winnerName = (winnerIndex === 0) ? team1Name : team2Name;
                    cardHTML += '<hr class="my-2"><div class="text-center text-success">' +
                        '<strong><i class="bi bi-trophy-fill text-warning me-1"></i>3rd Place: ' + winnerName + '</strong>' +
                        '</div>';
                }

                cardHTML += '</div></div>';
                thirdEl.innerHTML = cardHTML;
            }

            console.log('=== Pool Play Draw Scripts Initialized ===');
        }

        // Auto-open tab from URL
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const tabToOpen = urlParams.get('tab');

            if (tabToOpen === 'match-listing') {
                var mainMatchTab = document.getElementById('match-tab');
                if (mainMatchTab) {
                    new bootstrap.Tab(mainMatchTab).show();
                }

                var subListingTab = document.getElementById('listing-subtab');
                if (subListingTab) {
                    new bootstrap.Tab(subListingTab).show();
                }
            }
        });

        // Edit Match Time/Court Modal
        var editMatchModal = document.getElementById('editMatchModal');
        if (editMatchModal) {
            editMatchModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;

                var matchId = button.getAttribute('data-match-id');
                var matchTime = button.getAttribute('data-match-time');
                var court = button.getAttribute('data-court');

                var modal = this;
                modal.querySelector('#editMatchId').value = matchId;
                modal.querySelector('#editMatchTime').value = matchTime;
                modal.querySelector('#editCourt').value = court;
            });
        }


        // Restore active pool tab after page reload
        $(document).ready(function () {
            var activeSubTab = sessionStorage.getItem('activeSubTab');
            var activePoolTab = sessionStorage.getItem('activePoolTab');

            console.log('Checking stored tabs - SubTab:', activeSubTab, 'PoolTab:', activePoolTab);

            if (!activeSubTab && !activePoolTab) {
                console.log('No stored tabs to restore');
                return;
            }

            // Wait for listing to load first
            setTimeout(function () {
                if (activeSubTab === 'playoff') {
                    console.log('Restoring playoff sub-tab');

                    // Find ANY tab with "playoff" in ID or text
                    var $playoffTab = $('#playoff-subtab, button[id*="playoff"], button:contains("Playoff")').first();

                    if ($playoffTab.length > 0) {
                        console.log('Found playoff tab, activating...');
                        var tab = new bootstrap.Tab($playoffTab[0]);
                        tab.show();
                        sessionStorage.removeItem('activeSubTab');
                    } else {
                        console.warn('Playoff tab not found in DOM');
                    }
                } else if (activePoolTab) {
                    console.log('Attempting to restore pool tab:', activePoolTab);

                    // Find the pool tab button with matching text
                    var $poolTabs = $('#poolTabs button[data-bs-toggle="pill"], #poolTabs button[data-bs-toggle="tab"]');

                    $poolTabs.each(function () {
                        var $button = $(this);
                        var buttonText = $button.text().trim();

                        // Remove any badges/symbols and normalize whitespace
                        var poolName = buttonText.replace(/[✓✔]/g, '').trim().split(/\s{2,}/)[0].trim();

                        console.log('Comparing: "' + poolName + '" with "' + activePoolTab + '"');

                        if (poolName === activePoolTab) {
                            console.log('Match found! Activating pool tab:', poolName);

                            var tab = new bootstrap.Tab($button[0]);
                            tab.show();

                            sessionStorage.removeItem('activePoolTab');
                            return false; // Break loop
                        }
                    });
                }
            }, 300);
        });
        window.switchToPlayoffBracketTab = function () {
            console.log('switchToPlayoffBracketTab called');

            // First, switch to Draw main tab
            var drawTab = document.getElementById('draw-subtab');
            if (drawTab) {
                var tab = new bootstrap.Tab(drawTab);
                tab.show();
                console.log('Switched to Draw tab');
            }

            // Wait a bit, then switch to Playoff Bracket sub-tab
            setTimeout(function () {
                var playoffTab = document.getElementById('playoff-bracket-tab');
                if (playoffTab) {
                    var subtab = new bootstrap.Tab(playoffTab);
                    subtab.show();
                    console.log('Switched to Playoff Bracket sub-tab');
                } else {
                    console.error('Playoff bracket tab not found');
                }
            }, 500);
        };

        // *** NEW: Global function for Advance to Playoff ***
        window.advanceToPlayoff = function (scheduleId) {
            const button = event.target;
            const statusDiv = document.getElementById('advance-status');

            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

            console.log('Advancing to playoff for schedule:', scheduleId);

            // Get anti-forgery token
            var token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            fetch('/Match/AdvanceToPlayoff?scheduleId=' + scheduleId, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': token // *** FIXED: Pass token in header ***
                }
            })
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error('HTTP error ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);

                    if (data.success) {
                        statusDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle-fill me-2"></i>' + data.message + '</div>';

                        // Reload the page after 1.5 seconds to show playoff bracket
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle-fill me-2"></i>' + data.message + '</div>';
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-trophy-fill me-2"></i>Advance to Playoff';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle-fill me-2"></i>Failed to advance to playoff: ' + error.message + '</div>';
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-trophy-fill me-2"></i>Advance to Playoff';
                });
        };

        // *** RESULT TAB LOADING ***
        var resultTab = document.getElementById('result-subtab');
        if (resultTab) {
            var resultContainer = document.getElementById('result-container');
            var resultLoaded = false;

            resultTab.addEventListener('show.bs.tab', function (event) {
                if (resultContainer && !resultLoaded) {
                    resultLoaded = true;

                    console.log('Loading results...');

                    fetch('/Award/GetAwards?scheduleId=' + COMP_DATA.scheduleId)
                        .then(response => response.text())
                        .then(html => {
                            resultContainer.innerHTML = html;
                            console.log('Results loaded successfully');
                        })
                        .catch(error => {
                            console.error('Failed to load results:', error);
                            resultContainer.innerHTML = '<div class="alert alert-danger">Could not load results.</div>';
                        });
                }
            });
        }

        // *** REMOVE STAFF FUNCTION ***
        window.removeStaff = function (userId) {
            if (!confirm('Remove this staff member? They will no longer be able to manage this competition.')) {
                return;
            }

            const scheduleId = COMP_DATA.scheduleId;
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            fetch('/ManageTeam/RemoveStaff', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token
                },
                body: `scheduleId=${scheduleId}&userId=${userId}`
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.message || 'Failed to remove staff');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload(); // Reload to update the staff list
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Failed to remove staff: ' + error.message);
                    console.error('Error:', error);
                });
        };

        // *** SET AWARD FORM SUBMISSION ***
        $('#setAwardForm').on('submit', function (e) {
            e.preventDefault();

            var $form = $(this);
            var formData = $form.serialize();
            var statusDiv = $('#setAwardStatus');
            var submitBtn = $form.find('button[type="submit"]');

            submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');
            statusDiv.html('<div class="alert alert-info">Saving award settings...</div>');

            $.ajax({
                url: '/Award/SetAwards',
                type: 'POST',
                data: formData,
                success: function (response) {
                    if (response.success) {
                        statusDiv.html('<div class="alert alert-success"><i class="bi bi-check-circle-fill me-2"></i>' + response.message + '</div>');

                        setTimeout(function () {
                            $('#setAwardModal').modal('hide');
                            location.reload();
                        }, 1500);
                    } else {
                        statusDiv.html('<div class="alert alert-danger"><i class="bi bi-x-circle-fill me-2"></i>' + response.message + '</div>');
                        submitBtn.prop('disabled', false).html('<i class="bi bi-save me-2"></i>Save Award Settings');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    statusDiv.html('<div class="alert alert-danger"><i class="bi bi-x-circle-fill me-2"></i>Failed to save award settings. Please try again.</div>');
                    submitBtn.prop('disabled', false).html('<i class="bi bi-save me-2"></i>Save Award Settings');
                }
            });
        });

        // ==================== SCHEDULE CHAT FUNCTIONALITY ====================
        (function () {
            'use strict';

            console.log('🔵 Schedule Chat module loaded');

            const scheduleId = @Model.ScheduleId;
            const currentUserId = @(currentUserId ?? 0);
            // ⬇️ UPDATED: Check if user is confirmed participant (from view)
            // ⬇️ FIXED: Check from view
            const isConfirmedParticipant = @(isConfirmedParticipant.ToString().ToLower());

            // ⬇️ FIXED: isOrganizer checks ScheduleParticipants, NOT team captain
            const isOrganizer = @(isScheduleOrganizer.ToString().ToLower());

            let scheduleChatConnection = null;
            let isConnected = false;
            let isChatInitialized = false;
            let hasLoadedHistory = false;

            // Check if user is a confirmed participant
            const isParticipant = @((Model.Teams.Any(t => t.Status == TeamStatus.Confirmed && t.TeamMembers.Any(m => m.UserId == currentUserId))).ToString().ToLower());

            console.log('Chat Config:', { scheduleId, currentUserId, isOrganizer, isParticipant });

            // Only initialize chat if user is confirmed participant
            if (!isConfirmedParticipant) {
                console.log('❌ User is not a confirmed participant, chat disabled');
                return;
            }

            // Initialize SignalR Connection
            async function initializeScheduleChatHub() {
                if (scheduleChatConnection && scheduleChatConnection.state === signalR.HubConnectionState.Connected) {
                    console.log('✓ Schedule Chat already connected');
                    return;
                }

                try {
                    scheduleChatConnection = new signalR.HubConnectionBuilder()
                        .withUrl("/scheduleChatHub")
                        .withAutomaticReconnect()
                        .build();

                    scheduleChatConnection.on("ReceiveScheduleMessage", (data) => {
                        console.log("Schedule message received:", data);
                        appendChatMessage(data);

                        const chatTab = document.getElementById('chat-tab');
                        if (chatTab && !chatTab.classList.contains('active')) {
                            showChatNotification();
                        }
                    });

                    scheduleChatConnection.on("UserJoinedChat", (data) => {
                        console.log("User joined chat:", data);
                        appendSystemMessage(`${data.username} joined the chat`);
                        updateOnlineCount();
                    });

                    scheduleChatConnection.on("UserLeftChat", (data) => {
                        console.log("User left chat:", data);
                        updateOnlineCount();
                    });

                    scheduleChatConnection.on("JoinedScheduleChat", (data) => {
                        console.log("Successfully joined schedule chat:", data);
                        isConnected = true;
                    });

                    scheduleChatConnection.on("OnlineParticipantsCount", (data) => {
                        console.log("Online participants count:", data);
                        updateOnlineCountDisplay(data.count);
                    });

                    scheduleChatConnection.on("Error", (message) => {
                        console.error("SignalR Error:", message);
                        alert(message);
                    });

                    await scheduleChatConnection.start();
                    console.log("✓ Schedule Chat SignalR Connected");

                } catch (error) {
                    console.error("Schedule Chat SignalR Connection Error:", error);
                }
            }

            async function joinScheduleChatRoom() {
                if (!scheduleChatConnection || scheduleChatConnection.state !== signalR.HubConnectionState.Connected) {
                    await initializeScheduleChatHub();
                }

                try {
                    await scheduleChatConnection.invoke("JoinScheduleChat", scheduleId);
                    console.log(`Joined schedule chat room: ${scheduleId}`);
                    await scheduleChatConnection.invoke("GetOnlineParticipants", scheduleId);
                } catch (error) {
                    console.error("Error joining schedule chat:", error);
                }
            }

            async function leaveScheduleChatRoom() {
                if (!scheduleChatConnection || scheduleChatConnection.state !== signalR.HubConnectionState.Connected) {
                    return;
                }

                try {
                    await scheduleChatConnection.invoke("LeaveScheduleChat", scheduleId);
                    console.log(`Left schedule chat room: ${scheduleId}`);
                } catch (error) {
                    console.error("Error leaving schedule chat:", error);
                }
            }

            async function loadChatHistory() {
                if (hasLoadedHistory) return;

                try {
                    const response = await fetch(`/Schedule/GetScheduleChatHistory?scheduleId=${scheduleId}&skip=0&take=50`);
                    const result = await response.json();

                    if (result.success) {
                        const messagesContainer = document.getElementById('chatMessages');
                        if (!messagesContainer) return;

                        messagesContainer.innerHTML = '';

                        if (result.data.messages.length === 0) {
                            messagesContainer.innerHTML = `
                                    <div class="text-center py-5 text-muted">
                                        <i class="bi bi-chat-dots fs-1"></i>
                                        <p class="mt-2">No messages yet. Start the conversation!</p>
                                    </div>
                                `;
                        } else {
                            result.data.messages.forEach(msg => {
                                appendChatMessage(msg, false);
                            });
                            scrollToBottom();
                        }

                        hasLoadedHistory = true;
                    }
                } catch (error) {
                    console.error('Error loading chat history:', error);
                    const messagesContainer = document.getElementById('chatMessages');
                    if (messagesContainer) {
                        messagesContainer.innerHTML = `
                                <div class="text-center py-5 text-danger">
                                    <i class="bi bi-exclamation-circle fs-1"></i>
                                    <p class="mt-2">Failed to load chat history.</p>
                                </div>
                            `;
                    }
                }
            }

            window.sendScheduleMessage = async function (event) {
                event.preventDefault();

                const input = document.getElementById('chatInput');
                if (!input) return;

                const message = input.value.trim();
                if (!message) return;

                // ⬇️ ADD THIS CHECK
                const competitionStatus = '@Model.Status';
                if (competitionStatus === '@ScheduleStatus.Completed.ToString()') {
                    alert('This competition has ended. You cannot send new messages.');
                    return false;
                }

                if (!scheduleChatConnection || scheduleChatConnection.state !== signalR.HubConnectionState.Connected) {
                    alert('Not connected to chat. Please refresh the page.');
                    return;
                }

                try {
                    await scheduleChatConnection.invoke("SendScheduleMessage", scheduleId, message);
                    input.value = '';
                } catch (error) {
                    console.error("Error sending message:", error);
                    alert("Failed to send message. Please try again.");
                }

                return false;
            };

            function appendChatMessage(data, shouldScroll = true) {
                const messagesContainer = document.getElementById('chatMessages');
                if (!messagesContainer) return;

                const placeholder = messagesContainer.querySelector('.text-center.py-5');
                if (placeholder) placeholder.remove();

                const isMine = data.senderId === currentUserId;

                const roleBadge = data.isOrganizer
                    ? '<span class="chat-message-role organizer">ORGANIZER</span>'
                    : '';

                const canDelete = isMine || isOrganizer;
                const deleteButton = canDelete
                    ? `<button class="chat-message-delete" onclick="deleteScheduleMessage(${data.messageId})" title="Delete message">×</button>`
                    : '';

                const messageTime = new Date(data.sentAt).toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const messageHtml = `
                    <div class="chat-message ${isMine ? 'own-message' : ''}" data-message-id="${data.messageId}">
                        <img src="${data.senderProfilePicture || '/images/profile_image.jpg'}" 
                             class="chat-message-avatar" 
                             alt="${data.senderName}"
                             onclick="showUserProfilePreview(${data.senderId})"
                             style="cursor: pointer;"
                             title="View ${data.senderName}'s profile"
                             onerror="this.src='/images/profile_image.jpg'">
                        <div class="chat-message-content">
                            <div class="chat-message-header">
                                <span class="chat-message-sender" 
                                      onclick="showUserProfilePreview(${data.senderId})" 
                                      style="cursor: pointer;"
                                      title="View profile">
                                    ${escapeHtml(data.senderName)}
                                </span>
                                ${roleBadge}
                                <span class="chat-message-time">${messageTime}</span>
                            </div>
                            <div class="chat-message-bubble">
                                ${escapeHtml(data.content)}
                                ${deleteButton}
                            </div>
                        </div>
                    </div>
                `;

                messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                if (shouldScroll) scrollToBottom();
            }

            function appendSystemMessage(message) {
                const messagesContainer = document.getElementById('chatMessages');
                if (!messagesContainer) return;

                messagesContainer.insertAdjacentHTML('beforeend', `
                        <div class="system-message">
                            <i class="bi bi-info-circle"></i> ${escapeHtml(message)}
                        </div>
                    `);
                scrollToBottom();
            }

            window.deleteScheduleMessage = async function (messageId) {
                if (!confirm('Are you sure you want to delete this message?')) return;

                try {
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

                    const response = await fetch('/Schedule/DeleteScheduleMessage', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            messageId: messageId,
                            scheduleId: scheduleId,
                            __RequestVerificationToken: token
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                        if (messageElement) {
                            messageElement.style.transition = 'opacity 0.3s ease';
                            messageElement.style.opacity = '0';
                            setTimeout(() => {
                                messageElement.remove();
                                if (isOrganizer) {
                                    appendSystemMessage('A message was removed by the organizer');
                                }
                            }, 300);
                        }
                    } else {
                        alert(result.message || 'Failed to delete message');
                    }
                } catch (error) {
                    console.error('Error deleting message:', error);
                    alert('An error occurred while deleting the message');
                }
            };

            async function updateOnlineCount() {
                if (scheduleChatConnection && scheduleChatConnection.state === signalR.HubConnectionState.Connected) {
                    try {
                        await scheduleChatConnection.invoke("GetOnlineParticipants", scheduleId);
                    } catch (error) {
                        console.error('Error getting online count:', error);
                    }
                }
            }

            function updateOnlineCountDisplay(count) {
                const onlineCountEl = document.getElementById('onlineCount');
                if (onlineCountEl) onlineCountEl.textContent = count;
            }

            function showChatNotification() {
                const badge = document.getElementById('unreadChatCount');
                if (badge) {
                    let count = parseInt(badge.textContent) || 0;
                    count++;
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                }
            }

            function clearChatNotifications() {
                const badge = document.getElementById('unreadChatCount');
                if (badge) {
                    badge.textContent = '0';
                    badge.style.display = 'none';
                }
            }

            function scrollToBottom() {
                const messagesContainer = document.getElementById('chatMessages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            const chatTabButton = document.getElementById('chat-tab');
            if (chatTabButton && !chatTabButton.classList.contains('disabled')) {
                chatTabButton.addEventListener('shown.bs.tab', async function () {
                    if (!isChatInitialized && scheduleId > 0) {
                        console.log('🚀 Initializing schedule chat...');

                        await initializeScheduleChatHub();
                        await loadChatHistory();
                        await joinScheduleChatRoom();

                        isChatInitialized = true;
                    }

                    clearChatNotifications();
                    scrollToBottom();
                });
            }

            window.addEventListener('beforeunload', function () {
                if (isConnected) leaveScheduleChatRoom();
            });

            console.log('✓ Schedule Chat module ready');
        })();

        // ==================== END COMPETITION FUNCTIONALITY ====================
        var endCompBtn = document.getElementById('endCompetitionBtn');
        if (endCompBtn && !endCompBtn.disabled) {
            endCompBtn.addEventListener('click', function (e) {
                e.preventDefault();

                if (!confirm('Are you sure you want to end this competition?\n\nThis will:\n• Mark the competition as completed\n• Disable team registration\n• Lock chat messages\n• Move competition to "Ended" list')) {
                    return;
                }

                const scheduleId = COMP_DATA.scheduleId;
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                endCompBtn.disabled = true;
                endCompBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Ending...';

                fetch('/Competition/EndCompetition', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        scheduleId: scheduleId,
                        __RequestVerificationToken: token
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Competition ended successfully!\n\nRedirecting to competition listing...');
                            window.location.href = '/Competition/Listing';
                        } else {
                            alert('Error: ' + data.message);
                            endCompBtn.disabled = false;
                            endCompBtn.innerHTML = '<i class="bi bi-stop-fill"></i> End Competition';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while ending the competition');
                        endCompBtn.disabled = false;
                        endCompBtn.innerHTML = '<i class="bi bi-stop-fill"></i> End Competition';
                    });
            });
        }



        // Show reset button if already submitted
        (function checkRankSubmissionStatus() {
            const scheduleId = COMP_DATA.scheduleId;
            const submitBtn = document.getElementById('submitRankBtn');
            const resetBtn = document.getElementById('resetRankBtn');
            const submittedStatus = document.getElementById('rankSubmittedStatus');

            if (!submitBtn) return;

            fetch(`/Rank/CheckCompetitionRankStatus?scheduleId=${scheduleId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.isSubmitted) {
                        submitBtn.style.display = 'none';
                        resetBtn.style.display = 'inline-block';
                        submittedStatus.style.display = 'block';

                        const submissionDate = new Date(data.submissionDate);
                        const formattedDate = submissionDate.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        document.getElementById('rankSubmissionInfo').textContent =
                            `${data.matchesProcessed} match(es) submitted on ${formattedDate}`;
                    }
                })
                .catch(error => console.error('Error checking RANK status:', error));
        })();

        // Reset button handler
        document.getElementById('resetRankBtn')?.addEventListener('click', async function (e) {
            e.preventDefault();

            if (!confirm('Reset and reprocess all RANK data for this competition?\n\nThis will:\n• Delete existing RANK results\n• Reset all player ratings\n• Reprocess with updated algorithm\n\nContinue?')) {
                return;
            }

            const scheduleId = COMP_DATA.scheduleId;
            const btn = e.target;

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Resetting...';

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                const response = await fetch('/Rank/ResetAndReprocess', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        scheduleId: scheduleId,
                        __RequestVerificationToken: token
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('✅ Successfully reset and reprocessed!\n\n' + data.message);
                    location.reload();
                } else {
                    alert('❌ Error: ' + data.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Reset & Reprocess';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('❌ An error occurred: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Reset & Reprocess';
            }
        });

        // ==================== SUBMIT TO RANK FUNCTIONALITY (AUTO-PROCESS) ====================
        var submitRankBtn = document.getElementById('submitRankBtn');
        if (submitRankBtn) {
            submitRankBtn.addEventListener('click', function (e) {
                e.preventDefault();

                // Show the modal and load match summary
                var modal = new bootstrap.Modal(document.getElementById('submitRankModal'));
                modal.show();

                // Load match summary
                loadMatchSummaryForRank();
            });
        }

        async function loadMatchSummaryForRank() {
            const scheduleId = COMP_DATA.scheduleId;
            const summaryDiv = document.getElementById('rankSubmissionSummary');
            const loadingDiv = document.getElementById('rankLoadingSpinner');
            const confirmBtn = document.getElementById('confirmAutoSubmitRank');

            try {
                const response = await fetch(`/Rank/GetCompetitionMatchSummary?scheduleId=${scheduleId}`);
                const data = await response.json();

                loadingDiv.style.display = 'none';

                if (data.success) {
                    summaryDiv.style.display = 'block';
                    confirmBtn.style.display = 'inline-block';

                    document.getElementById('totalMatchesCount').textContent = data.summary.totalMatches;
                    document.getElementById('singlesMatchesCount').textContent = data.summary.singlesMatches;
                    document.getElementById('doublesMatchesCount').textContent = data.summary.doublesMatches;

                    if (data.summary.totalMatches === 0) {
                        summaryDiv.innerHTML = `
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    No completed matches found in this competition.
                                </div>
                            `;
                        confirmBtn.style.display = 'none';
                    }
                } else {
                    summaryDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-x-circle me-2"></i>
                                ${data.message}
                            </div>
                        `;
                    summaryDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading match summary:', error);
                loadingDiv.style.display = 'none';
                summaryDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle me-2"></i>
                            Failed to load match data. Please try again.
                        </div>
                    `;
                summaryDiv.style.display = 'block';
            }
        }

        document.getElementById('confirmAutoSubmitRank')?.addEventListener('click', async function (e) {
            e.preventDefault();

            const scheduleId = COMP_DATA.scheduleId;
            const confirmBtn = e.target;
            const statusDiv = document.getElementById('rankProcessingStatus');

            if (!confirm('Confirm submission to RANK?\n\nThis will process all completed matches and update player ratings.\n\nThis action cannot be undone.')) {
                return;
            }

            // Disable button and show processing
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Processing...</span>
                            </div>
                            <span>Processing competition results...</span>
                        </div>
                    </div>
                `;

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                const response = await fetch('/Rank/AutoSubmitCompetitionResults', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        scheduleId: scheduleId,
                        __RequestVerificationToken: token
                    })
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="bi bi-check-circle-fill me-2"></i>Successfully Submitted to RANK!</h6>
                        <p class="mb-2">${data.message}</p>
                        ${data.details ? `
                            <hr>
                            <small>
                                <strong>Details:</strong><br>
                                • Total Matches: ${data.details.totalMatches}<br>
                                • Successfully Processed: ${data.details.processed}<br>
                                • Skipped: ${data.details.skipped}
                                ${data.details.errors && data.details.errors.length > 0 ? `
                                    <br><br><strong>Errors:</strong>
                                    <ul class="mb-0 mt-1">
                                        ${data.details.errors.map(err => `<li>${err}</li>`).join('')}
                                    </ul>
                                ` : ''}
                            </small>
                        ` : ''}
                        <div class="mt-3 text-center">
                            <strong>All player ratings have been updated!</strong>
                        </div>
                    </div>
                `;

                    // Update button to show completion
                    confirmBtn.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Submission Complete';
                    confirmBtn.classList.remove('btn-primary');
                    confirmBtn.classList.add('btn-success');

                    // Close modal and reload after 2 seconds
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('submitRankModal'))?.hide();
                        location.reload(); // This will show the "Done Submit" button
                    }, 2000);
                } else {
                    statusDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-x-circle-fill me-2"></i>
                                <strong>Error:</strong> ${data.message}
                                ${data.error ? `<br><small>${data.error}</small>` : ''}
                            </div>
                        `;

                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="bi bi-graph-up-arrow me-2"></i>Retry Submission';
                }
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle-fill me-2"></i>
                            <strong>Error:</strong> An unexpected error occurred while processing results.
                            <br><small>${error.message}</small>
                        </div>
                    `;

                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="bi bi-graph-up-arrow me-2"></i>Retry Submission';
            }
        });
    // ==================== COMPETITION TEAM PAYMENT FUNCTIONALITY ====================

    // ================================
    // 1. Variables
    // ================================
    let teamIdForPayment = 0;
    let compScheduleId = 0;
    let compPaymentAmount = 0;

    // ================================
    // 2. Open Competition Payment Modal
    // ================================
    // ================================
    // 2. Open Competition Payment Modal (AMENDED)
    // ================================
    function openCompetitionPaymentModal(teamId, scheduleId, amount, isEarlyBird) {

        teamIdForPayment = teamId;
        compScheduleId = scheduleId;
        compPaymentAmount = amount;

        console.log("OPEN COMP MODAL =>", { teamId, scheduleId, amount, isEarlyBird });

        // Update modal UI - Total Amount
        const totalAmountEl = document.getElementById("totalAmount");
        if(totalAmountEl) {
            totalAmountEl.innerText = amount.toFixed(2);
        }

        // Optional: Update the "Fee:" label to show "Early Bird Fee:" if applicable
        // We find the label that usually says "gameName Fee:" (Source: 6-7 in _PaymentModal)
        // Note: This assumes the structure in _PaymentModal.cshtml hasn't changed structure heavily.
        const summaryDiv = document.querySelector('.payment-summary');
        if (summaryDiv) {
            // Find the span that holds the label (usually the first span in the flex container)
            const labelSpan = summaryDiv.querySelector('.d-flex.justify-content-between.mb-2 > span');
            if (labelSpan) {
                if (isEarlyBird) {
                    labelSpan.innerHTML = '<i class="bi bi-stopwatch-fill text-warning"></i> Early Bird Fee:';
                } else {
                    labelSpan.innerHTML = 'Registration Fee:';
                }
            }
            
            // Update the fee amount display next to the label
            const amountStrong = summaryDiv.querySelector('.d-flex.justify-content-between.mb-2 > strong');
            if (amountStrong) {
                amountStrong.innerText = 'RM ' + amount.toFixed(2);
            }
        }

        // Reuse existing globals from payment modal
        paymentAmount = amount;
        currentScheduleId = scheduleId;

        // Override executeEscrowPayment ONLY for this modal instance
        window.executeEscrowPayment = executeCompetitionPayment;

        // Show modal
        let modal = new bootstrap.Modal(document.getElementById("paymentModal"));
        modal.show();
        
        // Trigger balance check immediately
        if (typeof checkBalance === "function") {
            setTimeout(checkBalance, 300); 
        }
    }
    // ================================
    // 3. Execute Team Payment
    // ================================
    async function executeCompetitionPayment(btn) {

        const password = document.getElementById("userPassword").value.trim();

        btn.disabled = true;
        btn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2"></span> Processing...
        `;

        const payload = {
            teamId: teamIdForPayment,
            scheduleId: compScheduleId,
            amount: compPaymentAmount,
            userId: @Context.Session.GetInt32("UserId")
        };

        const response = await fetch('/Competition/PayTeamEscrow', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (!data.success) {
            showPaymentError(data.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-lock-fill"></i> Confirm Payment';
            return;
        }

        showPaymentSuccess("Team payment successful!");
    }




    </script>
}