@model PicklePlay.ViewModels.SignupViewModel
@{
    ViewData["Title"] = "Sign Up - PicklePlay";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <style>
        body {
            background: url("/images/pickleball_background.jpg") no-repeat center center fixed;
            background-size: cover;
        }
        .field-validation-error { color: #dc3545; font-size: 0.875em; }
        .input-validation-error { border-color: #dc3545; }
        
        /* Loading Modal Styles */
        .loading-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #A1D336;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* reCAPTCHA container */
        .g-recaptcha-container {
            min-height: 78px; /* Reserve space for reCAPTCHA */
        }
    </style>
}

<!-- Loading Modal -->
<div id="loadingModal" class="loading-modal">
    <div class="loading-content">
        <div class="spinner"></div>
        <h4>Creating Your Account...</h4>
        <p>Please wait while we set up your account and send verification email.</p>
        <div class="progress mt-3" style="height: 6px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%; background-color: #A1D336;"></div>
        </div>
    </div>
</div>

<div class="auth-container">
    <!-- Left Logo Panel -->
    <div class="logo-panel">
        <img src="~/images/logoV3.png" alt="PicklePlay Logo">
    </div>

    <!-- Right Form Panel -->
    <div class="form-panel">
        <div class="form-wrapper">
            <!-- Sign Up Section -->
            <div class="form-section signup-section">
                <h3 class="text-center mb-4">Sign Up</h3>
                
                <form id="signupForm" asp-controller="Auth" asp-action="Signup" method="post">
                    @Html.AntiForgeryToken()
                    
                    <div class="mb-3">
                        <label class="form-label" asp-for="FullName"></label>
                        <input type="text" class="form-control" asp-for="FullName" placeholder="Enter your name" value="@Model.FullName">
                        <span asp-validation-for="FullName" class="text-danger"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label" asp-for="Email"></label>
                        <input type="email" class="form-control" asp-for="Email" placeholder="Enter your email" value="@Model.Email">
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label" asp-for="Password"></label>
                        <input type="password" class="form-control" asp-for="Password" placeholder="Create password">
                        <span asp-validation-for="Password" class="text-danger"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label" asp-for="ConfirmPassword"></label>
                        <input type="password" class="form-control" asp-for="ConfirmPassword" placeholder="Confirm password">
                        <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                    </div>

                    <!-- Google reCAPTCHA -->
                    <div class="mb-3 g-recaptcha-container">
                        <div id="recaptchaWidget"></div>
                        <input type="hidden" asp-for="CaptchaToken" id="captchaToken" />
                        <span asp-validation-for="CaptchaToken" class="text-danger"></span>
                        @if (!ViewData.ModelState.IsValid && string.IsNullOrEmpty(Model.CaptchaToken))
                        {
                            <span class="text-danger">Please complete the CAPTCHA verification</span>
                        }
                    </div>

                    <!-- Display general errors -->
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="d-grid mb-3">
                        <button type="submit" class="btn btn-custom" id="submitBtn">
                            <span id="btnText">Sign Up</span>
                            <div id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </button>
                    </div>
                    
                    <p class="text-center small text-muted">
                        After signing up, please check your email to verify your account before logging in.
                    </p>
                    
                    <p class="text-center">Already have an account?
                        <a href="@Url.Action("Login", "Auth")" class="fw-bold text-decoration-none text-primary">Login</a>
                    </p>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Google reCAPTCHA -->
    <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>
    
    <script>
        let recaptchaWidgetId;

        // Initialize reCAPTCHA
        function onRecaptchaLoad() {
            recaptchaWidgetId = grecaptcha.render('recaptchaWidget', {
                'sitekey': '@ViewBag.RecaptchaSiteKey',
                'callback': onRecaptchaSubmit,
                'expired-callback': onRecaptchaExpired
            });
        }

        function onRecaptchaSubmit(token) {
            document.getElementById("captchaToken").value = token;
        }

        function onRecaptchaExpired() {
            document.getElementById("captchaToken").value = "";
            grecaptcha.reset(recaptchaWidgetId);
        }

        // Reset reCAPTCHA when page loads (for error scenarios)
        document.addEventListener('DOMContentLoaded', function() {
            // If there are validation errors, reset the reCAPTCHA
            const hasErrors = @(!ViewData.ModelState.IsValid ? "true" : "false");
            if (hasErrors) {
                // Reinitialize reCAPTCHA after a short delay to ensure it's loaded
                setTimeout(() => {
                    if (typeof grecaptcha !== 'undefined' && grecaptcha.render) {
                        if (recaptchaWidgetId) {
                            grecaptcha.reset(recaptchaWidgetId);
                        } else {
                            onRecaptchaLoad();
                        }
                    }
                }, 500);
            }
        });

        // Form submission handling
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('signupForm');
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            const loadingModal = document.getElementById('loadingModal');

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate form first
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                // Validate CAPTCHA
                const captchaResponse = document.getElementById('captchaToken').value;
                if (captchaResponse.length === 0) {
                    alert('Please complete the CAPTCHA verification');
                    if (recaptchaWidgetId) {
                        grecaptcha.execute(recaptchaWidgetId);
                    }
                    return;
                }

                // Show loading states
                submitBtn.disabled = true;
                btnText.textContent = 'Creating Account...';
                btnSpinner.classList.remove('d-none');
                loadingModal.style.display = 'flex';

                // Submit form via AJAX
                const formData = new FormData(form);
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.redirected) {
                        // Success - redirect to success page
                        window.location.href = response.url;
                    } else if (response.ok) {
                        return response.text().then(html => {
                            // Replace current page with new content if there are errors
                            document.documentElement.innerHTML = html;
                            // Reinitialize scripts
                            setTimeout(() => {
                                if (typeof onRecaptchaLoad === 'function') {
                                    onRecaptchaLoad();
                                }
                            }, 100);
                        });
                    } else {
                        throw new Error('Network response was not ok');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Hide loading and show error
                    loadingModal.style.display = 'none';
                    submitBtn.disabled = false;
                    btnText.textContent = 'Sign Up';
                    btnSpinner.classList.add('d-none');
                    alert('An error occurred. Please try again.');
                    
                    // Reset reCAPTCHA
                    if (recaptchaWidgetId) {
                        grecaptcha.reset(recaptchaWidgetId);
                    }
                });
            });

            // Real-time password confirmation validation
            const password = document.querySelector('input[asp-for="Password"]');
            const confirmPassword = document.querySelector('input[asp-for="ConfirmPassword"]');
            
            function validatePasswordMatch() {
                if (password.value !== confirmPassword.value) {
                    confirmPassword.setCustomValidity('Passwords do not match');
                } else {
                    confirmPassword.setCustomValidity('');
                }
            }
            
            if (password && confirmPassword) {
                password.addEventListener('input', validatePasswordMatch);
                confirmPassword.addEventListener('input', validatePasswordMatch);
            }
        });
    </script>
}