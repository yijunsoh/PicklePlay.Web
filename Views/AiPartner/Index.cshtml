@model IReadOnlyList<PicklePlay.Models.ViewModels.AiSuggestionViewModel>
@{
    Layout = "_Layout";
    int analyzedCount = ViewBag.AnalyzedCount ?? 0;
    var items = (Model ?? Enumerable.Empty<PicklePlay.Models.ViewModels.AiSuggestionViewModel>()).ToList();
    int total = items.Count;
    // Calculate layout: sets of 3, then the remainder
    int fullRows = (total / 3) * 3;
    int remainder = total - fullRows;
}

<div class="container py-5">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h2 class="fw-bold d-inline">Partner Recommendations</h2>
            <button type="button" class="btn btn-link p-0 ms-2" data-bs-toggle="modal" data-bs-target="#analyticsExplainModal" title="How analytics works">
                <i class="bi bi-question-circle" style="font-size:1.05rem"></i>
            </button>
            <div class="small text-muted mt-1">
                Analyzed <strong class="text-dark">@analyzedCount</strong> players.
                Top <strong class="text-primary">@(items.Count)</strong>.
            </div>
        </div>
    </div>

    @if (items == null || !items.Any())
    {
        <div class="alert alert-light text-center shadow-sm p-5">
            <h4 class="alert-heading text-muted">No suggestions found yet</h4>
            <p class="mb-0">
                @(ViewBag.Message ?? "We couldn't find a good match based on your current profile.")
            </p>
            <small class="text-muted mt-3 d-block">
                (Debug: Analyzed @analyzedCount other users)
            </small>
        </div>
    }
    else
    {
        @for (int r = 0; r < fullRows; r += 3)
        {
            <div class="row g-4 mb-3">
                @for (int j = 0; j < 3; j++)
                {
                    var i = r + j;
                    var s = items[i];
                    var imgSrc = string.IsNullOrEmpty(s.ProfilePicture) ? "/images/user.png" : s.ProfilePicture;
                    var isHighMatch = s.Score >= 80;

                    <div class="col">
                        <div class="card h-100 border-0 shadow-sm position-relative" style="border-radius:16px;overflow:hidden; transition: transform .18s;" 
                             onmouseover="this.style.transform='translateY(-5px)'" 
                             onmouseout="this.style.transform='translateY(0)'">
                            
                            <span class="badge bg-primary position-absolute" style="left:12px;top:12px;font-weight:600;">No @(i + 1)</span>
                            <div style="height:100px; background:@(isHighMatch ? "linear-gradient(45deg,#198754,#20c997)" : "linear-gradient(45deg,#22673b,#2f8a5a)");"></div>
                            
                            <div class="card-body text-center" style="margin-top:-50px;">
                                <img src="@imgSrc" alt="@s.UserName" class="rounded-circle border border-4 border-white shadow-sm bg-white" 
                                     style="width:100px;height:100px;object-fit:cover;cursor:pointer;"
                                     onclick="showUserProfilePreview('@s.UserId')" 
                                     onerror="this.src='/images/user.png'" />
                                
                                <h5 class="mt-3 fw-bold text-dark">@s.UserName</h5>
                                <span class="badge @(isHighMatch ? "bg-success" : "bg-primary") mb-3">@s.SuitabilityLabel</span>

                                <div class="d-grid gap-2 col-10 mx-auto mb-2">
                                    <button class="btn btn-outline-secondary btn-sm rounded-pill" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#reasonModal-@i">
                                        <i class="bi bi-magic"></i> Why this match?
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card-footer bg-white border-top-0 text-center pb-3">
                                <small class="text-muted">Match Score: <strong>@s.Score%</strong></small>
                                <div class="progress mt-1" style="height:4px;width:60%;margin:0 auto;">
                                    <div class="progress-bar @(isHighMatch ? "bg-success" : "bg-primary")" role="progressbar" style="width:@s.Score%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="reasonModal-@i" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-0 shadow">
                                <div class="modal-header border-0">
                                    <h5 class="modal-title fw-bold">Analysis for @s.UserName</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="d-flex align-items-start">
                                        <div class="fs-1 text-info me-3"><i class="bi bi-cpu"></i></div>
                                        <div>
                                            <p class="text-muted small mb-1 text-uppercase fw-bold">Reasoning</p>
                                            <p class="fw-medium mb-0">@s.Explanation</p>
                                        </div>
                                    </div>
                                    <hr class="my-3 opacity-25" />
                                    <div class="text-muted small">
                                        <strong>Data Reliability: @s.Reliability%</strong><br/>
                                        (Based on: Rank, History, Location, Endorsements)
                                    </div>
                                </div>
                                <div class="modal-footer border-0 bg-light">
                                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }

        @if (remainder > 0)
        {
            <div class="row g-4 mb-3 justify-content-center">
                @for (int i = fullRows; i < total; i++)
                {
                    var s = items[i];
                    var imgSrc = string.IsNullOrEmpty(s.ProfilePicture) ? "/images/user.png" : s.ProfilePicture;
                    var isHighMatch = s.Score >= 80;

                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card h-100 border-0 shadow-sm position-relative" style="border-radius:16px;overflow:hidden; transition: transform .18s;"
                             onmouseover="this.style.transform='translateY(-5px)'" 
                             onmouseout="this.style.transform='translateY(0)'">
                            
                            <span class="badge bg-primary position-absolute" style="left:12px;top:12px;font-weight:600;">No @(i + 1)</span>
                            <div style="height:100px; background:@(isHighMatch ? "linear-gradient(45deg,#198754,#20c997)" : "linear-gradient(45deg,#22673b,#2f8a5a)");"></div>
                            
                            <div class="card-body text-center" style="margin-top:-50px;">
                                <img src="@imgSrc" alt="@s.UserName" class="rounded-circle border border-4 border-white shadow-sm bg-white" 
                                     style="width:100px;height:100px;object-fit:cover;cursor:pointer;"
                                     onclick="showUserProfilePreview('@s.UserId')" 
                                     onerror="this.src='/images/user.png'" />
                                
                                <h5 class="mt-3 fw-bold text-dark">@s.UserName</h5>
                                <span class="badge @(isHighMatch ? "bg-success" : "bg-primary") mb-3">@s.SuitabilityLabel</span>

                                <div class="d-grid gap-2 col-10 mx-auto mb-2">
                                    <button class="btn btn-outline-secondary btn-sm rounded-pill" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#reasonModal-@i">
                                        <i class="bi bi-magic"></i> Why this match?
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card-footer bg-white border-top-0 text-center pb-3">
                                <small class="text-muted">Match Score: <strong>@s.Score%</strong></small>
                                <div class="progress mt-1" style="height:4px;width:60%;margin:0 auto;">
                                    <div class="progress-bar @(isHighMatch ? "bg-success" : "bg-primary")" role="progressbar" style="width:@s.Score%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="reasonModal-@i" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-0 shadow">
                                <div class="modal-header border-0">
                                    <h5 class="modal-title fw-bold">Analysis for @s.UserName</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="d-flex align-items-start">
                                        <div class="fs-1 text-info me-3"><i class="bi bi-cpu"></i></div>
                                        <div>
                                            <p class="text-muted small mb-1 text-uppercase fw-bold">Reasoning</p>
                                            <p class="fw-medium mb-0">@s.Explanation</p>
                                        </div>
                                    </div>
                                    <hr class="my-3 opacity-25" />
                                    <div class="text-muted small">
                                        <strong>Data Reliability: @s.Reliability%</strong><br/>
                                        (Based on: Rank, History, Location, Endorsements)
                                    </div>
                                </div>
                                <div class="modal-footer border-0 bg-light">
                                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

<div class="modal fade" id="analyticsExplainModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">How AI Partner Analytics Works</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="mb-2">Overview</h6>
                <p class="small text-muted">The system computes a suitability score for each candidate by combining multiple signals using configurable weights. The final result is a percentage (0–100%) indicating overall suitability as a partner.</p>

                <h6 class="mt-3">Signals and Weights</h6>
                <ul>
                    <li><strong>Rating (weight ~20%)</strong> — normalized user rating.</li>
                    <li><strong>History / Endorsements (weight ~15%)</strong> — number and relevance of past matches.</li>
                    <li><strong>Vibe / Personality match (weight ~15%)</strong> — trait overlap based on endorsements.</li>
                    <li><strong>Location / Proximity (weight ~15%)</strong> — nearby preferred.</li>
                    <li><strong>Activeness (weight ~15%)</strong> — recent activity.</li>
                    <li><strong>Age / Gender fit (weight ~20%)</strong> — preferences and reasonable age gaps.</li>
                </ul>

                <h6 class="mt-3">Privacy</h6>
                <p class="small text-muted">Only non-sensitive profile attributes are used. No private messages or payment data are analyzed.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>