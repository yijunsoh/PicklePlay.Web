@model List<Community>
@using PicklePlay.Models

@{
    ViewData["Title"] = "Inactive Communities";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    var inactiveDays = ViewData["InactiveDays"] as int? ?? 90;
}

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-users me-2"></i>Inactive Communities</h2>
            <p class="text-muted">
                @if (inactiveDays == 0)
                {
                    <span>All active communities</span>
                }
                else
                {
                    <span>Communities with no activity in the last @inactiveDays days</span>
                }
            </p>
        </div>
        <div class="col-md-4 text-end">
            <a href="/Admin/UpdateAllCommunityLastActivity" class="btn btn-success me-2" title="Refresh all community activity dates from latest schedules">
                <i class="fas fa-sync me-1"></i>Refresh Activity Dates
            </a>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <div class="btn-group d-flex flex-wrap">
                <a href="/Admin/InactiveCommunities?inactiveDays=0" class="btn btn-outline-primary @(inactiveDays == 0 ? "active" : "")" >All Communities</a>
                <a href="/Admin/InactiveCommunities?inactiveDays=30" class="btn btn-outline-primary @(inactiveDays == 30 ? "active" : "")" >30 days</a>
                <a href="/Admin/InactiveCommunities?inactiveDays=60" class="btn btn-outline-primary @(inactiveDays == 60 ? "active" : "")">60 days</a>
                <a href="/Admin/InactiveCommunities?inactiveDays=90" class="btn btn-outline-primary @(inactiveDays == 90 ? "active" : "")">90 days</a>
                <a href="/Admin/InactiveCommunities?inactiveDays=180" class="btn btn-outline-primary @(inactiveDays == 180 ? "active" : "")">6 months</a>
            </div>
        </div>
    </div>

    @if (Model.Any())
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Community Name</th>
                        <th>Created By</th>
                        <th>Members</th>
                        <th>Created Date</th>
                        <th>Last Activity</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var community in Model)
                    {
                        var lastActivity = community.LastActivityDate.HasValue 
                            ? community.LastActivityDate.Value.ToString("MMM dd, yyyy HH:mm")
                            : "Never";
                        
                        var daysSinceActivity = community.LastActivityDate.HasValue
                            ? (int)(DateTime.UtcNow - community.LastActivityDate.Value).TotalDays
                            : (int)(DateTime.UtcNow - community.CreatedDate).TotalDays;
                        
                        var daysDisplay = daysSinceActivity <= 0 ? "Active" : $"{daysSinceActivity} days ago";

                        <tr>
                            <td>
                                <strong>@community.CommunityName</strong>
                                @if (!string.IsNullOrEmpty(community.CommunityLocation))
                                {
                                    <br />
                                    <small class="text-muted"><i class="fas fa-map-marker-alt"></i> @community.CommunityLocation</small>
                                }
                            </td>
                            <td>@community.Creator?.Username</td>
                            <td>
                                <span class="badge bg-info">@community.Memberships.Count members</span>
                            </td>
                            <td>@community.CreatedDate.ToString("MMM dd, yyyy")</td>
                            <td>
                                <div>@lastActivity</div>
                                <small class="text-muted">@daysDisplay</small>
                            </td>
                            <td>
                                <span class="badge bg-warning text-dark">@community.Status</span>
                            </td>
                            <td>
                                <button class="btn btn-outline-danger btn-sm" onclick="confirmDeleteCommunity(@community.CommunityId, '@community.CommunityName')" title="Delete Community">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            @if (inactiveDays == 0)
            {
                <span>No active communities found.</span>
            }
            else
            {
                <span>No inactive communities found in the last @inactiveDays days.</span>
            }
        </div>
    }
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action will mark the community as deleted and cannot be undone.
                </div>
                <p>Are you deleting: <strong id="communityNameDisplay"></strong>?</p>
                <div class="mb-3">
                    <label for="confirmationName" class="form-label">
                        Type <strong id="confirmationNameLabel"></strong> to confirm:
                    </label>
                    <input type="text" id="confirmationName" class="form-control" placeholder="Enter community name" />
                    <div class="invalid-feedback d-block" id="confirmNameError"></div>
                </div>
                <div class="mb-3">
                    <label for="deleteReason" class="form-label">Reason for deletion <span class="text-danger">*</span>:</label>
                    <textarea class="form-control" id="deleteReason" rows="3" placeholder="Enter reason for deletion" required maxlength="500"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="deleteCommunity()" disabled>Delete Community</button>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedCommunityId = null;
    let selectedCommunityName = null;

    function confirmDeleteCommunity(communityId, communityName) {
        selectedCommunityId = communityId;
        selectedCommunityName = communityName;
        document.getElementById('communityNameDisplay').textContent = communityName;
        document.getElementById('confirmationNameLabel').textContent = `"${communityName}"`;
        document.getElementById('confirmationName').value = '';
        document.getElementById('deleteReason').value = '';
        document.getElementById('confirmDeleteBtn').disabled = true;
        
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();
    }

    // Real-time validation for both name and reason
    function validateDeletionForm() {
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const confirmationName = document.getElementById('confirmationName').value.trim();
        const deleteReason = document.getElementById('deleteReason').value.trim();
        const confirmNameError = document.getElementById('confirmNameError');

        const nameValid = confirmationName === selectedCommunityName;
        const reasonValid = deleteReason && deleteReason.length > 0;

        if (confirmationName && !nameValid) {
            confirmNameError.textContent = 'Community name does not match.';
        } else {
            confirmNameError.textContent = '';
        }

        // Enable button only when BOTH conditions are met
        confirmBtn.disabled = !(nameValid && reasonValid);
    }

    // Add event listeners for both fields
    document.addEventListener('DOMContentLoaded', function () {
        const confirmationName = document.getElementById('confirmationName');
        const deleteReason = document.getElementById('deleteReason');
        
        if (confirmationName) {
            confirmationName.addEventListener('input', validateDeletionForm);
        }
        if (deleteReason) {
            deleteReason.addEventListener('input', validateDeletionForm);
        }
    });

    function deleteCommunity() {
        if (!selectedCommunityId) return;

        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';

        const reason = document.getElementById('deleteReason').value;

        fetch('/Admin/DeleteInactiveCommunity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `communityId=${selectedCommunityId}&reason=${encodeURIComponent(reason)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the community.');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalText;
        });
    }
</script>

<style>
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .table {
        margin-bottom: 0;
    }

    .table tbody tr:hover {
        background-color: rgba(46, 139, 87, 0.05);
    }

    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
