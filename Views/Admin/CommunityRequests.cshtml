@model List<PicklePlay.ViewModels.CommunityRequestAdminViewModel>
@{
    ViewData["Title"] = "Community Requests";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

@* Add Anti-Forgery Token for POST calls *@
@Html.AntiForgeryToken()

<div class="p-4">
    <h3>Community Requests <span class="badge bg-danger">@(Model?.Count ?? 0)</span></h3>
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Community Name</th>
                <th>Type</th>
                <th>Requested By</th>
                <th>Date</th>
                <th>Location</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                @foreach (var request in Model)
                {
                    <tr id="row-@request.RequestId">
                        <td>@request.CommunityName</td>
                        <td>@request.CommunityType</td>
                        <td>@request.RequesterUsername</td>
                        <td>@request.RequestDate.ToShortDateString()</td>
                        <td>@(request.CommunityLocation ?? "N/A")</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="viewCommunity(@request.RequestId, '@request.CommunityName', '@request.RequesterUsername', '@(request.Description?.Replace("'", "\\'") ?? "No description provided.")')">View Details</button>
                            <button class="btn btn-success btn-sm" onclick="acceptRequest(@request.RequestId)">Accept</button>
                            <button class="btn btn-danger btn-sm" onclick="openRejectModal(@request.RequestId, '@request.CommunityName')">Reject</button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6" class="text-center text-muted">No pending community requests at this time.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="rejectModalLabel">Reject Community Request</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Community:</strong> <span id="rejectCommunityName"></span></p>
                <label for="rejectReason" class="form-label">Reason for rejection:</label>
                <textarea id="rejectReason" class="form-control" rows="3"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitRejection()">Submit Rejection</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="viewModalLabel">Community Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Request ID:</strong> <span id="communityRequestId"></span></p>
                <p><strong>Community Name:</strong> <span id="communityName"></span></p>
                <p><strong>Requested By:</strong> <span id="requestedBy"></span></p>
                <p><strong>Description:</strong></p>
                <p id="communityDesc" class="border p-2 rounded bg-light"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentRequestId = 0; // Global to hold the ID for rejection

        function getAntiForgeryToken() {
            return document.querySelector('input[name="__RequestVerificationToken"]').value;
        }

        function viewCommunity(requestId, name, requester, desc) {
            document.getElementById("communityRequestId").innerText = requestId;
            document.getElementById("communityName").innerText = name;
            document.getElementById("requestedBy").innerText = requester;
            document.getElementById("communityDesc").innerText = desc;
            
            let modal = new bootstrap.Modal(document.getElementById('viewModal'));
            modal.show();
        }

        function openRejectModal(requestId, communityName) {
            currentRequestId = requestId;
            document.getElementById("rejectCommunityName").innerText = communityName;
            document.getElementById("rejectReason").value = "";
            let modal = new bootstrap.Modal(document.getElementById('rejectModal'));
            modal.show();
        }

        async function acceptRequest(requestId) {
            if (!confirm('Are you sure you want to ACCEPT this community request? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/Admin/AcceptCommunityRequest?requestId=${requestId}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': getAntiForgeryToken()
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    // Remove the row from the table on success
                    const row = document.getElementById(`row-${requestId}`);
                    if (row) row.remove();
                } else {
                    const error = await response.json();
                    alert('Error accepting request: ' + (error.message || response.statusText));
                }
            } catch (error) {
                console.error('Accept Error:', error);
                alert('A network error occurred while accepting the request.');
            }
        }

        async function submitRejection() {
            const requestId = currentRequestId;
            let community = document.getElementById("rejectCommunityName").innerText;
            let reason = document.getElementById("rejectReason").value;

            if (reason.trim() === "") {
                alert("Please provide a reason for rejection.");
                return;
            }
            
            // Prepare FormData for reason and CSRF token
            const formData = new FormData();
            formData.append('reason', reason);
            formData.append('__RequestVerificationToken', getAntiForgeryToken());


            try {
                const response = await fetch(`/Admin/RejectCommunityRequest?requestId=${requestId}`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    
                    // Close modal
                    let modalEl = document.getElementById('rejectModal');
                    let modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();

                    // Remove the row from the table on success
                    const row = document.getElementById(`row-${requestId}`);
                    if (row) row.remove();
                } else {
                    const error = await response.json();
                    alert('Error rejecting request: ' + (error.message || response.statusText));
                }
            } catch (error) {
                console.error('Reject Error:', error);
                alert('A network error occurred while rejecting the request.');
            }
        }
    </script>
}