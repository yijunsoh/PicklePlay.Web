@{
    ViewData["Title"] = "User Management";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">User Management</h2>
        <div class="badge bg-primary fs-6">Total Reports: <span id="totalCount">0</span></div>
    </div>
    
    <!-- Search and Filter Controls -->
    <div class="row mb-4 g-3">
        <div class="col-md-5">
            <div class="input-group">
                <span class="input-group-text bg-light">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="searchInput" class="form-control" placeholder="Search users, reporters, or reasons...">
                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                    Clear
                </button>
            </div>
        </div>
        <div class="col-md-3">
            <select id="statusFilter" class="form-select">
                <option value="all">All Report Status</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
            </select>
        </div>
        <div class="col-md-2">
            <select id="userStatusFilter" class="form-select">
                <option value="all">All Users</option>
                <option value="Active">Active</option>
                <option value="Suspended">Suspended</option>
                <option value="Banned">Banned</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="applyFilters()">
                <i class="fas fa-filter"></i> Apply
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Pending</h6>
                            <h4 class="mb-0" id="pendingCount">0</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Approved</h6>
                            <h4 class="mb-0" id="approvedCount">0</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Rejected</h6>
                            <h4 class="mb-0" id="rejectedCount">0</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-times-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Banned Users</h6>
                            <h4 class="mb-0" id="bannedCount">0</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-ban fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User History Modal -->
    <div class="modal fade" id="userHistoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">User Report History</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="userHistoryContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive bg-white rounded shadow-sm">
        <table class="table table-hover mb-0" id="reportsTable">
            <thead class="table-dark">
                <tr>
                    <th width="120">Report ID</th>
                    <th>Reported User</th>
                    <th>Reported By</th>
                    <th>Reason</th>
                    <th width="110">Date</th>
                    <th width="120">Status</th>
                    <th width="150">Actions</th>
                </tr>
            </thead>
            <tbody id="reportsTableBody">
                <!-- Data will be loaded via JavaScript -->
            </tbody>
        </table>
        <div id="loadingSpinner" class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading reports...</span>
            </div>
        </div>
        <div id="noReports" class="text-center p-4" style="display: none;">
            <p class="text-muted">No reports found matching your criteria.</p>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let allReports = [];
        let filteredReports = [];

        // Load reports on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAllReports();
            
            // Add event listeners for real-time search
            document.getElementById('searchInput').addEventListener('input', function() {
                if (this.value.length === 0 || this.value.length >= 3) {
                    applyFilters();
                }
            });
            
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('userStatusFilter').addEventListener('change', applyFilters);
        });

        async function loadAllReports() {
            try {
                const response = await fetch('/Suspension/GetAllReports');
                const result = await response.json();

                const loadingSpinner = document.getElementById('loadingSpinner');
                loadingSpinner.style.display = 'none';

                if (result.success && result.reports.length > 0) {
                    allReports = result.reports;
                    applyFilters();
                    updateStats();
                } else {
                    document.getElementById('noReports').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading reports:', error);
                alert('Error loading reports');
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const reportStatusFilter = document.getElementById('statusFilter').value;
            const userStatusFilter = document.getElementById('userStatusFilter').value;
            
            filteredReports = allReports.filter(report => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    report.reportedUserName.toLowerCase().includes(searchTerm) ||
                    report.reportedUserEmail.toLowerCase().includes(searchTerm) ||
                    report.reporterName.toLowerCase().includes(searchTerm) ||
                    report.reportReason.toLowerCase().includes(searchTerm);
                
                // Report status filter
                const matchesReportStatus = reportStatusFilter === 'all' || report.adminDecision === reportStatusFilter;
                
                // User status filter
                const matchesUserStatus = userStatusFilter === 'all' || report.userStatus === userStatusFilter;
                
                return matchesSearch && matchesReportStatus && matchesUserStatus;
            });
            
            renderReportsTable();
            updateStats();
        }

        function renderReportsTable() {
            const tbody = document.getElementById('reportsTableBody');
            const noReports = document.getElementById('noReports');

            if (filteredReports.length > 0) {
                tbody.innerHTML = filteredReports.map(report => `
                    <tr>
                        <td class="fw-bold">#${report.reportId}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        <i class="fas fa-user text-muted"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="fw-semibold">${report.reportedUserName}</div>
                                    <small class="text-muted">${report.reportedUserEmail}</small>
                                    <div class="mt-1">
                                        ${getUserStatusBadge(report.userStatus)}
                                        ${report.previousSuspensions > 0 ? 
                                            `<span class="badge bg-warning ms-1">${report.previousSuspensions} prev</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="fw-medium">${report.reporterName}</div>
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 200px;" title="${report.reportReason}">
                                ${report.reportReason}
                            </div>
                        </td>
                        <td>
                            <small class="text-muted">${new Date(report.createdAt).toLocaleDateString()}</small>
                        </td>
                        <td>
                            ${getReportStatusBadge(report.adminDecision)}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-info" onclick="viewUserHistory(${report.reportedUserId})" title="View History">
                                    <i class="fas fa-history"></i>
                                </button>
                                ${report.adminDecision === 'Pending' ? `
                                    ${report.userStatus === 'Banned' ? `
                                        <button class="btn btn-outline-secondary" disabled title="User Already Banned">
                                            <i class="fas fa-ban"></i> Banned
                                        </button>
                                    ` : `
                                        <button class="btn btn-outline-success" onclick="approveReport(${report.reportId})" title="Approve Report">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="rejectReport(${report.reportId})" title="Reject Report">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    `}
                                ` : `
                                    <span class="text-muted small">Processed</span>
                                `}
                            </div>
                        </td>
                    </tr>
                `).join('');
                noReports.style.display = 'none';
            } else {
                tbody.innerHTML = '';
                noReports.style.display = 'block';
            }
        }

        function updateStats() {
            const totalCount = allReports.length;
            const pendingCount = allReports.filter(r => r.adminDecision === 'Pending').length;
            const approvedCount = allReports.filter(r => r.adminDecision === 'Approved').length;
            const rejectedCount = allReports.filter(r => r.adminDecision === 'Rejected').length;
            const bannedCount = allReports.filter(r => r.userStatus === 'Banned').length;

            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('approvedCount').textContent = approvedCount;
            document.getElementById('rejectedCount').textContent = rejectedCount;
            document.getElementById('bannedCount').textContent = bannedCount;
        }

        function getReportStatusBadge(status) {
            const badges = {
                'Pending': 'bg-warning',
                'Approved': 'bg-success',
                'Rejected': 'bg-danger'
            };
            return `<span class="badge ${badges[status] || 'bg-secondary'}">${status}</span>`;
        }

        function getUserStatusBadge(status) {
            const badges = {
                'Active': 'bg-success',
                'Suspended': 'bg-warning',
                'Banned': 'bg-danger'
            };
            return `<span class="badge ${badges[status] || 'bg-secondary'}">${status}</span>`;
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('userStatusFilter').value = 'all';
            applyFilters();
        }

        async function approveReport(reportId) {
            if (!confirm('Are you sure you want to approve this report? This will apply penalties to the user.')) {
                return;
            }

            try {
                const response = await fetch('/Suspension/ApproveReport', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `reportId=${reportId}`
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    loadAllReports();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error approving report:', error);
                alert('Error approving report');
            }
        }

        async function rejectReport(reportId) {
            const reason = prompt('Please enter reason for rejection (optional):');
            if (reason === null) return; // User cancelled
            
            try {
                const response = await fetch('/Suspension/RejectReport', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `reportId=${reportId}&rejectionReason=${encodeURIComponent(reason || '')}`
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Report rejected successfully');
                    loadAllReports();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error rejecting report:', error);
                alert('Error rejecting report');
            }
        }

        async function viewUserHistory(userId) {
            try {
                const response = await fetch(`/Suspension/GetUserReportHistory?userId=${userId}`);
                const result = await response.json();

                const historyContent = document.getElementById('userHistoryContent');
                
                if (result.success && result.history.length > 0) {
                    historyContent.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Reporter</th>
                                        <th>Reason</th>
                                        <th>Decision</th>
                                        <th>Penalty</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${result.history.map(history => `
                                        <tr>
                                            <td>${new Date(history.createdAt).toLocaleDateString()}</td>
                                            <td>${history.reporterName}</td>
                                            <td>${history.reportReason}</td>
                                            <td>${getReportStatusBadge(history.adminDecision)}</td>
                                            <td>${getPenaltyInfo(history)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    historyContent.innerHTML = '<p class="text-muted">No report history found.</p>';
                }

                new bootstrap.Modal(document.getElementById('userHistoryModal')).show();
            } catch (error) {
                console.error('Error loading user history:', error);
                alert('Error loading user history');
            }
        }

        function getPenaltyInfo(history) {
            if (history.adminDecision !== 'Approved') return '-';
            
            if (history.isBanned) {
                return '<span class="badge bg-danger">BANNED</span>';
            } else if (history.suspensionStart) {
                const endDate = history.suspensionEnd ? new Date(history.suspensionEnd).toLocaleDateString() : 'Permanent';
                return `Suspended until ${endDate}`;
            }
            return '-';
        }
    </script>
}