@model IEnumerable<PicklePlay.Models.ViewModels.EscrowAdminViewModel>

@{
    ViewData["Title"] = "Escrow Management";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";

    // Summary calculations â€” DIRECT FROM SCHEDULE TABLE
    decimal totalHeld = Model
        .Where(x => x.Status == "Held")
        .Sum(x => x.TotalEscrowAmount);

    decimal totalReleased = Model
        .Where(x => x.Status == "Released")
        .Sum(x => x.TotalEscrowAmount);
}

<div class="page-wrapper">
    <div class="page-content">

        <h3 class="mb-4">Escrow Management</h3>

        <!-- ========================= -->
        <!--     SUMMARY DASHBOARD     -->
        <!-- ========================= -->
        <div class="row mb-4">

            <!-- HELD -->
            <div class="col-md-6">
                <div class="card shadow-sm" style="background:#0d6efd; color:white;">
                    <div class="card-body">
                        <h5>Funds in Escrow</h5>
                        <h2>RM @totalHeld</h2>
                        <small>Currently held games</small>
                    </div>
                </div>
            </div>

            <!-- RELEASED -->
            <div class="col-md-6">
                <div class="card shadow-sm" style="background:#198754; color:white;">
                    <div class="card-body">
                        <h5>Released</h5>
                        <h2>RM @totalReleased</h2>
                        <small>Funds successfully paid out</small>
                    </div>
                </div>
            </div>

        </div>

        <!-- ========================= -->
        <!--       ESCROW TABLE        -->
        <!-- ========================= -->

        <div class="card shadow-sm">
            <div class="card-body">

                <table class="table table-bordered table-striped align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Game ID</th>
                            <th>Game Title</th>
                            <th>Host</th>
                            <th>Players</th>
                            <th>Total Escrow Amount</th>
                            <th>Status</th>
                            <th>Game End Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var e in Model)
                        {
                            <tr>
                                <td>@e.ScheduleId</td>
                                <td>@e.GameTitle</td>
                                <td>@e.HostName</td>
                                <td>@e.PlayerCount player(s)</td>

                                <!-- DIRECTLY FROM SCHEDULE -->
                                <td>RM @e.TotalEscrowAmount</td>

                                <td>
                                    @if (e.Status == "Held")
                                    {
                                        <span class="badge bg-primary">Held</span>
                                    }
                                    else if (e.Status == "Released")
                                    {
                                        <span class="badge bg-success">Released</span>
                                    }
                                    else if (e.Status == "Refunded")
                                    {
                                        <span class="badge bg-info">Refunded</span>
                                    }
                                </td>

                                <td>@e.GameEndTime?.ToString("yyyy-MM-dd HH:mm")</td>

                                <td>
                                    @if (e.Status == "Held")
                                    {
                                        <button class="btn btn-success btn-sm" onclick="releaseEscrow(@e.ScheduleId)">Release</button>
                                        <button class="btn btn-danger btn-sm" onclick="refundEscrow(@e.ScheduleId)">Refund</button>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>

                </table>
            </div>
        </div>

    </div>
</div>


@section Scripts {
<script>
    function releaseEscrow(id) {
        if (!confirm("Release escrow funds for this schedule?")) return;

        fetch(`/EscrowAdmin/ReleaseEscrow?scheduleId=${id}`, { method: "POST" })
            .then(r => r.json())
            .then(d => {
                alert(d.message);
                location.reload();
            });
    }

    function refundEscrow(id) {
        if (!confirm("Refund all players for this schedule?")) return;

        fetch(`/EscrowAdmin/RefundEscrow?scheduleId=${id}`, { method: "POST" })
            .then(r => r.json())
            .then(d => {
                alert(d.message);
                location.reload();
            });
    }
</script>
}
