@model PicklePlay.ViewModels.TransactionLogMainViewModel
@{
    ViewData["Title"] = "Transaction Log";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<style>
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }

    .table th {
        border-top: none;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge {
        font-size: 0.75rem;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.025);
    }

    .transaction-amount {
        font-weight: 600;
    }

    .transaction-amount.positive {
        color: #198754;
    }

    .transaction-amount.negative {
        color: #dc3545;
    }

    .export-btn {
        position: relative;
    }

    .export-btn.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>

<div class="p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-file-invoice-dollar me-2"></i>Transaction Log</h2>
        <div>
            <button id="exportBtn" class="btn btn-success export-btn">
                <i class="fas fa-download me-1"></i>Export CSV
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Transactions</h6>
                            <h3>@Model.Summary.TotalTransactions</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exchange-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Amount</h6>
                            <h3>RM @Model.Summary.TotalAmount.ToString("N2")</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-money-bill-wave fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Successful</h6>
                            <h3>@Model.Summary.SuccessfulTransactions</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Pending</h6>
                            <h3>@Model.Summary.PendingTransactions</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0"><i class="fas fa-filter me-2"></i>Filters</h5>
        </div>
        <div class="card-body">
            <form id="filterForm" method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" name="startDate"
                        value="@Model.Filter.StartDate">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" name="endDate" value="@Model.Filter.EndDate">
                </div>
                <div class="col-md-2">
                    <label for="transactionType" class="form-label">Transaction Type</label>
                    <select class="form-select" id="transactionType" name="transactionType">
                        <option value="All">All Types</option>
                        <option value="TopUp" selected="@(Model.Filter.TransactionType == "TopUp")">Top Up</option>
                        <option value="Withdraw" selected="@(Model.Filter.TransactionType == "Withdraw")">Withdraw
                        </option>

                        <option value="Escrow_Hold" selected="@(Model.Filter.TransactionType == "Escrow_Hold")">Escrow
                            Hold</option>
                        <option value="Escrow_Released" selected="@(Model.Filter.TransactionType == "Escrow_Released")">
                            Escrow Released</option>
                        <option value="Escrow_Receive" selected="@(Model.Filter.TransactionType == "Escrow_Receive")">
                            Escrow Received</option>
                        <option value="Escrow_Refund" selected="@(Model.Filter.TransactionType == "Escrow_Refund")">
                            Refund Approved</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="paymentStatus" class="form-label">Payment Status</label>
                    <select class="form-select" id="paymentStatus" name="paymentStatus">
                        <option value="All">All Status</option>
                        <option value="Pending" selected="@(Model.Filter.PaymentStatus == "Pending")">Pending</option>
                        <option value="Completed" selected="@(Model.Filter.PaymentStatus == "Completed")">Completed
                        </option>
                        <option value="Failed" selected="@(Model.Filter.PaymentStatus == "Failed")">Failed</option>
                        <option value="Cancelled" selected="@(Model.Filter.PaymentStatus == "Cancelled")">Cancelled
                        </option>
                        <option value="Refunded" selected="@(Model.Filter.PaymentStatus == "Refunded")">Refunded
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="paymentMethod" class="form-label">Payment Method</label>
                    <select class="form-select" id="paymentMethod" name="paymentMethod">
                        <option value="All">All Methods</option>
                        <option value="Wallet" selected="@(Model.Filter.PaymentMethod == "Wallet")">Wallet</option>
                        <option value="CreditCard" selected="@(Model.Filter.PaymentMethod == "CreditCard")">Credit Card
                        </option>
                        <option value="PayPal" selected="@(Model.Filter.PaymentMethod == "PayPal")">PayPal</option>
                        <option value="BankTransfer" selected="@(Model.Filter.PaymentMethod == "BankTransfer")">Bank
                            Transfer</option>
                    </select>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search me-1"></i>Apply Filters
                    </button>
                    <button type="button" id="resetFilters" class="btn btn-outline-secondary">
                        <i class="fas fa-undo me-1"></i>Reset
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>Transactions</h5>
        </div>
        <div class="card-body">
            @if (Model.Transactions.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var transaction in Model.Transactions)
                            {
                                var amountClass = transaction.Amount >= 0 ? "positive" : "negative";
                                var statusClass = transaction.PaymentStatus switch
                                {
                                    "Completed" => "bg-success",
                                    "Pending" => "bg-warning",
                                    "Failed" => "bg-danger",
                                    "Cancelled" => "bg-secondary",
                                    "Refunded" => "bg-info",
                                    _ => "bg-secondary"
                                };

                                <tr>
                                    <td>@transaction.TransactionId</td>
                                    <td>
                                        <div class="fw-medium">@transaction.Username</div>
                                        <small class="text-muted">@transaction.Email</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">@transaction.TransactionType</span>
                                        @if (transaction.IsEscrowRelated)
                                        {
                                            <br />
                                
                                            <small class="text-muted"><i class="fas fa-lock"></i> Escrow</small>
                                        }
                                    </td>
                                    <td>
                                        <span class="transaction-amount @amountClass">
                                            @if (transaction.Amount >= 0)
                                            {
                                                <text>+RM @transaction.Amount.ToString("N2")</text>
                                            }
                                            else
                                            {
                                                <text>RM @transaction.Amount.ToString("N2")</text>
                                            }
                                        </span>
                                    </td>
                                    <td>@transaction.PaymentMethod</td>
                                    <td>
                                        <span class="badge @statusClass">@transaction.PaymentStatus</span>
                                        @if (transaction.PaymentStatus == "Pending" && transaction.CreatedAt <
                                                                        DateTime.UtcNow.AddHours(-24))
                                        {
                                            <br />
                                
                                            <small class="text-warning"><i class="fas fa-clock"></i> Stalled</small>
                                        }
                                    </td>
                                    <td>
                                        <div class="fw-medium">@transaction.CreatedAt.ToString("MMM dd, yyyy")</div>
                                        <small class="text-muted">@transaction.CreatedAt.ToString("HH:mm")</small>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary view-details-btn"
                                            data-transaction-id="@transaction.TransactionId" title="View Details">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5>No transactions found</h5>
                    <p class="text-muted">Try adjusting your filters to see more results.</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Include the shared modal -->
<partial name="_TransactionDetailsModal" />

@section Scripts {
    <script>
        // Use vanilla JavaScript instead of jQuery
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded - initializing event listeners');

            // Reset filters
            var resetBtn = document.getElementById('resetFilters');
            if (resetBtn) {
                resetBtn.addEventListener('click', function () {
                    document.getElementById('filterForm').reset();
                    document.getElementById('filterForm').submit();
                });
            }

            // Export functionality with loading state
            var exportBtn = document.getElementById('exportBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', function () {
                    var btn = this;
                    var originalText = btn.innerHTML;

                    // Show loading state
                    btn.classList.add('loading');
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exporting...';

                    // Get current filter parameters
                    var params = new URLSearchParams(window.location.search);

                    // Create download link
                    var downloadUrl = '/Admin/ExportTransactions?' + params.toString();
                    window.location.href = downloadUrl;

                    // Restore button state after a short delay
                    setTimeout(function () {
                        btn.classList.remove('loading');
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }, 2000);
                });
            }

            // View transaction details - Open modal
            var viewButtons = document.querySelectorAll('.view-details-btn');
            console.log('Found view buttons:', viewButtons.length);

            viewButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    var transactionId = this.getAttribute('data-transaction-id');
                    console.log('View button clicked, transaction ID:', transactionId);
                    loadTransactionDetails(transactionId);
                });
            });
        });

        // Function to load transaction details into modal
        function loadTransactionDetails(transactionId) {
            console.log('loadTransactionDetails called with ID:', transactionId);

            var modal = document.getElementById('transactionDetailsModal');
            var content = document.getElementById('transactionDetailsContent');

            if (!modal) {
                console.error('Modal element not found!');
                return;
            }

            if (!content) {
                console.error('Modal content element not found!');
                return;
            }

            // Show loading state
            content.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading transaction details...</p>
                    </div>
                `;

            // Show modal using Bootstrap
            try {
                var bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                console.log('Bootstrap modal shown');
            } catch (error) {
                console.error('Error showing modal:', error);
                // Fallback: show modal directly
                modal.style.display = 'block';
                modal.classList.add('show');
            }

            // Load transaction details via AJAX using fetch API
            var apiUrl = '/Admin/GetTransactionDetails?id=' + transactionId;
            console.log('Making API call to:', apiUrl);

            fetch(apiUrl)
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response OK:', response.ok);
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                    return response.json();
                })
                .then(response => {
                    console.log('Full API response:', response);

                    if (response.success && response.data) {
                        var data = response.data;
                        console.log('Transaction data received:', data);

                        // Use camelCase properties (as shown in your console output)
                        var statusClass = getStatusClass(data.paymentStatus);
                        var amountClass = parseFloat(data.amount) >= 0 ? 'positive' : 'negative';
                        var amountSign = parseFloat(data.amount) >= 0 ? '+' : '';

                        var contentHTML = `
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="border-bottom pb-2 mb-3">Transaction Information</h6>
                                        <table class="table table-sm table-borderless">
                                            <tr>
                                                <td class="fw-bold" style="width: 140px;">Transaction ID:</td>
                                                <td>#${data.transactionId || 'N/A'}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">Type:</td>
                                                <td><span class="badge bg-info">${data.transactionType || 'N/A'}</span></td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">Amount:</td>
                                                <td class="fw-bold ${amountClass}">${amountSign}RM ${data.amount ? parseFloat(data.amount).toFixed(2) : '0.00'}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">Status:</td>
                                                <td><span class="badge ${statusClass}">${data.paymentStatus || 'N/A'}</span></td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">Created:</td>
                                                <td>${data.createdAt || 'N/A'}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">Completed:</td>
                                                <td>${data.paymentCompletedAt || 'N/A'}</td>
                                            </tr>
                                            ${data.escrowId ? `
                                            <tr>
                                                <td class="fw-bold">Escrow ID:</td>
                                                <td>#${data.escrowId}</td>
                                            </tr>` : ''}
                                        </table>
                                    </div>
                                
                                    <div class="col-md-6">
                                        <h6 class="border-bottom pb-2 mb-3">User Information</h6>
                                        <table class="table table-sm table-borderless">
                                            <tr>
                                                <td class="fw-bold" style="width: 140px;">User ID:</td>
                                                <td>#${data.userId || 'N/A'}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">Username:</td>
                                                <td>${data.username || 'N/A'}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">Email:</td>
                                                <td>${data.email || 'N/A'}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">Wallet ID:</td>
                                                <td>#${data.walletId || 'N/A'}</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h6 class="border-bottom pb-2 mb-3">Payment Details</h6>
                                        <table class="table table-sm table-borderless">
                                            <tr>
                                                <td class="fw-bold" style="width: 140px;">Payment Method:</td>
                                                <td>${data.paymentMethod || 'N/A'}</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">Gateway ID:</td>
                                                <td>${data.paymentGatewayId || 'N/A'}</td>
                                            </tr>
                                            ${data.cardLastFour ? `
                                            <tr>
                                                <td class="fw-bold">Card Last 4:</td>
                                                <td>**** ${data.cardLastFour}</td>
                                            </tr>` : ''}
                                        </table>
                                    </div>
                                </div>
                            `;

                        content.innerHTML = contentHTML;
                        console.log('Modal content updated successfully');
                    } else {
                        console.log('API returned error:', response.message);
                        content.innerHTML = `
                                <div class="alert alert-danger text-center">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Error loading transaction details: ${response.message || 'Unknown error'}
                                    <br><small>Response: ${JSON.stringify(response)}</small>
                                </div>
                            `;
                    }
                })
                .catch(error => {
                    console.log('Fetch error:', error);
                    content.innerHTML = `
                            <div class="alert alert-danger text-center">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Failed to load transaction details. Please try again.
                                <br><small>Error: ${error.message}</small>
                                <br><small>Check browser console for details</small>
                            </div>
                        `;
                });
        }

        // Helper function to get status badge class
        function getStatusClass(status) {
            if (!status) return 'bg-secondary';

            switch (status) {
                case 'Completed': return 'bg-success';
                case 'Pending': return 'bg-warning';
                case 'Failed': return 'bg-danger';
                case 'Cancelled': return 'bg-secondary';
                case 'Refunded': return 'bg-info';
                default: return 'bg-secondary';
            }
        }
    </script>
}