@model PicklePlay.ViewModels.AdminDashboardViewModel
@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<h2>Admin Dashboard</h2>
<p class="text-muted">Real-time overview of the system.</p>

<!-- Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm text-center h-100">
            <div class="card-body d-flex flex-column justify-content-center align-items-center">
                <h5>Total Users</h5>
                <h3 class="text-primary mb-0">@Model.TotalUsers.ToString("N0")</h3>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm text-center h-100">
            <div class="card-body d-flex flex-column justify-content-center align-items-center">
                <h5>Active Communities</h5>
                <h3 class="text-success mb-0">@Model.ActiveCommunities.ToString("N0")</h3>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm text-center h-100">
            <div class="card-body d-flex flex-column justify-content-center align-items-center">
                <h5>Pending Requests</h5>
                <h3 class="text-danger">@Model.TotalPendingRequests.ToString("N0")</h3>
                <small class="text-muted mt-2">
                    Communities: @Model.PendingCommunityRequestsCount | 
                    Disputes: @Model.PendingEscrowDisputesCount | 
                    Refunds: @Model.PendingRefundRequestsCount | 
                    Suspensions: @Model.PendingSuspensionRequestsCount
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Chart + Recent Activity -->
<div class="row g-3">
    <!-- Chart -->
    <div class="col-md-7">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5>User Growth (Last 6 Months)</h5>
                <canvas id="userChart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="col-md-5">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Recent Activity</h5>
                    <small class="text-muted">Last 7 days</small>
                </div>
                <div class="activity-feed">
                    @if (Model.RecentActivities.Any())
                    {
                        foreach (var activity in Model.RecentActivities)
                        {
                            <div class="activity-item mb-3 p-2 border-start border-3 
                                @(activity.Type.Contains("Dispute") ? "border-danger" : 
                                  activity.Type.Contains("Refund") ? "border-info" : 
                                  activity.Type.Contains("Community") ? "border-warning" : "border-secondary")">
                                <div class="d-flex justify-content-between">
                                    <small class="fw-bold">@activity.Type</small>
                                    <small class="text-muted">@activity.CreatedAt.ToString("MMM dd HH:mm")</small>
                                </div>
                                <small>@activity.Description</small>
                                <div class="d-flex justify-content-between mt-1">
                                    <small class="text-muted">@activity.Username</small>
                                    <span class="badge 
                                        @(activity.Status == "Pending" ? "bg-warning" : 
                                          activity.Status == "Approved" ? "bg-success" : "bg-secondary")">
                                        @activity.Status
                                    </span>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            <small>No recent activity</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Chart.js with single dataset (New Users) and custom tooltip for total users
        const ctx = document.getElementById('userChart');
        
        // Prepare data for chart
        const months = [@Html.Raw(string.Join(", ", Model.MonthlyUserGrowth.Select(m => $"'{m.Month}'")))];
        const newUsers = [@string.Join(", ", Model.MonthlyUserGrowth.Select(m => m.NewUsers))];
        const totalUsers = {
            @foreach (var item in Model.MonthlyTotalUsers)
            {
                @:'@item.Key': @item.Value,
            }
        };

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'New Users',
                    data: newUsers,
                    borderColor: '#A1D336',
                    backgroundColor: 'rgba(161, 211, 54, 0.3)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            afterLabel: function(context) {
                                const month = months[context.dataIndex];
                                const total = totalUsers[month] || 0;
                                return `Total Users: ${total.toLocaleString()}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Auto-refresh dashboard every 2 minutes
        setInterval(() => {
            window.location.reload();
        }, 120000);
    </script>

    <style>
        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }
        .activity-item {
            background-color: #f8f9fa;
            border-radius: 0.25rem;
        }
    </style>
}