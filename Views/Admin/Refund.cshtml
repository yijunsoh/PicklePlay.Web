@model IEnumerable<PicklePlay.Models.RefundRequest>

@{
    ViewData["Title"] = "Refund Requests";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";

    var myt = TimeZoneInfo.FindSystemTimeZoneById("Singapore Standard Time");
}

<div class="page-wrapper">
    <div class="page-content">

        <h3 class="mb-4">Refund Request Management</h3>

        <div class="card shadow-sm">
            <div class="card-body">
                <table class="table table-bordered table-striped align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Schedule</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Admin Note</th>
                            <th>Action</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var d in Model)
                        {
                            <tr id="row-@d.RefundId">
                                <td>@d.RefundId</td>

                                <!-- USER (ReportedBy + Username) -->
                                <td>
                                    <strong>@d.User?.Username</strong><br />
                                    <small>User ID: @d.UserId</small>
                                </td>

                                <!-- Schedule -->
                                <td>#@d.Escrow?.ScheduleId</td>

                                <!-- Refund Reason -->
                                <td>@d.RefundReason</td>

                                <!-- Status -->
                                <td>
                                    @if (d.AdminDecision == "Pending")
                                    {
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    }
                                    else if (d.AdminDecision == "Approved")
                                    {
                                        <span class="badge bg-success">Approved</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Rejected</span>
                                    }
                                </td>

                                <!-- Created At (MYT) -->
                                <td>
                                    @TimeZoneInfo.ConvertTimeFromUtc(
                                    d.CreatedAt.ToUniversalTime(),
                                                                TimeZoneInfo.FindSystemTimeZoneById("Singapore Standard Time")
                                                                ).ToString("yyyy-MM-dd HH:mm")
                            </td>

                                <!-- Admin Note -->
                                <td>
                                @if (string.IsNullOrEmpty(d.AdminNote))
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                    else
                                    {
                                        @d.AdminNote
                                    }
                                </td>

                                <!-- ACTION -->
                                <td>
                                    @if (d.AdminDecision == "Pending")
                                    {
                                        <div class="btn-group">
                                            <button class="btn btn-success btn-sm"
                                                onclick="approveRefund(@d.RefundId)">Approve</button>
                                            <button class="btn btn-danger btn-sm"
                                                onclick="openRejectModal(@d.RefundId)">Reject</button>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Completed</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>

                </table>
            </div>
        </div>

    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Reject Refund Request</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <textarea id="rejectNote" class="form-control" rows="4" placeholder="Enter rejection reason"></textarea>
                <input type="hidden" id="rejectRefundId" />
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-danger" onclick="submitReject()">Submit</button>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>

        function approveRefund(id) {
            if (!confirm("Approve refund?")) return;

            fetch(`/EscrowAdmin/ApproveRefund?refundId=${id}`, { method: "POST" })
                .then(r => r.json())
                .then(d => {
                    alert(d.message);
                    location.reload();
                });
        }

        function openRejectModal(id) {
            document.getElementById("rejectRefundId").value = id;
            new bootstrap.Modal(document.getElementById("rejectModal")).show();
        }

        function submitReject() {
            let id = document.getElementById("rejectRefundId").value;
            let note = document.getElementById("rejectNote").value;

            if (!note.trim()) {
                alert("Enter reason.");
                return;
            }

            fetch("/EscrowAdmin/RejectRefund", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `refundId=${id}&adminNote=${encodeURIComponent(note)}`
            })
                .then(r => r.json())
                .then(d => {
                    alert(d.message);
                    location.reload();
                });
        }

    </script>
}